<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insights de Vendas — Relatório do Representante</title>

  <!-- Inter (bem próximo do Streamlit) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js (para barras/pies com visual consistente) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Leaflet 1.9.4 (mesma versão que você força no Streamlit) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f8fafc;          /* fundo claro (Streamlit-like) */
      --card:#ffffff;
      --text:#0f172a;
      --muted: rgba(15,23,42,.62);
      --border: rgba(15,23,42,.12);

      --blue:#38bdf8;   /* Altair bar */
      --green:#22c55e;  /* Altair line / good */
      --yellow:#eab308;
      --orange:#f97316;
      --red:#ef4444;
      --slate:#94a3b8;

      --shadow: 0 1px 2px rgba(15,23,42,.06);
      --radius: 12px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      color:var(--text);
      background:var(--bg);
      font-size:14px;
      line-height:1.45;
    }

    /* Layout container (bem similar ao "wide") */
    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px 18px 50px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 10px;
    }

    h1{ margin:0 0 4px; font-size:28px; font-weight:800; letter-spacing:-0.02em; }
    .sub{ color:var(--muted); font-size:12.5px; margin-top:6px; }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    select, button{
      font-family: inherit;
      font-size: 13px;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      outline: none;
      box-shadow: var(--shadow);
    }
    button{ cursor:pointer; font-weight:700; }
    button:active{ transform: translateY(1px); }

    .divider{ height:1px; background: var(--border); margin: 14px 0 18px; }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
    }

    /* KPI grid 5 cols (como st.columns(5)) */
    .kpis{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:16px;
    }

    .metric-title{
      font-size:13px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 600;
    }
    .metric-value{
      font-size:34px;
      font-weight:800;
      letter-spacing:-0.02em;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .metric-sub{
      margin-top: 8px;
      font-size:12.5px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Section titles */
    .section{
      margin-top: 18px;
    }
    .section-title{
      font-size:18px;
      font-weight:800;
      margin: 0 0 10px;
    }
    .section-caption{
      font-size:13px;
      color: var(--muted);
      margin:2px 0 12px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }

    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:16px;
    }

    .row{
      display:flex;
      gap:16px;
      align-items:stretch;
    }

    /* Chart containers */
    .chartBox{
      width:100%;
      height: 320px;
    }
    canvas{ width:100% !important; height:100% !important; }

    /* Tables */
    table{
      width:100%;
      border-collapse: collapse;
    }
    th, td{
      text-align:left;
      padding: 6px 8px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      font-size: 12.8px;
      white-space: nowrap;
    }
    th{ font-weight:800; color: rgba(15,23,42,.75); }
    td{ color: rgba(15,23,42,.90); }
    .td-right{ text-align:right; }

    /* Badges (apenas onde faz sentido — NÃO no topo) */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      font-weight: 800;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(148,163,184,.12);
      color: rgba(15,23,42,.85);
    }

    /* Map */
    #map{
      width:100%;
      height: 620px;
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .legend{
      margin-top:10px;
      font-size:12.5px;
      color: rgba(15,23,42,.80);
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:8px;
      margin: 4px 0;
    }
    .swatch{
      width:12px;
      height:12px;
      border-radius: 2px;
      border: 1px solid rgba(15,23,42,.15);
    }

    /* Print */
    @page { size: A4 portrait; margin: 1.5cm; }
    @media print{
      .controls, .no-print{ display:none !important; }
      body{ background:#fff; }
      .card{ box-shadow:none; }
      .page-break{ break-before: page; page-break-before: always; }
      .wrap{ max-width: none; padding:0; }
      #map{ height: 520px; }
    }

    /* Responsivo */
    @media (max-width: 1180px){
      .kpis{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .grid2{ grid-template-columns: 1fr; }
      .grid3{ grid-template-columns: 1fr; }
      .topbar{ flex-direction:column; align-items:stretch; }
      .controls{ justify-content:flex-start; }
      #map{ height: 520px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Insights de Vendas</h1>
        <div class="sub" id="subtitleLine"></div>
      </div>

      <div class="controls no-print">
        <select id="repSelect" aria-label="Representante"></select>
        <button id="btnPrint" type="button">Imprimir</button>
      </div>
    </div>

    <div class="divider"></div>

    <!-- KPIs -->
    <div class="kpis" id="kpiGrid"></div>

    <!-- 1) Destaques do período -->
    <div class="section">
      <div class="section-title">Destaques do período</div>
      <div class="grid2">
        <div class="card" id="highlightsFat"></div>
        <div class="card" id="highlightsVol"></div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- 2) Evolução – Faturamento e Volume (comparativo) -->
    <div class="section">
      <div class="section-title">Evolução – Faturamento e Volume (comparativo)</div>
      <div class="section-caption">
        Dois gráficos em barras para comparar o período atual vs. período anterior.
      </div>
      <div class="grid2">
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Faturamento (R$)</div>
          <div class="chartBox"><canvas id="chartFat"></canvas></div>
        </div>
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Volume (un)</div>
          <div class="chartBox"><canvas id="chartVol"></canvas></div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- 3) Categorias vendidas -->
    <div class="section">
      <div class="section-title">Categorias vendidas</div>
      <div class="section-caption">
        Período atual (detalhado) + Período anterior (snapshot: Categoria, Valor, %).
      </div>

      <div class="grid2">
        <!-- Atual -->
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div style="font-weight:800;">Período atual</div>
            <div class="sub" id="catCaptionCurr"></div>
          </div>
          <div class="grid2" style="margin-top:10px;">
            <div>
              <div class="chartBox" style="height:360px;"><canvas id="pieCatCurr"></canvas></div>
            </div>
            <div>
              <div style="font-weight:800; margin-bottom:6px;">Resumo (com Valor Anterior)</div>
              <div style="overflow:auto; max-height: 360px;">
                <table id="tblCatCurr"></table>
              </div>
            </div>
          </div>
        </div>

        <!-- Anterior snapshot -->
        <div class="card">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div style="font-weight:800;">Período anterior</div>
            <div class="sub" id="catCaptionPrev"></div>
          </div>
          <div class="grid2" style="margin-top:10px;">
            <div>
              <div class="chartBox" style="height:360px;"><canvas id="pieCatPrev"></canvas></div>
            </div>
            <div>
              <div style="font-weight:800; margin-bottom:6px;">Resumo (snapshot)</div>
              <div style="overflow:auto; max-height: 360px;">
                <table id="tblCatPrev"></table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- 4) Mapa de Clientes -->
    <div class="section">
      <div class="section-title">Mapa de Clientes</div>
      <div class="section-caption">
        Mapa por <b>Volume</b> (padrão). Sem alternância para faturamento.
      </div>

      <div class="grid2">
        <div class="card">
          <div id="map"></div>
          <div class="legend" id="mapLegend"></div>
        </div>

        <div class="card">
          <div style="font-weight:800; margin-bottom:10px;">Cobertura</div>
          <div class="grid3">
            <div class="card" style="padding:12px;">
              <div class="metric-title">Cidades atendidas</div>
              <div class="metric-value" style="font-size:24px;" id="covCities">0</div>
            </div>
            <div class="card" style="padding:12px;">
              <div class="metric-title">Estados atendidos</div>
              <div class="metric-value" style="font-size:24px;" id="covStates">0</div>
            </div>
            <div class="card" style="padding:12px;">
              <div class="metric-title">Clientes atendidos</div>
              <div class="metric-value" style="font-size:24px;" id="covClients">0</div>
            </div>
          </div>

          <div style="font-weight:800; margin:14px 0 8px;">Principais clientes</div>
          <div style="overflow:auto; max-height: 520px;">
            <table id="tblTopClients"></table>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- 5) Distribuição por clientes -->
    <div class="section">
      <div class="section-title">Distribuição por clientes</div>

      <div class="card" style="margin-bottom:16px;">
        <div class="grid3">
          <div>
            <div style="font-weight:800; margin-bottom:6px;">N80</div>
            <div id="badgeN80"></div>
            <div class="sub" style="margin-top:8px;">
              Quantos clientes são necessários para atingir 80% do faturamento.
            </div>
          </div>
          <div>
            <div style="font-weight:800; margin-bottom:6px;">Índice de concentração (HHI)</div>
            <div id="badgeHHI"></div>
            <div class="sub" style="margin-top:8px;">
              Baixa / Moderada / Alta concentração.
            </div>
          </div>
          <div>
            <div style="font-weight:800; margin-bottom:6px;">Top clientes</div>
            <div class="sub" id="topSharesLine"></div>
          </div>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Participação dos clientes (Top 10 destacados)</div>
          <div class="chartBox" style="height:420px;"><canvas id="pieClients"></canvas></div>
        </div>
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Resumo (Top 15)</div>
          <div style="overflow:auto; max-height: 420px;">
            <table id="tblClientsTop"></table>
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- 6) Saúde da carteira – Detalhes -->
    <div class="section">
      <div class="section-title">Saúde da carteira – Detalhes</div>
      <div class="grid2">
        <div class="card">
          <div style="font-weight:800; margin-bottom:6px;">Pontuação</div>
          <div id="badgeCarteira"></div>
          <div class="sub" style="margin-top:10px;">
            A pontuação reflete o comparativo entre período atual e anterior (manual) por status.
          </div>
        </div>
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Resumo por status</div>
          <div style="overflow:auto; max-height: 320px;">
            <table id="tblStatusResumo"></table>
          </div>
        </div>
      </div>
    </div>

    <div class="page-break"></div>

    <!-- 7) Status dos clientes -->
    <div class="section">
      <div class="section-title">Status dos clientes</div>
      <div class="section-caption">Ordenado por Novos, Crescendo, Estáveis, Caindo, Perdidos.</div>

      <div class="card no-print" style="margin-bottom: 12px;">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <div style="font-weight:800;">Buscar cliente</div>
          <input id="clientSearch" type="text" placeholder="Digite parte do nome do cliente"
                 style="flex:1; min-width: 260px; padding:10px; border-radius:10px; border:1px solid var(--border); outline:none;">
        </div>
      </div>

      <div id="statusTables"></div>
    </div>

  </div>

  <script>
    // ===== Defaults =====
    Chart.defaults.font.family = "Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial";
    Chart.defaults.color = "rgba(15,23,42,.85)";

    const STATUS_ORDER = ["Novos", "Crescendo", "Estáveis", "Caindo", "Perdidos"];

    // ===== Helpers =====
    const fmtBRL = (v) => {
      v = Number(v || 0);
      return "R$ " + v.toLocaleString("pt-BR", {minimumFractionDigits: 2, maximumFractionDigits: 2});
    };
    const fmtBRLCompact = (v) => {
      v = Number(v || 0);
      const av = Math.abs(v);
      if (av >= 1e9) return "R$ " + (v/1e9).toLocaleString("pt-BR",{maximumFractionDigits:1}) + " bi";
      if (av >= 1e6) return "R$ " + (v/1e6).toLocaleString("pt-BR",{maximumFractionDigits:1}) + " mi";
      if (av >= 1e3) return "R$ " + (v/1e3).toLocaleString("pt-BR",{maximumFractionDigits:1}) + " mil";
      return fmtBRL(v);
    };
    const fmtUN = (v) => {
      v = Math.round(Number(v || 0));
      return v.toLocaleString("pt-BR") + " un";
    };
    const fmtPct = (v) => {
      v = Number(v || 0);
      return (v*100).toLocaleString("pt-BR", {maximumFractionDigits:1}) + "%";
    };

    const badgeHTML = (text, colorHex) => {
      const bg = hexToRgba(colorHex, 0.12);
      return `<span class="badge" style="background:${bg}; border-color:${hexToRgba(colorHex,0.28)}; color:${hexToRgba(colorHex,0.95)}">${escapeHtml(text)}</span>`;
    };

    const escapeHtml = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));

    const hexToRgba = (hex, a) => {
      const h = hex.replace("#","").trim();
      const r = parseInt(h.substring(0,2),16);
      const g = parseInt(h.substring(2,4),16);
      const b = parseInt(h.substring(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    };

    // Color rules (igual ao que você pediu: “não ficar sempre verde”)
    const colorForN80Ratio = (ratio) => {
      // ratio = N80 / clientes_atendidos (quanto menor, mais concentrado -> pior)
      // Exemplo de thresholds: ajuste se quiser.
      if (ratio <= 0.10) return "#ef4444"; // muito concentrado
      if (ratio <= 0.18) return "#f97316";
      if (ratio <= 0.26) return "#eab308";
      return "#22c55e"; // mais distribuído
    };

    const colorForHHI = (hhi) => {
      // hhi: baixa <0.10, moderada <0.20, alta >=0.20
      if (hhi >= 0.20) return "#ef4444";
      if (hhi >= 0.10) return "#eab308";
      return "#22c55e";
    };

    const colorForCarteiraScore = (score) => {
      // score 0-100
      if (score < 30) return "#ef4444";
      if (score < 50) return "#f97316";
      if (score < 70) return "#eab308";
      return "#22c55e";
    };

    // Map bins (mesmas cores do Streamlit)
    const MAP_BIN_COLORS = ["#22c55e", "#eab308", "#f97316", "#ef4444"];

    const buildDynamicBins = (values, isMoney) => {
      const cleaned = values.map(v => Number(v)).filter(v => Number.isFinite(v) && v >= 0).sort((a,b)=>a-b);
      const fmt = (v) => isMoney ? ("R$ " + Math.round(v).toLocaleString("pt-BR")) : (Math.round(v).toLocaleString("pt-BR") + " un");
      if (!cleaned.length){
        return isMoney ? [
          {min:1_000_000,color:MAP_BIN_COLORS[0],label:"R$ 1.000.000+"},
          {min:500_000,color:MAP_BIN_COLORS[1],label:"R$ 500.000 - 999.999"},
          {min:250_000,color:MAP_BIN_COLORS[2],label:"R$ 250.000 - 499.999"},
          {min:0,color:MAP_BIN_COLORS[3],label:"R$ 0 - 249.999"},
        ] : [
          {min:10_000,color:MAP_BIN_COLORS[0],label:"10.000 un+"},
          {min:5_000,color:MAP_BIN_COLORS[1],label:"5.000 - 9.999 un"},
          {min:2_500,color:MAP_BIN_COLORS[2],label:"2.500 - 4.999 un"},
          {min:0,color:MAP_BIN_COLORS[3],label:"0 - 2.499 un"},
        ];
      }
      const n = cleaned.length;
      const minVal = cleaned[0], maxVal = cleaned[n-1];
      if (minVal === maxVal){
        const label = fmt(minVal);
        return [
          {min:minVal,color:MAP_BIN_COLORS[0],label:label},
          {min:minVal,color:MAP_BIN_COLORS[0],label:label},
          {min:minVal,color:MAP_BIN_COLORS[0],label:label},
          {min:0,color:MAP_BIN_COLORS[0],label:label},
        ];
      }
      const idx = (p)=> Math.floor(p*(n-1));
      const q1 = cleaned[idx(0.25)];
      const q2 = cleaned[idx(0.50)];
      const q3 = cleaned[idx(0.75)];

      const t0 = Math.max(0, minVal);
      const t1 = Math.max(t0, q1);
      const t2 = Math.max(t1, q2);
      const t3 = Math.max(t2, q3);

      return [
        {min:t3,color:MAP_BIN_COLORS[0],label:`${fmt(t3)}+`},
        {min:t2,color:MAP_BIN_COLORS[1],label:`${fmt(t2)} - ${fmt(t3)}`},
        {min:t1,color:MAP_BIN_COLORS[2],label:`${fmt(t1)} - ${fmt(t2)}`},
        {min:t0,color:MAP_BIN_COLORS[3],label:`${fmt(t0)} - ${fmt(t1)}`},
      ];
    };

    const getBin = (v, bins) => {
      for (const b of bins){
        if (Number(v) >= b.min) return b;
      }
      return bins[bins.length-1];
    };

    // ===== Charts holders =====
    let chartFat, chartVol, pieCatCurr, pieCatPrev, pieClients;
    let leafletMap, leafletLayerGroup;

    // ===== Data loading =====
    // Opção 1: embutir dados no próprio HTML (window.REPORTS = {...})
    // Opção 2: colocar um JSON ao lado do HTML (./rep_reports.json) e carregar via fetch.
    //
    // Estrutura esperada do JSON:
    // {
    //   "meta": { "currentLabel":"JAN 25 - DEZ 25", "previousLabel":"JAN 24 - DEZ 24" },
    //   "reps": [
    //     {
    //       "rep":"NOME DO REP",
    //       "kpis": { "fat":123, "vol":456, "clientes":100, "cidades":50, "estados":10,
    //                 "n80":35, "n80Ratio":0.18, "hhi":0.145, "hhiLabel":"Moderada",
    //                 "top1":0.12, "top3":0.29, "top10":0.55,
    //                 "carteiraScore":62, "carteiraLabel":"Neutra"
    //       },
    //       "highlights": {
    //         "fat": { "bestMonth":"AGO 25", "bestValue": 123, "worstMonth":"JAN 25", "worstValue": 50 },
    //         "vol": { "bestMonth":"SET 25", "bestValue": 10000, "worstMonth":"JAN 25", "worstValue": 2000 }
    //       },
    //       "evolucao": {
    //          "months": ["JAN 25","FEV 25",...],
    //          "fatCurr": [..], "fatPrev":[..],
    //          "volCurr": [..], "volPrev":[..]
    //       },
    //       "categorias": {
    //          "curr":[{"categoria":"X","valor":100,"pct":0.2,"valorAnterior":90,"pctAnterior":0.18}, ...],
    //          "prev":[{"categoria":"X","valor":90,"pct":0.18}, ...]
    //       },
    //       "map": {
    //          "cities":[{"cidade":"São Paulo","uf":"SP","lat":-23.5,"lon":-46.6,"clientes":10,"fat":100,"vol":2000}, ...]
    //       },
    //       "clientsDist": {
    //          "pie":[{"grupo":"Cliente A","valor":100,"pct":0.15}, {"grupo":"Outros","valor":400,"pct":0.60}],
    //          "top":[{"cliente":"Cliente A","cidade":"X","uf":"SP","fat":100,"vol":2000,"pct":0.15}, ...]
    //       },
    //       "carteiraStatusResumo":[
    //          {"status":"Novos","qtdClientes":10,"pctClientes":0.1,"fatDelta":123},
    //          ...
    //       ],
    //       "statusClientes":{
    //          "Novos":[{"cliente":"A","uf":"SP","cidade":"X","fatAtual":100,"fatAnterior":0,"volAtual":10,"volAnterior":0}, ...],
    //          ...
    //       }
    //     }
    //   ]
    // }
    //
    const loadReports = async () => {
      if (window.REPORTS && window.REPORTS.reps) return window.REPORTS;
      try{
        const r = await fetch("./rep_reports.json", {cache:"no-store"});
        if (!r.ok) throw new Error("Não encontrei ./rep_reports.json (coloque o JSON na mesma pasta do HTML).");
        return await r.json();
      }catch(e){
        // Fallback: tenta um caminho comum no seu repo
        try{
          const r2 = await fetch("../data/rep_reports.json", {cache:"no-store"});
          if (!r2.ok) throw e;
          return await r2.json();
        }catch(e2){
          throw e2;
        }
      }
    };

    // ===== Render functions =====
    const setSubtitle = (repName, meta) => {
      const cur = meta?.currentLabel ?? "-";
      const prev = meta?.previousLabel ?? "-";
      document.getElementById("subtitleLine").innerHTML =
        `Representante: <b>${escapeHtml(repName)}</b><br>` +
        `Período atual: ${escapeHtml(cur)} &nbsp;&nbsp;|&nbsp;&nbsp; Período anterior: ${escapeHtml(prev)}`;
    };

    const renderKPIs = (k) => {
      const grid = document.getElementById("kpiGrid");
      grid.innerHTML = "";

      const cards = [
        { title:"Total período", value: fmtBRLCompact(k.fat), sub:"" },
        { title:"Volume período", value: fmtUN(k.vol), sub:"" },
        { title:"Distribuição por clientes", value: k.hhiLabel ?? "-", sub:`N80: ${k.n80 ?? 0} clientes` },
        { title:"Saúde da carteira", value: `${Math.round(k.carteiraScore ?? 50)} / 100`, sub: (k.carteiraLabel ?? "-") },
        { title:"Clientes atendidos", value: (k.clientes ?? 0).toLocaleString("pt-BR"), sub:"" },
      ];

      for (const c of cards){
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML =
          `<div class="metric-title">${escapeHtml(c.title)}</div>`+
          `<div class="metric-value">${escapeHtml(c.value)}</div>`+
          `<div class="metric-sub">${escapeHtml(c.sub)}</div>`;
        grid.appendChild(el);
      }
    };

    const renderHighlights = (h) => {
      const fat = h?.fat || {};
      const vol = h?.vol || {};

      const fatEl = document.getElementById("highlightsFat");
      fatEl.innerHTML =
        `<div style="font-weight:800; margin-bottom:8px;">Faturamento</div>`+
        `• Melhor mês: <b>${escapeHtml(fat.bestMonth ?? "-")}</b> — ${fmtBRL(fat.bestValue ?? 0)}<br>`+
        `• Pior mês: <b>${escapeHtml(fat.worstMonth ?? "-")}</b> — ${fmtBRL(fat.worstValue ?? 0)}`;

      const volEl = document.getElementById("highlightsVol");
      volEl.innerHTML =
        `<div style="font-weight:800; margin-bottom:8px;">Volume</div>`+
        `• Melhor mês: <b>${escapeHtml(vol.bestMonth ?? "-")}</b> — ${fmtUN(vol.bestValue ?? 0)}<br>`+
        `• Pior mês: <b>${escapeHtml(vol.worstMonth ?? "-")}</b> — ${fmtUN(vol.worstValue ?? 0)}`;
    };

    const renderBarCompare = (canvasId, labels, curr, prev) => {
      const ctx = document.getElementById(canvasId);
      const data = {
        labels,
        datasets: [
          { label:"Atual", data: curr, backgroundColor:"#38bdf8", borderRadius:8 },
          { label:"Anterior", data: prev, backgroundColor:"#22c55e", borderRadius:8 },
        ]
      };
      const opt = {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ position:"top", labels:{ boxWidth: 10, boxHeight: 10 } },
          tooltip:{
            callbacks:{
              label: (c)=>{
                const v = Number(c.raw||0);
                if (canvasId === "chartVol") return `${c.dataset.label}: ${fmtUN(v)}`;
                return `${c.dataset.label}: ${fmtBRL(v)}`;
              }
            }
          }
        },
        scales:{
          x:{ grid:{ display:false } },
          y:{ ticks:{
            callback:(v)=> (canvasId === "chartVol") ? v.toLocaleString("pt-BR") : ("R$ " + Number(v).toLocaleString("pt-BR"))
          }}
        }
      };

      return new Chart(ctx, {type:"bar", data, options: opt});
    };

    const palettePie = ["#38bdf8","#22c55e","#eab308","#f97316","#ef4444","#94a3b8","#a855f7","#14b8a6"];

    const renderPie = (canvasId, rows, valueKey, labelKey) => {
      const ctx = document.getElementById(canvasId);
      const labels = rows.map(r => r[labelKey]);
      const values = rows.map(r => Number(r[valueKey] || 0));

      return new Chart(ctx, {
        type:"doughnut",
        data:{
          labels,
          datasets:[{
            data: values,
            backgroundColor: labels.map((_,i)=> palettePie[i % palettePie.length]),
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          cutout:"55%",
          plugins:{
            legend:{ display:false },
            tooltip:{
              callbacks:{
                label:(c)=>{
                  const v = Number(c.raw||0);
                  const total = c.dataset.data.reduce((a,b)=>a+Number(b||0),0) || 1;
                  const pct = v/total;
                  return `${c.label}: ${fmtBRL(v)} (${fmtPct(pct)})`;
                }
              }
            }
          }
        }
      });
    };

    const buildTable = (tableId, cols, rows) => {
      const tbl = document.getElementById(tableId);
      const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHtml(c.title)}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${
        rows.map(r=>`<tr>${
          cols.map(c=>{
            const raw = r[c.key];
            const val = c.fmt ? c.fmt(raw, r) : (raw ?? "");
            const cls = c.align === "right" ? "td-right" : "";
            return `<td class="${cls}">${escapeHtml(val)}</td>`;
          }).join("")
        }</tr>`).join("")
      }</tbody>`;
      tbl.innerHTML = thead + tbody;
    };

    const renderCategorias = (cat, meta) => {
      const curr = (cat?.curr || []).slice();
      const prev = (cat?.prev || []).slice();

      document.getElementById("catCaptionCurr").textContent = meta?.currentLabel ?? "";
      document.getElementById("catCaptionPrev").textContent = meta?.previousLabel ?? "";

      // Curr pie: top10 + Outras (como no streamlit)
      const currSorted = curr.slice().sort((a,b)=> (b.valor||0)-(a.valor||0));
      let pieCurr = currSorted.slice(0,10);
      if (currSorted.length > 10){
        const othersVal = currSorted.slice(10).reduce((s,x)=>s+Number(x.valor||0),0);
        pieCurr = pieCurr.concat([{categoria:"Outras", valor: othersVal}]);
      }

      // Prev pie: top10 + Outras
      const prevSorted = prev.slice().sort((a,b)=> (b.valor||0)-(a.valor||0));
      let piePrev = prevSorted.slice(0,10);
      if (prevSorted.length > 10){
        const othersVal = prevSorted.slice(10).reduce((s,x)=>s+Number(x.valor||0),0);
        piePrev = piePrev.concat([{categoria:"Outras", valor: othersVal}]);
      }

      if (pieCatCurr) pieCatCurr.destroy();
      if (pieCatPrev) pieCatPrev.destroy();
      pieCatCurr = renderPie("pieCatCurr", pieCurr, "valor", "categoria");
      pieCatPrev = renderPie("pieCatPrev", piePrev, "valor", "categoria");

      // Table Curr: add Valor Anterior and % anterior
      buildTable("tblCatCurr",
        [
          {title:"Categoria", key:"categoria"},
          {title:"Valor", key:"valor", align:"right", fmt:(v)=> fmtBRL(v)},
          {title:"%", key:"pct", align:"right", fmt:(v)=> fmtPct(v)},
          {title:"Valor Anterior", key:"valorAnterior", align:"right", fmt:(v)=> fmtBRL(v)},
          {title:"% Anterior", key:"pctAnterior", align:"right", fmt:(v)=> fmtPct(v)},
        ],
        currSorted.slice(0, 25)
      );

      // Table Prev snapshot: only Categoria, Valor, %
      buildTable("tblCatPrev",
        [
          {title:"Categoria", key:"categoria"},
          {title:"Valor", key:"valor", align:"right", fmt:(v)=> fmtBRL(v)},
          {title:"%", key:"pct", align:"right", fmt:(v)=> fmtPct(v)},
        ],
        prevSorted.slice(0, 25)
      );
    };

    const renderMap = (mdata) => {
      const cities = (mdata?.cities || []).filter(x =>
        Number.isFinite(Number(x.lat)) && Number.isFinite(Number(x.lon))
      );

      // Default is Volume
      const metricKey = "vol";
      const values = cities.map(c => Number(c[metricKey] || 0));
      const bins = buildDynamicBins(values, false);

      // init leaflet once
      if (!leafletMap){
        leafletMap = L.map("map", { zoomControl: true });
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
          maxZoom: 18
        }).addTo(leafletMap);

        leafletLayerGroup = L.layerGroup().addTo(leafletMap);
      }

      leafletLayerGroup.clearLayers();

      if (!cities.length){
        leafletMap.setView([-14.2, -51.9], 4);
        document.getElementById("mapLegend").innerHTML = `<div class="sub">Sem coordenadas para exibir no mapa.</div>`;
        return;
      }

      // center
      const latAvg = cities.reduce((s,c)=>s+Number(c.lat),0)/cities.length;
      const lonAvg = cities.reduce((s,c)=>s+Number(c.lon),0)/cities.length;
      leafletMap.setView([latAvg, lonAvg], 5);

      for (const c of cities){
        const v = Number(c[metricKey] || 0);
        const b = getBin(v, bins);
        const color = b.color;

        const popup =
          `<b>${escapeHtml(c.cidade)} - ${escapeHtml(c.uf)}</b><br>`+
          `Volume: ${escapeHtml(fmtUN(c.vol || 0))}<br>`+
          `Faturamento: ${escapeHtml(fmtBRL(c.fat || 0))}<br>`+
          `Clientes: ${escapeHtml((c.clientes || 0).toLocaleString("pt-BR"))}`;

        L.circleMarker([Number(c.lat), Number(c.lon)], {
          radius: 6,
          color,
          fillColor: color,
          fillOpacity: 0.8,
          weight: 1
        }).bindPopup(popup).addTo(leafletLayerGroup);
      }

      // legend
      const legend = [
        `<div style="font-weight:800; margin-bottom:6px;">Legenda – Volume (un)</div>`,
        ...bins.map(b=>(
          `<div class="legend-item"><span class="swatch" style="background:${b.color}"></span>${escapeHtml(b.label)}</div>`
        ))
      ].join("");
      document.getElementById("mapLegend").innerHTML = legend;
    };

    const renderTopClientsTable = (rows) => {
      // Table: add Volume next to Faturamento (pedido)
      buildTable("tblTopClients",
        [
          {title:"Cliente", key:"cliente"},
          {title:"Cidade", key:"cidade"},
          {title:"UF", key:"uf"},
          {title:"Faturamento", key:"fat", align:"right", fmt:(v)=> fmtBRL(v)},
          {title:"Volume", key:"vol", align:"right", fmt:(v)=> fmtUN(v)},
        ],
        (rows || []).slice(0, 15)
      );
    };

    const renderDistribuicaoClientes = (k, dist) => {
      // Badges (somente aqui)
      const n80Text = `N80: ${k.n80 ?? 0} clientes (${Math.round((k.n80Ratio||0)*100)}% da carteira)`;
      const n80Color = colorForN80Ratio(k.n80Ratio || 0);
      document.getElementById("badgeN80").innerHTML = badgeHTML(n80Text, n80Color);

      const hhiText = `${k.hhiLabel ?? "—"} (HHI ${(k.hhi ?? 0).toFixed(3)})`;
      const hhiColor = colorForHHI(k.hhi || 0);
      document.getElementById("badgeHHI").innerHTML = badgeHTML(hhiText, hhiColor);

      document.getElementById("topSharesLine").textContent =
        `Top 1: ${fmtPct(k.top1||0)} • Top 3: ${fmtPct(k.top3||0)} • Top 10: ${fmtPct(k.top10||0)}`;

      // Pie
      const pieRows = (dist?.pie || []).slice();
      if (pieClients) pieClients.destroy();
      pieClients = new Chart(document.getElementById("pieClients"),{
        type:"pie",
        data:{
          labels: pieRows.map(r=> r.grupo),
          datasets:[{
            data: pieRows.map(r=> Number(r.valor||0)),
            backgroundColor: pieRows.map((_,i)=> palettePie[i % palettePie.length]),
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{ display:false },
            tooltip:{
              callbacks:{
                label:(c)=>{
                  const v = Number(c.raw||0);
                  const total = c.dataset.data.reduce((a,b)=>a+Number(b||0),0) || 1;
                  const pct = v/total;
                  return `${c.label}: ${fmtBRL(v)} (${fmtPct(pct)})`;
                }
              }
            }
          }
        }
      });

      // Top table
      buildTable("tblClientsTop",
        [
          {title:"Cliente", key:"cliente"},
          {title:"Cidade", key:"cidade"},
          {title:"UF", key:"uf"},
          {title:"Faturamento", key:"fat", align:"right", fmt:(v)=> fmtBRL(v)},
          {title:"% Fat", key:"pct", align:"right", fmt:(v)=> fmtPct(v)},
          {title:"Volume", key:"vol", align:"right", fmt:(v)=> fmtUN(v)},
        ],
        (dist?.top || []).slice(0, 15)
      );
    };

    const renderCarteira = (k, resumoRows) => {
      const score = Number(k.carteiraScore ?? 50);
      const label = k.carteiraLabel ?? "Neutra";
      const color = colorForCarteiraScore(score);
      document.getElementById("badgeCarteira").innerHTML = badgeHTML(`${Math.round(score)} / 100 — ${label}`, color);

      buildTable("tblStatusResumo",
        [
          {title:"Status", key:"status"},
          {title:"Clientes", key:"qtdClientes", align:"right", fmt:(v)=> Number(v||0).toLocaleString("pt-BR")},
          {title:"% Clientes", key:"pctClientes", align:"right", fmt:(v)=> fmtPct(v)},
          {title:"Δ Faturamento", key:"fatDelta", align:"right", fmt:(v)=> {
            const n = Number(v||0);
            const s = n < 0 ? "-" : "";
            return s + fmtBRL(Math.abs(n));
          }},
        ],
        (resumoRows || [])
      );
    };

    const renderStatusClientes = (meta, statusObj) => {
      const root = document.getElementById("statusTables");
      root.innerHTML = "";

      const curLabel = meta?.currentLabel ?? "Atual";
      const prevLabel = meta?.previousLabel ?? "Anterior";

      const makeBlock = (statusName, rows) => {
        const wrap = document.createElement("div");
        wrap.className = "card";
        wrap.style.marginBottom = "12px";

        const title = document.createElement("div");
        title.style.fontWeight = "800";
        title.style.marginBottom = "8px";
        title.textContent = statusName;

        const tableId = "tbl_" + statusName.replace(/\s+/g,"_");
        const table = document.createElement("table");
        table.id = tableId;

        wrap.appendChild(title);
        wrap.appendChild(table);
        root.appendChild(wrap);

        buildTable(tableId,
          [
            {title:"Cliente", key:"cliente"},
            {title:"UF", key:"uf"},
            {title:"Cidade", key:"cidade"},
            {title:`Fat ${curLabel}`, key:"fatAtual", align:"right", fmt:(v)=> fmtBRL(v)},
            {title:`Fat ${prevLabel}`, key:"fatAnterior", align:"right", fmt:(v)=> fmtBRL(v)},
            {title:`Vol ${curLabel}`, key:"volAtual", align:"right", fmt:(v)=> fmtUN(v)},
            {title:`Vol ${prevLabel}`, key:"volAnterior", align:"right", fmt:(v)=> fmtUN(v)},
            {title:"Δ Fat", key:"fatDelta", align:"right", fmt:(v, r)=>{
              const d = Number(r.fatAtual||0) - Number(r.fatAnterior||0);
              const s = d < 0 ? "-" : "";
              return s + fmtBRL(Math.abs(d));
            }},
            {title:"Δ Vol", key:"volDelta", align:"right", fmt:(v, r)=>{
              const d = Number(r.volAtual||0) - Number(r.volAnterior||0);
              const s = d < 0 ? "-" : "";
              return s + fmtUN(Math.abs(d));
            }},
          ],
          rows
        );
      };

      for (const s of STATUS_ORDER){
        const rows = (statusObj && statusObj[s]) ? statusObj[s].slice() : [];
        if (!rows.length) continue;
        // sort by fatAtual desc (como streamlit)
        rows.sort((a,b)=> (Number(b.fatAtual||0) - Number(a.fatAtual||0)));
        makeBlock(s, rows);
      }
    };

    const applySearch = (meta, statusObj, query) => {
      const filtered = {};
      const q = (query || "").trim().toLowerCase();
      for (const s of STATUS_ORDER){
        const rows = (statusObj && statusObj[s]) ? statusObj[s] : [];
        filtered[s] = !q ? rows : rows.filter(r => String(r.cliente||"").toLowerCase().includes(q));
      }
      renderStatusClientes(meta, filtered);
    };

    // ===== Main render =====
    const populateRepSelect = (reports) => {
      const sel = document.getElementById("repSelect");
      sel.innerHTML = "";

      const reps = reports.reps || [];
      reps.forEach((r, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = r.rep || `Rep ${i+1}`;
        sel.appendChild(opt);
      });

      return reps.length ? 0 : -1;
    };

    const renderRepIndex = (reports, idx) => {
      const meta = reports.meta || {};
      const repObj = reports.reps[idx];
      if (!repObj) return;

      setSubtitle(repObj.rep || "-", meta);

      // KPIs (sem badges verdes extras)
      renderKPIs(repObj.kpis || {});

      // Destaques
      renderHighlights(repObj.highlights || {});

      // Evolução (barras)
      const evo = repObj.evolucao || {};
      const labels = evo.months || [];
      if (chartFat) chartFat.destroy();
      if (chartVol) chartVol.destroy();
      chartFat = renderBarCompare("chartFat", labels, (evo.fatCurr||[]), (evo.fatPrev||[]));
      chartVol = renderBarCompare("chartVol", labels, (evo.volCurr||[]), (evo.volPrev||[]));

      // Categorias
      renderCategorias(repObj.categorias || {}, meta);

      // Map + coverage + top clients table (com volume ao lado)
      document.getElementById("covCities").textContent = (repObj.kpis?.cidades ?? 0).toLocaleString("pt-BR");
      document.getElementById("covStates").textContent = (repObj.kpis?.estados ?? 0).toLocaleString("pt-BR");
      document.getElementById("covClients").textContent = (repObj.kpis?.clientes ?? 0).toLocaleString("pt-BR");
      renderMap(repObj.map || {});

      // Top clients (usar a lista "top" do dist se existir; senão tenta mdata)
      const topClientsRows = (repObj.map?.topClients || repObj.clientsDist?.top || []).slice(0, 15);
      renderTopClientsTable(topClientsRows);

      // Distribuição por clientes (badges coloridos aqui)
      renderDistribuicaoClientes(repObj.kpis || {}, repObj.clientsDist || {});

      // Carteira detalhes
      renderCarteira(repObj.kpis || {}, repObj.carteiraStatusResumo || []);

      // Status clientes
      renderStatusClientes(meta, repObj.statusClientes || {});
      const search = document.getElementById("clientSearch");
      search.value = "";
      search.oninput = () => applySearch(meta, repObj.statusClientes || {}, search.value);
    };

    // ===== Boot =====
    (async function boot(){
      document.getElementById("btnPrint").addEventListener("click", () => window.print());

      try{
        const reports = await loadReports();

        const defaultIdx = populateRepSelect(reports);
        if (defaultIdx < 0){
          alert("Nenhum representante encontrado no JSON. Verifique reports.reps.");
          return;
        }

        // initial render
        renderRepIndex(reports, defaultIdx);

        // dropdown change: troca sem recarregar
        document.getElementById("repSelect").addEventListener("change", (e)=>{
          const idx = Number(e.target.value);
          renderRepIndex(reports, idx);
          window.scrollTo({top:0, behavior:"instant"});
        });

      }catch(err){
        console.error(err);
        alert(
          "Erro ao carregar dados do relatório.\n\n" +
          String(err?.message || err) +
          "\n\nColoque um arquivo ./rep_reports.json na mesma pasta do HTML " +
          "OU embuta window.REPORTS = {...} no final do HTML."
        );
      }
    })();
  </script>

  <!--
    OPCIONAL: embutir dados aqui para virar um HTML 100% standalone.
    Exemplo:
    <script>
      window.REPORTS = { ... JSON ... };
    </script>
  -->

</body>
</html>
