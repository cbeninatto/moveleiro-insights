<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insights de Vendas – Relatório por Representante</title>

  <!-- Plotly + Leaflet (GitHub Pages friendly) -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b31;
      --panel2:#0d182c;
      --text:#e7eefc;
      --muted:rgba(231,238,252,0.72);
      --line:rgba(255,255,255,0.08);

      --blue:#38bdf8;
      --green:#22c55e;
      --yellow:#eab308;
      --orange:#f97316;
      --red:#ef4444;

      --radius:14px;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --pad:14px;
      --gap:14px;

      /* typographic scale (tuned to feel like Streamlit) */
      --h1:26px;
      --h2:18px;
      --label:12px;
      --kpi:22px;
      --kpiSmall:12px;
      --body:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:radial-gradient(1200px 900px at 20% 0%, rgba(56,189,248,0.12), transparent 50%),
                 radial-gradient(1200px 900px at 80% 10%, rgba(34,197,94,0.10), transparent 55%),
                 var(--bg);
      color:var(--text);
    }

    .wrap{max-width:1320px;margin:0 auto;padding:18px 18px 40px}
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; margin-bottom:10px;
    }
    .titleblock h1{margin:0;font-size:var(--h1);letter-spacing:0.2px}
    .titleblock .sub{margin-top:6px;color:var(--muted);font-size:var(--body)}
    .controls{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:rgba(15,27,49,0.65);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:10px 12px;
    }
    .controls label{font-size:var(--label);color:var(--muted)}
    select, button{
      background:rgba(13,24,44,0.85);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
      outline:none;
    }
    button{cursor:pointer}
    button:hover{border-color:rgba(56,189,248,0.35)}

    .divider{height:1px;background:var(--line);margin:12px 0 16px}

    /* Streamlit-like "sections" */
    .section{
      background:linear-gradient(180deg, rgba(15,27,49,0.92), rgba(13,24,44,0.92));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
      margin-bottom:14px;
    }
    .section h2{
      margin:0 0 10px;
      font-size:var(--h2);
      letter-spacing:0.2px;
    }
    .section .hint{margin-top:-2px;color:var(--muted);font-size:var(--body)}
    .grid5{
      display:grid;
      grid-template-columns:repeat(5, minmax(0,1fr));
      gap:var(--gap);
    }
    @media (max-width: 1100px){
      .grid5{grid-template-columns:repeat(2, minmax(0,1fr))}
    }
    @media (max-width: 560px){
      .grid5{grid-template-columns:1fr}
    }

    .kpi{
      background:rgba(13,24,44,0.88);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px 12px 10px;
      min-height:88px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .kpi .label{font-size:var(--label);color:var(--muted);letter-spacing:0.2px}
    .kpi .value{font-size:var(--kpi);font-weight:800;letter-spacing:0.2px;margin-top:6px}
    .kpi .delta{font-size:var(--kpiSmall);color:var(--muted);margin-top:6px}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      font-weight:700;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      white-space:nowrap;
    }
    .badge.dot::before{
      content:"";
      width:8px;height:8px;border-radius:999px;
      background:currentColor;
      opacity:0.9;
      display:inline-block;
    }

    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:var(--gap);
      align-items:stretch;
    }
    @media (max-width: 1000px){ .row2{grid-template-columns:1fr} }

    .panel{
      background:rgba(13,24,44,0.88);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      overflow:hidden;
    }
    .panel h3{
      margin:0 0 8px;
      font-size:14px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:0.2px;
    }

    /* tables */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      text-align:left;
      padding:7px 8px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
      vertical-align:top;
    }
    th{color:rgba(231,238,252,0.85);font-weight:700}
    td{color:rgba(231,238,252,0.92)}
    .table-wrap{overflow:auto; border-radius:12px}

    /* map */
    #map{height:680px;width:100%; border-radius:12px; overflow:hidden}
    .legend-item{display:flex; align-items:center; gap:8px; margin:6px 0; font-size:12px; color:rgba(231,238,252,0.86)}
    .swatch{width:12px;height:12px;border-radius:3px;display:inline-block}
    .sub{color:var(--muted);font-size:13px}

    /* print */
    @page { size: A4 portrait; margin: 1.5cm; }
    @media print{
      body{background:#fff}
      .wrap{max-width:none;padding:0}
      .controls{display:none!important}
      .section{box-shadow:none}
      .no-print{display:none!important}
      a[href]::after{content:""}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="titleblock">
        <h1>Insights de Vendas</h1>
        <div class="sub" id="headerSub">Carregando…</div>
      </div>

      <div class="controls no-print">
        <div>
          <label for="repSel">Representante</label><br/>
          <select id="repSel"></select>
        </div>
        <div>
          <label for="currLabel">Período atual</label><br/>
          <select id="currLabel"></select>
        </div>
        <div>
          <label for="prevLabel">Período anterior</label><br/>
          <select id="prevLabel"></select>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px; padding-top:18px">
          <button id="btnPrint">Imprimir</button>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- 1. Performance Dashboard -->
    <div class="section" id="secKpis">
      <h2>Performance Dashboard</h2>
      <div class="grid5" id="kpiGrid"></div>
    </div>

    <!-- 2. Evolução – Faturamento e Volume (comparativo) -->
    <div class="section" id="secEvolucao">
      <h2>Evolução – Faturamento e Volume (comparativo)</h2>
      <div class="row2">
        <div class="panel">
          <h3>Faturamento</h3>
          <div id="chartFat" style="height:340px"></div>
        </div>
        <div class="panel">
          <h3>Volume</h3>
          <div id="chartVol" style="height:340px"></div>
        </div>
      </div>
    </div>

    <!-- 3. Categorias vendidas -->
    <div class="section" id="secCategorias">
      <h2>Categorias vendidas</h2>
      <div class="row2">
        <div class="panel">
          <h3>Período atual</h3>
          <div id="pieCategoriasCurr" style="height:520px"></div>
          <div class="sub" id="catCurrHint"></div>
        </div>
        <div class="panel">
          <h3>Período anterior</h3>
          <div id="pieCategoriasPrev" style="height:520px"></div>
          <div class="sub" id="catPrevHint"></div>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="panel">
        <h3>Tabela – Período atual (com Valor Anterior e % anterior)</h3>
        <div class="table-wrap" id="tblCategorias"></div>
      </div>
    </div>

    <!-- 4. Mapa de Clientes -->
    <div class="section" id="secMapa">
      <h2>Mapa de Clientes</h2>
      <div class="row2" style="grid-template-columns: 1.25fr 0.75fr;">
        <div class="panel">
          <div id="map"></div>
          <div style="margin-top:10px" id="mapLegend"></div>
        </div>
        <div class="panel">
          <h3>Cobertura</h3>
          <div id="mapCoverage" class="sub">—</div>
          <div style="height:10px"></div>
          <h3>Principais clientes</h3>
          <div class="table-wrap" id="tblTopClientes"></div>
          <div style="height:12px"></div>
          <h3>Clientes da cidade selecionada</h3>
          <div class="sub" id="cityHint">Clique em um ponto no mapa.</div>
          <div class="table-wrap" id="tblCityClientes"></div>
        </div>
      </div>
    </div>

    <!-- 5. Distribuição por clientes -->
    <div class="section" id="secClientesDist">
      <h2>Distribuição por clientes</h2>
      <div class="panel">
        <div class="grid5" id="kpiDistGrid"></div>
      </div>
      <div style="height:12px"></div>
      <div class="row2">
        <div class="panel">
          <h3>Participação (Top 10 destacados)</h3>
          <div id="pieClientes" style="height:520px"></div>
        </div>
        <div class="panel">
          <h3>Resumo (Top 15)</h3>
          <div class="table-wrap" id="tblClientes"></div>
        </div>
      </div>
    </div>

    <!-- 6. Saúde da carteira – Detalhes -->
    <div class="section" id="secCarteira">
      <h2>Saúde da carteira – Detalhes</h2>
      <div class="row2">
        <div class="panel" id="carteiraScoreBox"></div>
        <div class="panel">
          <h3>Resumo por status</h3>
          <div class="table-wrap" id="tblCarteiraResumo"></div>
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="panel">
        <h3>Distribuição de clientes por status</h3>
        <div id="pieStatus" style="height:360px"></div>
      </div>
    </div>

    <!-- 7. Status dos clientes -->
    <div class="section" id="secStatusClientes">
      <h2>Status dos clientes</h2>
      <div class="panel">
        <div class="sub" style="margin-bottom:10px">
          Buscar cliente:
          <input id="searchCliente" placeholder="Digite parte do nome do cliente"
                 style="margin-left:10px; width:380px; max-width:100%; padding:8px 10px; border-radius:12px; border:1px solid var(--line); background:rgba(13,24,44,0.85); color:var(--text);" />
        </div>
        <div id="statusTables"></div>
      </div>
    </div>

  </div>

  <script>
    /**********************************************************************
     * DATA LOADING
     * Put your JSON here (recommended):
     *   /reports/data/rep_reports.json
     * so this HTML at /reports/insights_rep_report.html can fetch:
     *   ./data/rep_reports.json
     **********************************************************************/
    const DATA_URLS = [
      "./data/rep_reports.json",
      "../data/rep_reports.json",
      "./rep_reports.json"
    ];

    let DATA = null;

    // Leaflet state
    let leafletMap = null;
    let leafletLayerGroup = null;
    let lastCityKey = null;

    // Colors / bins (same spirit as your Streamlit)
    const MAP_BIN_COLORS = ["#22c55e","#eab308","#f97316","#ef4444"];

    const STATUS_ORDER = ["Novos","Crescendo","Estáveis","Caindo","Perdidos"];

    // ---------- helpers ----------
    const escapeHtml = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    const fmtBRL = (v) => {
      const n = Number(v || 0);
      return n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    };
    const fmtBRLCompact = (v) => {
      const n = Number(v || 0);
      const a = Math.abs(n);
      if (a >= 1e9) return "R$ " + (n/1e9).toFixed(1).replace(".",",") + " bi";
      if (a >= 1e6) return "R$ " + (n/1e6).toFixed(1).replace(".",",") + " mi";
      if (a >= 1e3) return "R$ " + (n/1e3).toFixed(1).replace(".",",") + " mil";
      return fmtBRL(n);
    };
    const fmtUN = (v) => {
      const n = Math.round(Number(v || 0));
      return n.toLocaleString("pt-BR") + " un";
    };
    const pct = (x, digits=1) => (Number(x||0)*100).toFixed(digits).replace(".",",") + "%";
    const pct1 = (x) => (Number(x||0)*100).toFixed(1).replace(".",",") + "%";

    const toNum = (x) => {
      if (x === null || x === undefined) return NaN;
      if (typeof x === "number") return x;
      // supports "-23,55" and "-23.55"
      const s = String(x).trim().replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    };

    const badgeHtml = (text, color) =>
      `<span class="badge dot" style="color:${color}; border-color: rgba(255,255,255,0.12); background: rgba(255,255,255,0.06)">
        ${escapeHtml(text)}
      </span>`;

    // ---------- scoring colors (match your “color code” idea) ----------
    // N80 ratio: smaller ratio (needs fewer clients to reach 80%) => more concentrated => worse
    const colorForN80Ratio = (ratio) => {
      const r = Number(ratio || 0);
      if (r <= 0.10) return "var(--red)";
      if (r <= 0.18) return "var(--orange)";
      if (r <= 0.28) return "var(--yellow)";
      return "var(--green)";
    };
    // HHI value: higher => more concentrated => worse
    const colorForHHI = (hhi) => {
      const v = Number(hhi || 0);
      if (v >= 0.20) return "var(--red)";
      if (v >= 0.10) return "var(--orange)";
      if (v >= 0.07) return "var(--yellow)";
      return "var(--green)";
    };
    // carteira score 0..100
    const colorForCarteiraScore = (score) => {
      const s = Number(score || 0);
      if (s < 30) return "var(--red)";
      if (s < 50) return "var(--orange)";
      if (s < 70) return "var(--yellow)";
      return "var(--green)";
    };

    // ---------- dynamic bins (same concept as Streamlit) ----------
    const buildDynamicBins = (values, isValor) => {
      const cleaned = (values || [])
        .map(v => Number(v))
        .filter(v => Number.isFinite(v) && v >= 0)
        .sort((a,b)=>a-b);

      const fmt = (v) => isValor ? ("R$ " + Math.round(v).toLocaleString("pt-BR")) : (Math.round(v).toLocaleString("pt-BR") + " un");

      if (!cleaned.length){
        if (isValor){
          return [
            {min:1_000_000,color:MAP_BIN_COLORS[0],label:"R$ 1.000.000+"},
            {min:500_000,color:MAP_BIN_COLORS[1],label:"R$ 500.000 - 999.999"},
            {min:250_000,color:MAP_BIN_COLORS[2],label:"R$ 250.000 - 499.999"},
            {min:0,color:MAP_BIN_COLORS[3],label:"R$ 0 - 249.999"},
          ];
        }
        return [
          {min:10_000,color:MAP_BIN_COLORS[0],label:"10.000 un+"},
          {min:5_000,color:MAP_BIN_COLORS[1],label:"5.000 - 9.999 un"},
          {min:2_500,color:MAP_BIN_COLORS[2],label:"2.500 - 4.999 un"},
          {min:0,color:MAP_BIN_COLORS[3],label:"0 - 2.499 un"},
        ];
      }

      const n = cleaned.length;
      const minVal = cleaned[0];
      const maxVal = cleaned[n-1];
      if (minVal === maxVal){
        const labelSingle = fmt(minVal);
        const color = MAP_BIN_COLORS[0];
        return [
          {min:minVal,color,label:labelSingle},
          {min:minVal,color,label:labelSingle},
          {min:minVal,color,label:labelSingle},
          {min:0,color,label:labelSingle},
        ];
      }

      const idx = (p) => Math.floor(p*(n-1));
      const q1 = cleaned[idx(0.25)];
      const q2 = cleaned[idx(0.50)];
      const q3 = cleaned[idx(0.75)];

      const t0 = Math.max(0, minVal);
      const t1 = Math.max(t0, q1);
      const t2 = Math.max(t1, q2);
      const t3 = Math.max(t2, q3);

      return [
        {min:t3,color:MAP_BIN_COLORS[0],label:`${fmt(t3)}+`},
        {min:t2,color:MAP_BIN_COLORS[1],label:`${fmt(t2)} - ${fmt(t3)}`},
        {min:t1,color:MAP_BIN_COLORS[2],label:`${fmt(t1)} - ${fmt(t2)}`},
        {min:t0,color:MAP_BIN_COLORS[3],label:`${fmt(t0)} - ${fmt(t1)}`},
      ];
    };

    const getBin = (v, bins) => {
      for (const b of bins) if (Number(v) >= b.min) return b;
      return bins[bins.length-1];
    };

    // ---------- HTML builders ----------
    const kpiCard = (label, value, deltaHtml="") => `
      <div class="kpi">
        <div class="label">${escapeHtml(label)}</div>
        <div class="value">${escapeHtml(value)}</div>
        <div class="delta">${deltaHtml || ""}</div>
      </div>
    `;

    const tableHtml = (cols, rows) => {
      let h = `<table><thead><tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join("")}</tr></thead><tbody>`;
      for (const r of rows){
        h += "<tr>" + cols.map(c => `<td>${r[c] ?? ""}</td>`).join("") + "</tr>";
      }
      h += "</tbody></table>";
      return h;
    };

    // ---------- Plotly default theme ----------
    const PLOT_LAYOUT_BASE = {
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)",
      font: {family: getComputedStyle(document.documentElement).getPropertyValue("--font").trim(), color: "rgba(231,238,252,0.92)"},
      margin: {l: 50, r: 18, t: 12, b: 42},
      xaxis: {gridcolor:"rgba(255,255,255,0.06)", zerolinecolor:"rgba(255,255,255,0.06)"},
      yaxis: {gridcolor:"rgba(255,255,255,0.06)", zerolinecolor:"rgba(255,255,255,0.06)"},
      showlegend: true,
      legend: {orientation:"h", y:1.10, x:0, font:{size:12}},
    };

    // ---------- Renderers ----------
    function renderHeader(rep, currLabel, prevLabel){
      const repName = rep === "Todos" ? "Todos" : rep;
      document.getElementById("headerSub").innerHTML =
        `Representante: <b>${escapeHtml(repName)}</b> &nbsp;|&nbsp; ` +
        `Período atual: <b>${escapeHtml(currLabel)}</b> &nbsp;|&nbsp; ` +
        `Período anterior: <b>${escapeHtml(prevLabel)}</b>`;
    }

    function renderKpis(repObj){
      const k = repObj?.kpis || {};
      const clientesAtendidos = Number(k.clientes_atendidos || 0);
      const n80 = Number(k.n80_count || 0);
      const n80Ratio = clientesAtendidos > 0 ? (n80 / clientesAtendidos) : 0;

      const hhi = Number(k.hhi_value || 0);
      const hhiLabel = k.hhi_label_short || "—";

      const carteiraScore = Number(k.carteira_score || 50);
      const carteiraLabel = k.carteira_label || "Neutra";

      // remove the “green text”: we DO NOT print deltas as plain green; use badge only
      const grid = document.getElementById("kpiGrid");
      grid.innerHTML = [
        kpiCard("Total período", fmtBRLCompact(k.total_faturamento || 0)),
        kpiCard("Volume período", fmtUN(k.total_volume || 0)),
        kpiCard(
          "Distribuição por clientes",
          hhiLabel,
          badgeHtml(`N80: ${n80} clientes (${pct(n80Ratio,0)} da carteira)`, `rgb(${getCssColor(colorForN80Ratio(n80Ratio))})`) +
          "&nbsp;&nbsp;" +
          badgeHtml(`HHI: ${hhi.toFixed(3)}`, `rgb(${getCssColor(colorForHHI(hhi))})`)
        ),
        kpiCard(
          "Saúde da carteira",
          `${Math.round(carteiraScore)} / 100`,
          badgeHtml(carteiraLabel, `rgb(${getCssColor(colorForCarteiraScore(carteiraScore))})`)
        ),
        kpiCard("Clientes atendidos", String(clientesAtendidos)),
      ].join("");
    }

    // Convert CSS var colors to rgb string for consistent badge/dot usage
    function getCssColor(cssVarOrColor){
      // returns "r,g,b" (no alpha)
      const dummy = document.createElement("div");
      dummy.style.color = cssVarOrColor;
      document.body.appendChild(dummy);
      const c = getComputedStyle(dummy).color; // "rgb(r,g,b)" or "rgba(...)"
      dummy.remove();
      const m = c.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      if (!m) return "255,255,255";
      return `${m[1]},${m[2]},${m[3]}`;
    }

    function renderEvolucao(repObj){
      const evo = repObj?.evolucao || {};
      const curr = Array.isArray(evo.curr) ? evo.curr : [];
      const prev = Array.isArray(evo.prev) ? evo.prev : [];

      // expects items like: {label:"JAN 25", faturamento:123, volume:456}
      const xCurr = curr.map(d => d.label);
      const yFatCurr = curr.map(d => Number(d.faturamento || 0));
      const yVolCurr = curr.map(d => Number(d.volume || 0));

      const xPrev = prev.map(d => d.label);
      const yFatPrev = prev.map(d => Number(d.faturamento || 0));
      const yVolPrev = prev.map(d => Number(d.volume || 0));

      // bar comparative: overlay bars with slight opacity
      Plotly.newPlot("chartFat", [
        {type:"bar", x:xPrev, y:yFatPrev, name:"Período anterior", marker:{color:"rgba(231,238,252,0.28)"}, hovertemplate:"%{x}<br>Anterior: %{y:,}<extra></extra>"},
        {type:"bar", x:xCurr, y:yFatCurr, name:"Período atual", marker:{color:"rgba(56,189,248,0.85)"}, hovertemplate:"%{x}<br>Atual: %{y:,}<extra></extra>"},
      ], {
        ...PLOT_LAYOUT_BASE,
        barmode:"overlay",
        yaxis:{...PLOT_LAYOUT_BASE.yaxis, title:"Faturamento (R$)"},
        xaxis:{...PLOT_LAYOUT_BASE.xaxis, title:null},
      }, {displayModeBar:false, responsive:true});

      Plotly.newPlot("chartVol", [
        {type:"bar", x:xPrev, y:yVolPrev, name:"Período anterior", marker:{color:"rgba(231,238,252,0.28)"}, hovertemplate:"%{x}<br>Anterior: %{y:,}<extra></extra>"},
        {type:"bar", x:xCurr, y:yVolCurr, name:"Período atual", marker:{color:"rgba(34,197,94,0.85)"}, hovertemplate:"%{x}<br>Atual: %{y:,}<extra></extra>"},
      ], {
        ...PLOT_LAYOUT_BASE,
        barmode:"overlay",
        yaxis:{...PLOT_LAYOUT_BASE.yaxis, title:"Volume (un)"},
        xaxis:{...PLOT_LAYOUT_BASE.xaxis, title:null},
      }, {displayModeBar:false, responsive:true});
    }

    function renderCategorias(repObj, currLabel, prevLabel){
      const cats = repObj?.categorias || {};
      const curr = Array.isArray(cats.curr) ? cats.curr : []; // [{categoria, valor, pct}]
      const prev = Array.isArray(cats.prev) ? cats.prev : []; // same

      // Pie for current
      const currNames = curr.map(d => `${d.categoria} ${(Number(d.pct||0)*100).toFixed(1)}%`);
      const currVals = curr.map(d => Number(d.valor||0));
      Plotly.newPlot("pieCategoriasCurr", [{
        type:"pie",
        values: currVals,
        labels: currNames,
        hole: 0.35,
        textinfo:"none"
      }], {
        ...PLOT_LAYOUT_BASE,
        showlegend:false,
        margin:{l:10,r:10,t:10,b:10}
      }, {displayModeBar:false, responsive:true});
      document.getElementById("catCurrHint").innerHTML = `Período atual: <b>${escapeHtml(currLabel)}</b>`;

      // Pie for prev
      const prevNames = prev.map(d => `${d.categoria} ${(Number(d.pct||0)*100).toFixed(1)}%`);
      const prevVals = prev.map(d => Number(d.valor||0));
      Plotly.newPlot("pieCategoriasPrev", [{
        type:"pie",
        values: prevVals,
        labels: prevNames,
        hole: 0.35,
        textinfo:"none"
      }], {
        ...PLOT_LAYOUT_BASE,
        showlegend:false,
        margin:{l:10,r:10,t:10,b:10}
      }, {displayModeBar:false, responsive:true});
      document.getElementById("catPrevHint").innerHTML = `Período anterior: <b>${escapeHtml(prevLabel)}</b>`;

      // Table: current with Valor Anterior and % anterior
      // We'll merge by categoria name
      const prevMap = new Map(prev.map(p => [String(p.categoria||""), p]));
      const totalCurr = currVals.reduce((a,b)=>a+b,0) || 1;

      const rows = curr
        .slice()
        .sort((a,b)=>Number(b.valor||0)-Number(a.valor||0))
        .map(c => {
          const p = prevMap.get(String(c.categoria||"")) || {valor:0,pct:0};
          return {
            "Categoria": escapeHtml(c.categoria),
            "Valor": escapeHtml(fmtBRL(c.valor||0)),
            "%": escapeHtml(pct1((c.valor||0)/totalCurr)),
            "Valor Anterior": escapeHtml(fmtBRL(p.valor||0)),
            "% Anterior": escapeHtml(pct1(Number(p.pct||0))),
          };
        });

      document.getElementById("tblCategorias").innerHTML =
        tableHtml(["Categoria","Valor","%","Valor Anterior","% Anterior"], rows);
    }

    function renderMapa(repObj){
      const mapObj = repObj?.mapa || {};
      const rawCities = Array.isArray(mapObj.cities) ? mapObj.cities : [];

      // Normalize + parse coords
      const cities = rawCities.map(c => ({
        cidade: c.cidade ?? c.Cidade ?? c.CIDADE ?? "",
        uf: c.uf ?? c.UF ?? c.estado ?? c.Estado ?? "",
        lat: toNum(c.lat ?? c.latitude ?? c.Lat ?? c.LAT),
        lon: toNum(c.lon ?? c.lng ?? c.longitude ?? c.Lon ?? c.LON),
        vol: Number(c.vol ?? c.volume ?? c.Volume ?? c.Quantidade ?? 0),
        fat: Number(c.fat ?? c.faturamento ?? c.Valor ?? c.valor ?? 0),
        clientes: Number(c.clientes ?? c.Clientes ?? 0),
      })).filter(c => Number.isFinite(c.lat) && Number.isFinite(c.lon));

      // rebuild map cleanly on rep change
      const container = document.getElementById("map");
      container.innerHTML = "";
      if (leafletMap) {
        leafletMap.remove();
        leafletMap = null;
        leafletLayerGroup = null;
      }

      leafletMap = L.map(container, { zoomControl: true });

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
        maxZoom: 18
      }).addTo(leafletMap);

      leafletLayerGroup = L.layerGroup().addTo(leafletMap);

      if (!cities.length){
        leafletMap.setView([-14.2, -51.9], 4);
        document.getElementById("mapLegend").innerHTML =
          `<div class="sub">Sem coordenadas para exibir no mapa (verifique o merge com cidades_br_geo.csv).</div>`;
        document.getElementById("mapCoverage").innerHTML = "—";
        document.getElementById("tblTopClientes").innerHTML = "";
        document.getElementById("tblCityClientes").innerHTML = "";
        document.getElementById("cityHint").textContent = "Sem pontos no mapa para este recorte.";
        setTimeout(() => leafletMap.invalidateSize(true), 60);
        return;
      }

      // Default metric = Volume (requested)
      const values = cities.map(c => Number(c.vol || 0));
      const bins = buildDynamicBins(values, false);

      // center
      const latAvg = cities.reduce((s, c) => s + c.lat, 0) / cities.length;
      const lonAvg = cities.reduce((s, c) => s + c.lon, 0) / cities.length;
      leafletMap.setView([latAvg, lonAvg], 5);

      // legend
      document.getElementById("mapLegend").innerHTML =
        `<div style="font-weight:800; margin-bottom:6px;">Legenda – Volume (un)</div>` +
        bins.map(b => `
          <div class="legend-item">
            <span class="swatch" style="background:${b.color}"></span>${escapeHtml(b.label)}
          </div>
        `).join("");

      // coverage
      const cov = repObj?.kpis || {};
      document.getElementById("mapCoverage").innerHTML =
        `Cidades atendidas: <b>${escapeHtml(String(cov.cidades_atendidas ?? "—"))}</b><br>` +
        `Estados atendidos: <b>${escapeHtml(String(cov.estados_atendidos ?? "—"))}</b><br>` +
        `Clientes atendidos: <b>${escapeHtml(String(cov.clientes_atendidos ?? "—"))}</b>`;

      // markers
      for (const c of cities){
        const b = getBin(c.vol || 0, bins);
        const popup =
          `<b>${escapeHtml(c.cidade)} - ${escapeHtml(c.uf)}</b><br>` +
          `Volume: ${escapeHtml(fmtUN(c.vol||0))}<br>` +
          `Faturamento: ${escapeHtml(fmtBRL(c.fat||0))}<br>` +
          `Clientes: ${escapeHtml((c.clientes||0).toLocaleString("pt-BR"))}`;

        const marker = L.circleMarker([c.lat, c.lon], {
          radius: 6,
          color: b.color,
          fillColor: b.color,
          fillOpacity: 0.85,
          weight: 1
        });

        marker.on("click", () => {
          lastCityKey = `${c.cidade}|||${c.uf}`;
          renderClientesCidade(repObj, c.cidade, c.uf);
        });

        marker.bindPopup(popup).addTo(leafletLayerGroup);
      }

      // top clients table (add Volume next to Faturamento)
      const tops = Array.isArray(mapObj.top_clients) ? mapObj.top_clients : [];
      const topRows = tops.slice(0,15).map(t => ({
        "Cliente": escapeHtml(t.cliente || ""),
        "Cidade": escapeHtml(t.cidade || ""),
        "UF": escapeHtml(t.uf || ""),
        "Volume": escapeHtml(fmtUN(t.volume || 0)),
        "Faturamento": escapeHtml(fmtBRL(t.faturamento || 0)),
      }));
      document.getElementById("tblTopClientes").innerHTML =
        topRows.length ? tableHtml(["Cliente","Cidade","UF","Volume","Faturamento"], topRows)
                       : `<div class="sub">Sem dados.</div>`;

      // if last city exists, keep it selected across rep change IF present
      if (lastCityKey){
        const [lc, lu] = lastCityKey.split("|||");
        const exists = cities.some(x => (x.cidade===lc && x.uf===lu));
        if (exists) renderClientesCidade(repObj, lc, lu);
        else {
          document.getElementById("cityHint").textContent = "Clique em um ponto no mapa.";
          document.getElementById("tblCityClientes").innerHTML = "";
        }
      } else {
        document.getElementById("cityHint").textContent = "Clique em um ponto no mapa.";
        document.getElementById("tblCityClientes").innerHTML = "";
      }

      // critical for GitHub Pages: ensure correct size after layout paint
      setTimeout(() => leafletMap.invalidateSize(true), 60);
    }

    function renderClientesCidade(repObj, cidade, uf){
      const mapObj = repObj?.mapa || {};
      const cityList = Array.isArray(mapObj.city_clients) ? mapObj.city_clients : [];
      const filtered = cityList.filter(x =>
        String(x.cidade||"") === String(cidade||"") && String(x.uf||"") === String(uf||"")
      );

      document.getElementById("cityHint").innerHTML =
        `Cidade selecionada: <b>${escapeHtml(cidade)} - ${escapeHtml(uf)}</b>`;

      const rows = filtered
        .slice()
        .sort((a,b)=>Number(b.faturamento||0)-Number(a.faturamento||0))
        .map(x => ({
          "Cliente": escapeHtml(x.cliente || ""),
          "Volume": escapeHtml(fmtUN(x.volume || 0)),
          "Faturamento": escapeHtml(fmtBRL(x.faturamento || 0)),
        }));

      document.getElementById("tblCityClientes").innerHTML =
        rows.length ? tableHtml(["Cliente","Volume","Faturamento"], rows)
                    : `<div class="sub">Sem clientes cadastrados para esta cidade no recorte.</div>`;
    }

    function renderClientesDist(repObj){
      const dist = repObj?.clientes_dist || {};
      const k = dist.kpis || {};
      const n80 = Number(k.n80 || 0);
      const clientes = Number(k.clientes || 0);
      const n80Ratio = clientes > 0 ? (n80 / clientes) : 0;

      const hhi = Number(k.hhi || 0);
      const top1 = Number(k.top1 || 0);
      const top3 = Number(k.top3 || 0);
      const top10 = Number(k.top10 || 0);

      const grid = document.getElementById("kpiDistGrid");
      grid.innerHTML = [
        kpiCard("N80", String(n80), badgeHtml(`${pct(n80Ratio,0)} da carteira`, `rgb(${getCssColor(colorForN80Ratio(n80Ratio))})`)),
        kpiCard("Índice de concentração", (k.hhi_label || "—"), badgeHtml(`HHI ${hhi.toFixed(3)}`, `rgb(${getCssColor(colorForHHI(hhi))})`)),
        kpiCard("Top 1 cliente", pct1(top1)),
        kpiCard("Top 3 clientes", pct1(top3)),
        kpiCard("Top 10 clientes", pct1(top10)),
      ].join("");

      // pie
      const pie = Array.isArray(dist.pie) ? dist.pie : [];
      const labels = pie.map(d => `${d.label} ${(Number(d.share||0)*100).toFixed(1)}%`);
      const vals = pie.map(d => Number(d.valor || 0));
      Plotly.newPlot("pieClientes", [{
        type:"pie",
        values: vals,
        labels: labels,
        hole: 0.00,
        textinfo:"none"
      }], {
        ...PLOT_LAYOUT_BASE,
        showlegend:false,
        margin:{l:10,r:10,t:10,b:10}
      }, {displayModeBar:false, responsive:true});

      // table top 15
      const tbl = Array.isArray(dist.table) ? dist.table : [];
      const rows = tbl.slice(0,15).map(r => ({
        "Cliente": escapeHtml(r.cliente||""),
        "Cidade": escapeHtml(r.cidade||""),
        "UF": escapeHtml(r.uf||""),
        "Faturamento": escapeHtml(fmtBRL(r.faturamento||0)),
        "% Faturamento": escapeHtml(pct1(r.share||0)),
        "Volume": escapeHtml(fmtUN(r.volume||0))
      }));
      document.getElementById("tblClientes").innerHTML =
        rows.length ? tableHtml(["Cliente","Cidade","UF","Faturamento","% Faturamento","Volume"], rows)
                    : `<div class="sub">Sem dados.</div>`;
    }

    function renderCarteira(repObj){
      const car = repObj?.carteira || {};
      const score = Number(car.score || 50);
      const label = car.label || "Neutra";
      const color = `rgb(${getCssColor(colorForCarteiraScore(score))})`;

      document.getElementById("carteiraScoreBox").innerHTML =
        `<h3>Pontuação – Saúde da carteira</h3>
         <div style="display:flex;align-items:baseline;gap:10px;flex-wrap:wrap">
           <div style="font-size:28px;font-weight:900">${Math.round(score)} / 100</div>
           ${badgeHtml(label, color)}
         </div>
         <div class="sub" style="margin-top:10px">
           A pontuação reflete a distribuição de receita entre os status (Novos/Crescendo/Estáveis/Caindo/Perdidos)
           no comparativo entre período atual e anterior.
         </div>`;

      // pie status
      const by = Array.isArray(car.status_counts) ? car.status_counts : [];
      const labelsPie = by.map(d => d.status);
      const valsPie = by.map(d => Number(d.clientes || 0));
      Plotly.newPlot("pieStatus", [{
        type:"pie",
        values: valsPie,
        labels: labelsPie,
        hole: 0.30,
        textinfo:"none"
      }], {
        ...PLOT_LAYOUT_BASE,
        showlegend:true,
        margin:{l:10,r:10,t:10,b:10}
      }, {displayModeBar:false, responsive:true});

      // table resumo
      const rows = by.map(d => ({
        "Status": escapeHtml(d.status || ""),
        "QtdClientes": escapeHtml(String(d.clientes || 0)),
        "%Clientes": escapeHtml(pct1(d.pct_clientes || 0)),
        "Faturamento (Δ)": escapeHtml(fmtBRL(Number(d.delta_fat || 0))),
      }));
      document.getElementById("tblCarteiraResumo").innerHTML =
        rows.length ? tableHtml(["Status","QtdClientes","%Clientes","Faturamento (Δ)"], rows)
                    : `<div class="sub">Sem dados.</div>`;
    }

    function renderStatusClientes(repObj){
      const block = document.getElementById("statusTables");
      const search = (document.getElementById("searchCliente").value || "").toLowerCase();

      const st = repObj?.status_clientes || {};
      let html = "";

      for (const statusName of STATUS_ORDER){
        const arr = Array.isArray(st[statusName]) ? st[statusName] : [];
        const filtered = search
          ? arr.filter(r => String(r.cliente||"").toLowerCase().includes(search))
          : arr;

        if (!filtered.length) continue;

        const rows = filtered
          .slice()
          .sort((a,b)=>Number(b.fat_atual||0)-Number(a.fat_atual||0))
          .map(r => {
            const fatA = Number(r.fat_atual||0);
            const fatP = Number(r.fat_prev||0);
            const volA = Number(r.vol_atual||0);
            const volP = Number(r.vol_prev||0);

            const dFat = fatA - fatP;
            const dVol = volA - volP;

            const pctFat = (fatP > 0) ? (dFat / fatP) : (fatA > 0 ? null : 0);
            const pctVol = (volP > 0) ? (dVol / volP) : (volA > 0 ? null : 0);

            const fmtPct = (x) => (x === null || Number.isNaN(x)) ? "Novo" : ((x>=0?"+":"") + (x*100).toFixed(1).replace(".",",") + "%");
            const fmtDeltaMoney = (x) => {
              const n = Number(x||0);
              const sign = n < 0 ? "-" : "";
              return sign + fmtBRL(Math.abs(n));
            };

            return {
              "Cliente": escapeHtml(r.cliente||""),
              "UF": escapeHtml(r.uf||""),
              "Cidade": escapeHtml(r.cidade||""),
              "Fat Atual": escapeHtml(fmtBRL(fatA)),
              "Fat Anterior": escapeHtml(fmtBRL(fatP)),
              "Δ Fat (R$)": escapeHtml(fmtDeltaMoney(dFat)),
              "% Fat": escapeHtml(fmtPct(pctFat)),
              "Vol Atual": escapeHtml(fmtUN(volA)),
              "Vol Anterior": escapeHtml(fmtUN(volP)),
              "Δ Vol": escapeHtml((Math.round(dVol)).toLocaleString("pt-BR") + " un"),
              "% Vol": escapeHtml(fmtPct(pctVol)),
            };
          });

        html += `<div style="margin:6px 0 10px;font-weight:900">${escapeHtml(statusName)}</div>`;
        html += `<div class="table-wrap">${tableHtml(
          ["Cliente","UF","Cidade","Fat Atual","Fat Anterior","Δ Fat (R$)","% Fat","Vol Atual","Vol Anterior","Δ Vol","% Vol"],
          rows
        )}</div>`;
        html += `<div style="height:12px"></div>`;
      }

      block.innerHTML = html || `<div class="sub">Sem clientes para exibir.</div>`;
    }

    // ---------- main render ----------
    function render(repName, currKey, prevKey){
      const repObj = DATA?.reports?.[repName]?.[currKey]?.[prevKey];
      if (!repObj){
        document.getElementById("headerSub").textContent = "Recorte não encontrado no JSON.";
        return;
      }

      const currLabel = repObj.meta?.curr_label || currKey;
      const prevLabel = repObj.meta?.prev_label || prevKey;

      renderHeader(repName, currLabel, prevLabel);
      renderKpis(repObj);
      renderEvolucao(repObj);
      renderCategorias(repObj, currLabel, prevLabel);
      renderMapa(repObj);
      renderClientesDist(repObj);
      renderCarteira(repObj);
      renderStatusClientes(repObj);
    }

    // ---------- selectors ----------
    function fillSelectors(){
      const repSel = document.getElementById("repSel");
      const currSel = document.getElementById("currLabel");
      const prevSel = document.getElementById("prevLabel");

      // reps
      const reps = DATA?.reps || Object.keys(DATA?.reports || {});
      repSel.innerHTML = reps.map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join("");

      // periods available per rep
      const setPeriodOptions = () => {
        const rep = repSel.value;
        const repNode = DATA?.reports?.[rep] || {};
        const currKeys = Object.keys(repNode);
        currSel.innerHTML = currKeys.map(k => `<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join("");

        const currKey = currSel.value || currKeys[0];
        const prevNode = repNode[currKey] || {};
        const prevKeys = Object.keys(prevNode);
        prevSel.innerHTML = prevKeys.map(k => `<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join("");
      };

      repSel.addEventListener("change", () => {
        setPeriodOptions();
        render(repSel.value, currSel.value, prevSel.value);
      });

      currSel.addEventListener("change", () => {
        // update prev list when curr changes
        const rep = repSel.value;
        const repNode = DATA?.reports?.[rep] || {};
        const prevNode = repNode[currSel.value] || {};
        const prevKeys = Object.keys(prevNode);
        prevSel.innerHTML = prevKeys.map(k => `<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join("");
        render(repSel.value, currSel.value, prevSel.value);
      });

      prevSel.addEventListener("change", () => {
        render(repSel.value, currSel.value, prevSel.value);
      });

      document.getElementById("btnPrint").addEventListener("click", () => window.print());
      document.getElementById("searchCliente").addEventListener("input", () => {
        renderStatusClientes(DATA?.reports?.[repSel.value]?.[currSel.value]?.[prevSel.value]);
      });

      setPeriodOptions();

      // default selections if provided
      if (DATA?.defaults?.rep && reps.includes(DATA.defaults.rep)) repSel.value = DATA.defaults.rep;
      setPeriodOptions();
      if (DATA?.defaults?.curr && currSel.querySelector(`option[value="${CSS.escape(DATA.defaults.curr)}"]`)) currSel.value = DATA.defaults.curr;
      // rebuild prev list based on curr
      const rep = repSel.value;
      const repNode = DATA?.reports?.[rep] || {};
      const prevNode = repNode[currSel.value] || {};
      const prevKeys = Object.keys(prevNode);
      prevSel.innerHTML = prevKeys.map(k => `<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join("");
      if (DATA?.defaults?.prev && prevSel.querySelector(`option[value="${CSS.escape(DATA.defaults.prev)}"]`)) prevSel.value = DATA.defaults.prev;

      render(repSel.value, currSel.value, prevSel.value);
    }

    async function loadJson(){
      let lastErr = null;
      for (const url of DATA_URLS){
        try{
          const r = await fetch(url, {cache:"no-store"});
          if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);
          const j = await r.json();
          return {json:j, url};
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("Falha ao carregar JSON.");
    }

    // boot
    (async function(){
      try{
        const {json, url} = await loadJson();
        DATA = json;
        console.log("[DATA] loaded from", url);
        fillSelectors();
      }catch(e){
        console.error(e);
        document.getElementById("headerSub").innerHTML =
          `<span style="color:rgba(239,68,68,0.95);font-weight:800">
            Erro ao carregar rep_reports.json:
          </span> ${escapeHtml(e.message || String(e))}<br>
          <span class="sub">Confirme se o arquivo existe em <code>./data/rep_reports.json</code> dentro de <code>/reports/</code>.</span>`;
      }
    })();
  </script>
</body>
</html>
