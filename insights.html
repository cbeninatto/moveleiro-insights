<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insights de Vendas</title>

  <!-- Fonts (similar to Streamlit / modern dashboards) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet 1.9.4 (required) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <!-- Papa Parse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      /* Streamlit-dark-ish tokens */
      --bg: #0e1117;
      --panel: #111827;
      --card: #0f172a;
      --card2: #111c33;
      --border: rgba(255,255,255,0.08);
      --border2: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --muted2: rgba(255,255,255,0.45);
      --accent: #22c55e;      /* green */
      --accent2: #60a5fa;     /* blue */
      --warn: #f59e0b;        /* orange */
      --danger: #ef4444;      /* red */
      --yellow: #facc15;      /* yellow */
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius2: 14px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html, body{
      height: 100%;
      margin:0;
      background: radial-gradient(1200px 700px at 30% -10%, rgba(96,165,250,0.12), transparent 60%),
                  radial-gradient(900px 600px at 80% 10%, rgba(34,197,94,0.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: var(--font);
    }

    /* Layout */
    .app{
      display:flex;
      min-height:100vh;
      width:100%;
    }

    .sidebar{
      width: 320px;
      min-width: 320px;
      padding: 18px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0));
      border-right: 1px solid var(--border);
      position: sticky;
      top:0;
      height: 100vh;
      overflow:auto;
    }

    .sidebarHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .sidebarTitle{
      font-weight: 700;
      letter-spacing: 0.2px;
      font-size: 14px;
      color: rgba(255,255,255,0.86);
    }
    .collapseBtn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.85);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-size: 12px;
    }
    .collapseBtn:hover{ background: rgba(255,255,255,0.06); }

    .sidebar.collapsed{
      width: 64px;
      min-width: 64px;
      padding: 18px 10px;
    }
    .sidebar.collapsed .sidebarBody,
    .sidebar.collapsed .sidebarTitleText{
      display:none;
    }

    .main{
      flex:1;
      padding: 22px 22px 60px 22px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Cards / sections */
    .section{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      margin-bottom: 18px;
    }

    .titleRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 6px;
    }
    h1{
      margin:0;
      font-size: 34px;
      letter-spacing: -0.6px;
      line-height: 1.1;
    }
    .subtitle{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
    }
    .metaLine{
      color: var(--muted2);
      font-size: 12px;
      font-family: var(--mono);
    }

    .grid{
      display:grid;
      gap: 14px;
    }

    /* KPIs top row: 5 columns */
    .kpiGrid{
      grid-template-columns: repeat(5, minmax(0, 1fr));
      align-items: stretch;
    }
    @media (max-width: 1200px){
      .kpiGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .kpiCard{
      background: linear-gradient(180deg, rgba(255,255,255,0.035), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      padding: 14px 14px 12px 14px;
      min-height: 92px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap: 8px;
      overflow: hidden; /* prevents ugly overflow */
    }
    .kpiLabel{
      font-size: 12.5px;
      color: rgba(255,255,255,0.75);
      font-weight: 600;
      letter-spacing: 0.2px;
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .kpiValue{
      font-size: 30px;
      line-height: 1.08;
      font-weight: 750;
      letter-spacing: -0.4px;
      white-space: normal;          /* allow wrap instead of cropping */
      overflow-wrap: anywhere;      /* never crop */
    }
    .kpiSub{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap: wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 650;
      background: rgba(34,197,94,0.12);
      color: rgba(34,197,94,0.98);
      border: 1px solid rgba(34,197,94,0.18);
    }
    .chip.neutral{
      background: rgba(96,165,250,0.12);
      color: rgba(96,165,250,0.98);
      border-color: rgba(96,165,250,0.18);
    }
    .chip.warn{
      background: rgba(245,158,11,0.14);
      color: rgba(245,158,11,0.98);
      border-color: rgba(245,158,11,0.22);
    }
    .chip.danger{
      background: rgba(239,68,68,0.14);
      color: rgba(239,68,68,0.98);
      border-color: rgba(239,68,68,0.22);
    }

    .sectionHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .sectionTitle{
      font-size: 18px;
      font-weight: 750;
      letter-spacing: -0.2px;
      margin:0;
    }
    .sectionNote{
      color: var(--muted);
      font-size: 12px;
      margin:0;
    }

    /* Two column layouts */
    .twoCol{
      display:grid;
      grid-template-columns: 1.8fr 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 1200px){
      .twoCol{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
    }

    /* Map */
    #map{
      width: 100%;
      height: 520px; /* taller */
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .mapLegend{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }
    .legendItem{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }
    .swatch{
      width: 12px;
      height: 12px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.25);
    }

    .rightStack{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .statsRow3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 2px;
    }
    .miniStat{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      border-radius: 14px;
      padding: 10px 10px 8px 10px;
    }
    .miniStatLabel{
      color: rgba(255,255,255,0.72);
      font-size: 12px;
      font-weight: 650;
      margin-bottom: 6px;
    }
    .miniStatValue{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.4px;
    }

    /* Tables */
    table{
      width:100%;
      border-collapse: collapse;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(0,0,0,0.12);
    }
    thead th{
      text-align:left;
      font-size: 12px;
      color: rgba(255,255,255,0.72);
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      font-weight: 750;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }
    tbody td{
      padding: 9px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size: 12.5px;
      color: rgba(255,255,255,0.86);
      vertical-align: top;
    }
    tbody tr:last-child td{ border-bottom: none; }

    .tdNum{
      font-family: var(--mono);
      white-space: nowrap; /* numeric columns never wrap */
    }

    /* avoid wrapping in specific tables unless needed */
    .noWrap td, .noWrap th { white-space: nowrap; }
    .allowWrap td.colWrap { white-space: normal; }

    /* Charts */
    .chart{
      width:100%;
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(255,255,255,0.02);
      padding: 10px;
    }
    .chartTall{ min-height: 520px; }
    .chartMed{ min-height: 380px; }

    .periodHeader{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      color: rgba(255,255,255,0.86);
      font-weight: 750;
    }
    .periodHeader small{
      color: var(--muted);
      font-weight: 600;
      font-family: var(--mono);
    }

    /* Status colors */
    .statusTag{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 750;
      font-size: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      white-space: nowrap;
    }
    .sNovos{ color: rgba(96,165,250,1); border-color: rgba(96,165,250,0.25); background: rgba(96,165,250,0.10); }
    .sCresc{ color: rgba(34,197,94,1); border-color: rgba(34,197,94,0.25); background: rgba(34,197,94,0.10); }
    .sEstab{ color: rgba(250,204,21,1); border-color: rgba(250,204,21,0.25); background: rgba(250,204,21,0.08); }
    .sCaind{ color: rgba(245,158,11,1); border-color: rgba(245,158,11,0.25); background: rgba(245,158,11,0.10); }
    .sPerd{  color: rgba(239,68,68,1); border-color: rgba(239,68,68,0.25); background: rgba(239,68,68,0.10); }

    /* Search input */
    .searchRow{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin: 8px 0 10px 0;
    }
    input[type="text"], select{
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.92);
      outline:none;
      font-size: 13px;
    }
    label{
      display:block;
      font-size: 12px;
      color: rgba(255,255,255,0.70);
      margin: 10px 0 6px 0;
      font-weight: 650;
      letter-spacing: 0.2px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .btn{
      width: 100%;
      margin-top: 12px;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(34,197,94,0.25);
      background: rgba(34,197,94,0.14);
      color: rgba(34,197,94,1);
      font-weight: 800;
      cursor:pointer;
      letter-spacing: 0.2px;
    }
    .btn:hover{ background: rgba(34,197,94,0.18); }

    .divider{
      height:1px;
      background: var(--border);
      margin: 14px 0;
    }

    /* Print */
    @page{
      size: A4 portrait;
      margin: 1.2cm;
    }
    @media print{
      body{
        background: #ffffff !important;
        color:#111 !important;
      }
      .app{ display:block; }
      .sidebar{ display:none !important; }
      .main{
        max-width: none;
        margin:0;
        padding:0;
      }
      .section{
        box-shadow:none;
        background:#fff !important;
        border: 1px solid #ddd !important;
        color:#111 !important;
      }
      .kpiCard, .miniStat{
        background:#fff !important;
        border:1px solid #ddd !important;
      }
      .kpiLabel, .sectionNote, .subtitle, .metaLine{ color:#333 !important; }
      table{ border-color:#ddd !important; background:#fff !important; }
      thead th{ background:#f5f5f5 !important; color:#222 !important; border-color:#ddd !important; }
      tbody td{ color:#111 !important; border-color:#eee !important; }

      /* enforce page layout */
      .pageBreak{
        page-break-before: always;
        break-before: page;
      }

      /* prevent awkward splits */
      .section{ break-inside: avoid; page-break-inside: avoid; }
      table{ break-inside: avoid; page-break-inside: avoid; }

      /* charts print background */
      .chart{ background:#fff !important; border-color:#ddd !important; }

      /* map prints nicely */
      #map{ border-color:#ddd !important; }
    }
  </style>
</head>

<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebarHeader">
      <div class="sidebarTitle">
        <span class="sidebarTitleText">Filtros</span>
      </div>
      <button class="collapseBtn" id="collapseBtn">⟷</button>
    </div>

    <div class="sidebarBody">
      <div class="metaLine">Dados do GitHub (auto-refresh)</div>

      <div class="divider"></div>

      <label for="repSelect">Representante</label>
      <select id="repSelect"></select>

      <div class="row2">
        <div>
          <label for="startMonth">Mês início</label>
          <select id="startMonth"></select>
        </div>
        <div>
          <label for="startYear">Ano início</label>
          <select id="startYear"></select>
        </div>
      </div>

      <div class="row2">
        <div>
          <label for="endMonth">Mês fim</label>
          <select id="endMonth"></select>
        </div>
        <div>
          <label for="endYear">Ano fim</label>
          <select id="endYear"></select>
        </div>
      </div>

      <button class="btn" id="applyBtn">Aplicar</button>

      <div class="divider"></div>
      <div class="metaLine" id="dataFreshness">Carregando…</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <!-- PAGE 1 -->
    <section class="section" id="titleSection">
      <div class="titleRow">
        <div>
          <h1>Insights de Vendas</h1>
          <div class="subtitle" id="titleSub">—</div>
        </div>
        <div class="metaLine" id="periodLine">—</div>
      </div>
    </section>

    <section class="section" id="kpiSection">
      <div class="grid kpiGrid" id="kpiGrid"></div>
    </section>

    <section class="section" id="highlightsSection">
      <div class="sectionHeader">
        <h2 class="sectionTitle">Destaques do período</h2>
        <p class="sectionNote">Melhor/pior mês em faturamento e volume (período selecionado)</p>
      </div>
      <div class="twoCol" style="grid-template-columns: 1fr 1fr;">
        <div class="kpiCard">
          <div class="kpiLabel">Faturamento</div>
          <div class="kpiValue" id="hiFat">—</div>
          <div class="kpiSub" id="hiFatSub">—</div>
        </div>
        <div class="kpiCard">
          <div class="kpiLabel">Volume</div>
          <div class="kpiValue" id="hiVol">—</div>
          <div class="kpiSub" id="hiVolSub">—</div>
        </div>
      </div>
    </section>

    <section class="section" id="mapSection">
      <div class="sectionHeader">
        <h2 class="sectionTitle">Mapa de Clientes</h2>
        <p class="sectionNote">Clique em uma cidade para ver a lista de clientes</p>
      </div>

      <div class="twoCol">
        <div>
          <div id="map"></div>
          <div class="mapLegend" id="mapLegend"></div>

          <div style="margin-top:12px;" id="cityDetailsWrap"></div>
        </div>

        <div class="rightStack">
          <div class="sectionHeader" style="margin-bottom: 6px;">
            <h3 class="sectionTitle" style="font-size:16px; margin:0;">Cobertura</h3>
            <p class="sectionNote" style="margin:0;">Resumo do período</p>
          </div>

          <div class="statsRow3">
            <div class="miniStat">
              <div class="miniStatLabel">Cidades atendidas</div>
              <div class="miniStatValue" id="covCities">—</div>
            </div>
            <div class="miniStat">
              <div class="miniStatLabel">Estados atendidos</div>
              <div class="miniStatValue" id="covStates">—</div>
            </div>
            <div class="miniStat">
              <div class="miniStatLabel">Clientes atendidos</div>
              <div class="miniStatValue" id="covClients">—</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="sectionHeader" style="margin-bottom: 8px;">
            <h3 class="sectionTitle" style="font-size:16px; margin:0;">Principais clientes</h3>
            <p class="sectionNote" style="margin:0;">Top 15 (sem scroll)</p>
          </div>
          <div id="topClientsTable"></div>
        </div>
      </div>
    </section>

    <section class="section" id="statesSection">
      <div class="sectionHeader">
        <h2 class="sectionTitle">Distribuição por estados</h2>
        <p class="sectionNote">Top 10 estados por faturamento – % do faturamento total</p>
      </div>

      <div class="chart chartTall" id="statesPie"></div>

      <div style="margin-top: 12px;">
        <div class="sectionHeader">
          <h3 class="sectionTitle" style="font-size:16px;">Principais cidades por faturamento</h3>
          <p class="sectionNote">Top cidades + Top 3 clientes (colunas separadas)</p>
        </div>
        <div id="topCitiesTable"></div>
      </div>

      <div style="margin-top: 12px;">
        <div class="sectionHeader">
          <h3 class="sectionTitle" style="font-size:16px;">Resumo – Top 10 estados</h3>
          <p class="sectionNote">Estado, Faturamento, % Faturamento, Volume, % Volume</p>
        </div>
        <div id="statesTable"></div>
      </div>
    </section>

    <!-- PAGE 2 -->
    <div class="pageBreak"></div>

    <section class="section" id="evolutionSection">
      <div class="sectionHeader">
        <h2 class="sectionTitle">Evolução – Faturamento x Volume</h2>
        <p class="sectionNote">Barras = Faturamento | Linha = Volume (un) | 2 eixos</p>
      </div>

      <div class="periodHeader" style="margin: 4px 0 8px 0;">
        <div id="curPeriodHdr">Período atual: — <small id="curTotals">—</small></div>
      </div>
      <div class="chart chartMed" id="evoCurrent"></div>

      <div class="periodHeader" style="margin: 14px 0 8px 0;">
        <div id="prevPeriodHdr">Período anterior: — <small id="prevTotals">—</small></div>
      </div>
      <div class="chart chartMed" id="evoPrev"></div>
    </section>

    <section class="section" id="categorySection">
      <div class="sectionHeader">
        <h2 class="sectionTitle">Categorias vendidas</h2>
        <p class="sectionNote">Participação e comparação com o período anterior</p>
      </div>

      <div class="twoCol" style="grid-template-columns: 1.2fr 1fr;">
        <div class="chart chartMed" id="catPie"></div>
        <div id="catTable"></div>
      </div>
    </section>

    <section class="section" id="clientsDistSection">
      <div class="sectionHeader">
        <h2 class="sectionTitle">Distribuição por clientes</h2>
        <p class="sectionNote">Participação dos clientes (Top 10 destacados) + Resumo detalhado</p>
      </div>

      <div class="twoCol" style="grid-template-columns: 1.2fr 1fr;">
        <div class="chart chartMed" id="clientsPie"></div>
        <div id="clientsSummaryTable"></div>
      </div>
    </section>

    <section class="section" id="healthSection">
      <div class="sectionHeader">
        <h2 class="sectionTitle">Saúde da carteira – Detalhes</h2>
        <p class="sectionNote" id="healthNote">
          A pontuação reflete a distribuição de receita entre os status (Novos/Crescendo/Estáveis/Caindo/Perdidos) no comparativo entre período atual e anterior.
        </p>
      </div>

      <div class="twoCol" style="grid-template-columns: 1fr 1fr;">
        <div class="kpiCard">
          <div class="kpiLabel">Saúde da carteira (score)</div>
          <div class="kpiValue" id="healthScore">—</div>
          <div class="kpiSub" id="healthChip">—</div>
        </div>
        <div class="kpiCard">
          <div class="kpiLabel">Distribuição por status</div>
          <div class="kpiValue" style="font-size: 18px; line-height: 1.3; font-weight: 700;" id="statusCountsLine">—</div>
          <div class="kpiSub" style="color: var(--muted); font-size: 12px;" id="statusCountsSub">—</div>
        </div>
      </div>

      <div style="margin-top: 14px;">
        <div class="sectionHeader">
          <h3 class="sectionTitle" style="font-size:16px;">Resumo por status</h3>
          <p class="sectionNote">Inclui variação de faturamento (R$) entre os períodos</p>
        </div>
        <div id="statusSummaryTable"></div>
        <p class="sectionNote" style="margin-top: 8px;">
          Observação: <b>Variação (R$)</b> = (Faturamento do período atual) − (Faturamento do período anterior). Valores positivos indicam crescimento; negativos indicam retração.
        </p>
      </div>
    </section>

    <!-- PAGE 3 -->
    <div class="pageBreak"></div>

    <section class="section" id="statusClientsSection">
      <div class="sectionHeader">
        <h2 class="sectionTitle">Status dos clientes</h2>
        <p class="sectionNote">Lista completa por status (sem scroll). Use a busca para filtrar.</p>
      </div>

      <div class="searchRow">
        <div style="flex:1; min-width: 240px;">
          <label for="clientSearch" style="margin-top:0;">Buscar cliente</label>
          <input id="clientSearch" type="text" placeholder="Digite parte do nome do cliente…" />
        </div>
      </div>

      <div id="statusTablesWrap"></div>
    </section>

  </main>
</div>

<script>
/* =======================
   CONFIG
======================= */
const URL_FATURAMENTO = "https://raw.githubusercontent.com/cbeninatto/performance-moveleiro-v2/refs/heads/main/data/relatorio_faturamento.csv";
const URL_CIDADES_GEO = "https://raw.githubusercontent.com/cbeninatto/performance-moveleiro-v2/main/data/cidades_br_geo.csv";

/* =======================
   HELPERS
======================= */
const MONTHS_PT = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];

function monthLabel(m){ return MONTHS_PT[(m-1+12)%12]; }

function pad2(n){ return String(n).padStart(2,"0"); }

function formatInt(n){
  const x = Number(n||0);
  return x.toLocaleString("pt-BR");
}

function formatVolume(n){
  return `${formatInt(n)} un`;
}

function formatBRL(n){
  const x = Number(n||0);
  return x.toLocaleString("pt-BR",{style:"currency", currency:"BRL"});
}

function formatPct(x){
  const v = Number(x||0);
  return (v*100).toLocaleString("pt-BR",{minimumFractionDigits:1, maximumFractionDigits:1}) + "%";
}

function yyyymm(ano, mes){
  return (ano*100) + mes;
}

function addMonths(ano, mes, delta){
  // mes 1..12
  let total = (ano*12 + (mes-1)) + delta;
  const newAno = Math.floor(total/12);
  const newMes = (total%12) + 1;
  return { ano:newAno, mes:newMes };
}

function monthsDiffInclusive(a1,m1,a2,m2){
  // inclusive number of months from start to end
  const start = a1*12 + (m1-1);
  const end = a2*12 + (m2-1);
  return (end - start) + 1;
}

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

/* =======================
   CSV LOAD + NORMALIZATION
======================= */
function normalizeHeader(h){
  return String(h||"").trim().toLowerCase()
    .replaceAll("ç","c")
    .replaceAll("ã","a")
    .replaceAll("á","a")
    .replaceAll("à","a")
    .replaceAll("â","a")
    .replaceAll("é","e")
    .replaceAll("ê","e")
    .replaceAll("í","i")
    .replaceAll("ó","o")
    .replaceAll("ô","o")
    .replaceAll("õ","o")
    .replaceAll("ú","u")
    .replaceAll("ü","u")
    .replaceAll(" ","")
    .replaceAll("_","");
}

function pickCol(map, candidates){
  for(const c of candidates){
    const key = normalizeHeader(c);
    if(map[key]) return map[key];
  }
  return null;
}

function buildHeaderMap(headers){
  const m = {};
  headers.forEach(h => { m[normalizeHeader(h)] = h; });
  return m;
}

async function fetchCSV(url){
  const bust = (url.includes("?") ? "&" : "?") + "v=" + Date.now();
  const res = await fetch(url + bust, { cache: "no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status} ao baixar CSV`);
  return await res.text();
}

function parseCSV(text){
  return new Promise((resolve, reject) => {
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      dynamicTyping: false,
      complete: (results) => resolve(results),
      error: (err) => reject(err),
    });
  });
}

/* =======================
   GLOBAL STATE
======================= */
let RAW = [];
let GEO = [];
let map = null;
let markersLayer = null;

let currentFiltered = [];
let prevFiltered = [];

let currentStatus = []; // per-client status rows

/* =======================
   UI POPULATE
======================= */
function setOptions(selectEl, values, selectedValue){
  selectEl.innerHTML = "";
  values.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.value;
    opt.textContent = v.label;
    if(String(v.value) === String(selectedValue)) opt.selected = true;
    selectEl.appendChild(opt);
  });
}

function uniqueSorted(arr){
  return Array.from(new Set(arr)).sort((a,b)=> (a>b?1:-1));
}

function getAvailableYears(data){
  return uniqueSorted(data.map(r => Number(r.Ano)).filter(n=>Number.isFinite(n)));
}

function getAvailableMonthsForYear(data, year){
  const months = data.filter(r=>Number(r.Ano)===Number(year)).map(r=>Number(r.Mes)).filter(n=>Number.isFinite(n));
  return uniqueSorted(months);
}

function repList(data){
  const reps = uniqueSorted(data.map(r => String(r.Representante||"").trim()).filter(Boolean));
  return ["Todos", ...reps];
}

/* =======================
   CORE COMPUTATIONS
======================= */
function filterByPeriod(data, rep, sAno, sMes, eAno, eMes){
  const s = yyyymm(sAno, sMes);
  const e = yyyymm(eAno, eMes);
  return data.filter(r => {
    const ano = Number(r.Ano), mes = Number(r.Mes);
    if(!Number.isFinite(ano) || !Number.isFinite(mes)) return false;
    const ym = yyyymm(ano, mes);
    if(ym < s || ym > e) return false;
    if(rep && rep !== "Todos"){
      return String(r.Representante||"").trim() === rep;
    }
    return true;
  });
}

function sumField(data, field){
  return data.reduce((acc,r)=> acc + (Number(r[field])||0), 0);
}

function groupBy(data, keyFn){
  const m = new Map();
  for(const r of data){
    const k = keyFn(r);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(r);
  }
  return m;
}

function aggMonthly(data){
  const m = new Map(); // ym -> {Ano,Mes,Valor,Quantidade}
  for(const r of data){
    const ano = Number(r.Ano), mes = Number(r.Mes);
    const ym = yyyymm(ano, mes);
    if(!m.has(ym)) m.set(ym, { Ano: ano, Mes: mes, Valor:0, Quantidade:0 });
    const o = m.get(ym);
    o.Valor += (Number(r.Valor)||0);
    o.Quantidade += (Number(r.Quantidade)||0);
  }
  return Array.from(m.values()).sort((a,b)=> yyyymm(a.Ano,a.Mes) - yyyymm(b.Ano,b.Mes));
}

function concentrationMetricsByClient(data){
  const byClient = groupBy(data, r => String(r.Cliente||"").trim());
  const arr = [];
  for(const [k, rows] of byClient.entries()){
    if(!k) continue;
    arr.push({
      Cliente: k,
      Valor: sumField(rows, "Valor"),
      Quantidade: sumField(rows, "Quantidade"),
      Cidade: String(rows[0].Cidade||""),
      Estado: String(rows[0].Estado||""),
    });
  }
  arr.sort((a,b)=> b.Valor - a.Valor);
  const total = arr.reduce((a,x)=> a+x.Valor, 0) || 1;

  // N80: number of clients to reach 80%
  let cum=0, n80=0;
  for(const x of arr){
    cum += x.Valor;
    n80++;
    if(cum/total >= 0.80) break;
  }

  // HHI (0..1)
  const hhi = arr.reduce((acc,x)=> {
    const s = x.Valor/total;
    return acc + s*s;
  }, 0);

  const top1 = arr[0] ? (arr[0].Valor/total) : 0;
  const top3 = arr.slice(0,3).reduce((a,x)=> a+x.Valor,0)/total;
  const top10 = arr.slice(0,10).reduce((a,x)=> a+x.Valor,0)/total;

  // qualitative label
  let concLabel = "Concentração moderada";
  if(hhi < 0.10) concLabel = "Baixa concentração";
  else if(hhi < 0.18) concLabel = "Concentração moderada";
  else concLabel = "Alta concentração";

  return { arr, total, n80, hhi, top1, top3, top10, concLabel };
}

function computePrevPeriod(sAno, sMes, eAno, eMes){
  const len = monthsDiffInclusive(sAno,sMes,eAno,eMes);
  // prev end = month before start
  const prevEnd = addMonths(sAno, sMes, -1);
  const prevStart = addMonths(prevEnd.ano, prevEnd.mes, -(len-1));
  return { sAno: prevStart.ano, sMes: prevStart.mes, eAno: prevEnd.ano, eMes: prevEnd.mes, len };
}

function statusByClient(cur, prev){
  const curMap = new Map();
  for(const r of cur){
    const c = String(r.Cliente||"").trim();
    if(!c) continue;
    if(!curMap.has(c)) curMap.set(c, { Cliente:c, Valor:0, Quantidade:0, Cidade:String(r.Cidade||""), Estado:String(r.Estado||"") });
    const o = curMap.get(c);
    o.Valor += (Number(r.Valor)||0);
    o.Quantidade += (Number(r.Quantidade)||0);
    if(!o.Cidade) o.Cidade = String(r.Cidade||"");
    if(!o.Estado) o.Estado = String(r.Estado||"");
  }

  const prevMap = new Map();
  for(const r of prev){
    const c = String(r.Cliente||"").trim();
    if(!c) continue;
    if(!prevMap.has(c)) prevMap.set(c, { Cliente:c, Valor:0, Quantidade:0, Cidade:String(r.Cidade||""), Estado:String(r.Estado||"") });
    const o = prevMap.get(c);
    o.Valor += (Number(r.Valor)||0);
    o.Quantidade += (Number(r.Quantidade)||0);
    if(!o.Cidade) o.Cidade = String(r.Cidade||"");
    if(!o.Estado) o.Estado = String(r.Estado||"");
  }

  const allClients = new Set([...curMap.keys(), ...prevMap.keys()]);
  const rows = [];
  for(const c of allClients){
    const A = curMap.get(c) || { Cliente:c, Valor:0, Quantidade:0, Cidade:"", Estado:"" };
    const B = prevMap.get(c) || { Cliente:c, Valor:0, Quantidade:0, Cidade:"", Estado:"" };

    const curV = A.Valor||0, prevV = B.Valor||0;
    let status = "Estáveis";

    if(prevV === 0 && curV > 0) status = "Novos";
    else if(curV === 0 && prevV > 0) status = "Perdidos";
    else {
      const ratio = prevV === 0 ? 999 : (curV/prevV);
      if(ratio >= 1.15) status = "Crescendo";
      else if(ratio <= 0.85) status = "Caindo";
      else status = "Estáveis";
    }

    rows.push({
      Status: status,
      Cliente: c,
      Cidade: A.Cidade || B.Cidade || "",
      Estado: A.Estado || B.Estado || "",
      VolumeAtual: A.Quantidade||0,
      VolumeAnterior: B.Quantidade||0,
      FaturamentoAtual: curV,
      FaturamentoAnterior: prevV,
      Variacao: curV - prevV
    });
  }

  // order by status priority
  const order = { "Novos":1, "Crescendo":2, "Estáveis":3, "Caindo":4, "Perdidos":5 };
  rows.sort((a,b)=>{
    const oa = order[a.Status]||99, ob = order[b.Status]||99;
    if(oa !== ob) return oa - ob;
    return (b.FaturamentoAtual - a.FaturamentoAtual);
  });

  return rows;
}

function computeCarteiraScore(statusRows){
  // Weighted by faturamento share: good statuses push up, bad push down
  const weights = {
    "Novos": 0.8,
    "Crescendo": 1.2,
    "Estáveis": 1.0,
    "Caindo": -0.8,
    "Perdidos": -1.2
  };
  const totalCur = statusRows.reduce((a,r)=> a + (r.FaturamentoAtual||0), 0) || 1;
  const contrib = statusRows.reduce((a,r)=>{
    const w = weights[r.Status] ?? 0;
    const share = (r.FaturamentoAtual||0)/totalCur;
    return a + (w * share);
  }, 0);

  // Map contrib roughly into 0..100
  // contrib ~ [-1.2..1.2] => score ~ [0..100]
  let score = 50 + (contrib * 35);
  score = clamp(score, 0, 100);

  let label = "Neutra";
  if(score >= 70) label = "Saudável";
  else if(score >= 55) label = "Neutra";
  else if(score >= 40) label = "Atenção";
  else label = "Crítica";

  return { score: Math.round(score), label };
}

/* =======================
   MAP (Leaflet)
======================= */
function normalizeGeoRows(geo){
  // Accept many possible column names
  // Need: Estado/UF, Cidade, lat, lon
  if(!geo.length) return [];

  const headers = Object.keys(geo[0]);
  const mapH = buildHeaderMap(headers);

  const colUF = pickCol(mapH, ["UF","Estado","Estado/UF","SiglaUF","uf","estado"]);
  const colCidade = pickCol(mapH, ["Cidade","Municipio","Município","cidade","municipio"]);
  const colLat = pickCol(mapH, ["lat","latitude","Latitude","LAT"]);
  const colLon = pickCol(mapH, ["lon","lng","longitude","Longitude","LON","Long"]);

  if(!colUF || !colCidade || !colLat || !colLon){
    throw new Error("cidades_br_geo.csv must contain Estado/UF, Cidade, lat, lon columns (names can vary).");
  }

  return geo.map(r => ({
    UF: String(r[colUF]||"").trim().toUpperCase(),
    Cidade: String(r[colCidade]||"").trim().toUpperCase(),
    lat: Number(String(r[colLat]||"").replace(",", ".")),
    lon: Number(String(r[colLon]||"").replace(",", "."))
  })).filter(x => x.UF && x.Cidade && Number.isFinite(x.lat) && Number.isFinite(x.lon));
}

function colorForValue(v, vmin, vmax){
  // Inverted to match your request: Green = higher, Red = lower
  if(vmax <= vmin) return "#22c55e";
  const t = (v - vmin) / (vmax - vmin);
  // interpolate red->orange->yellow->green (t:0..1)
  const stops = [
    {t:0.00, c:[239,68,68]},   // red
    {t:0.35, c:[245,158,11]},  // orange
    {t:0.65, c:[250,204,21]},  // yellow
    {t:1.00, c:[34,197,94]},   // green
  ];
  let a=stops[0], b=stops[stops.length-1];
  for(let i=0;i<stops.length-1;i++){
    if(t>=stops[i].t && t<=stops[i+1].t){ a=stops[i]; b=stops[i+1]; break; }
  }
  const u = (t - a.t) / (b.t - a.t);
  const r = Math.round(a.c[0] + (b.c[0]-a.c[0])*u);
  const g = Math.round(a.c[1] + (b.c[1]-a.c[1])*u);
  const bl = Math.round(a.c[2] + (b.c[2]-a.c[2])*u);
  return `rgb(${r},${g},${bl})`;
}

function buildMapLegend(vmin, vmax){
  const ranges = [
    { label: "Baixo", t: 0.00 },
    { label: "Médio", t: 0.50 },
    { label: "Alto",  t: 1.00 },
  ];
  const el = document.getElementById("mapLegend");
  el.innerHTML = "";
  ranges.forEach(r => {
    const v = vmin + (vmax-vmin)*r.t;
    const item = document.createElement("div");
    item.className = "legendItem";
    const sw = document.createElement("div");
    sw.className = "swatch";
    sw.style.background = colorForValue(v, vmin, vmax);
    item.appendChild(sw);
    const txt = document.createElement("div");
    txt.textContent = r.label;
    item.appendChild(txt);
    el.appendChild(item);
  });
  const note = document.createElement("div");
  note.className = "legendItem";
  note.textContent = "Cores: vermelho = menor | verde = maior";
  el.appendChild(note);
}

function initMap(){
  if(map) return;
  map = L.map("map", { zoomControl: true }).setView([-14.2350, -51.9253], 4);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}

function renderMap(filtered){
  initMap();
  markersLayer.clearLayers();

  // group by city+UF
  const byCity = new Map();
  for(const r of filtered){
    const uf = String(r.Estado||"").trim().toUpperCase();
    const city = String(r.Cidade||"").trim().toUpperCase();
    if(!uf || !city) continue;
    const key = uf + "||" + city;
    if(!byCity.has(key)) byCity.set(key, { UF:uf, Cidade:city, Valor:0, Quantidade:0, Rows:[] });
    const o = byCity.get(key);
    o.Valor += (Number(r.Valor)||0);
    o.Quantidade += (Number(r.Quantidade)||0);
    o.Rows.push(r);
  }

  // join with geo
  const geoMap = new Map();
  for(const g of GEO){
    geoMap.set(g.UF+"||"+g.Cidade, g);
  }

  const points = [];
  for(const [k, v] of byCity.entries()){
    const g = geoMap.get(k);
    if(!g) continue;
    points.push({ ...v, lat:g.lat, lon:g.lon });
  }

  // bounds
  if(points.length){
    const latlngs = points.map(p => [p.lat, p.lon]);
    map.fitBounds(latlngs, { padding:[40,40] });
  } else {
    map.setView([-14.2350, -51.9253], 4);
  }

  const vals = points.map(p=>p.Valor);
  const vmin = vals.length ? Math.min(...vals) : 0;
  const vmax = vals.length ? Math.max(...vals) : 1;

  buildMapLegend(vmin, vmax);

  points.forEach(p=>{
    const color = colorForValue(p.Valor, vmin, vmax);
    const marker = L.circleMarker([p.lat,p.lon],{
      radius: 8,
      fillColor: color,
      fillOpacity: 0.9,
      color: "rgba(0,0,0,0.35)",
      weight: 1
    });

    const popupHtml =
      `<div style="font-family: ${getComputedStyle(document.body).fontFamily};">
        <div style="font-weight:800; margin-bottom:4px;">${p.Cidade} - ${p.UF}</div>
        <div style="color:#111; font-size:12px;">
          <div><b>Faturamento:</b> ${formatBRL(p.Valor)}</div>
          <div><b>Volume:</b> ${formatVolume(p.Quantidade)}</div>
          <div style="margin-top:6px; font-size:11px;">Clique para ver clientes</div>
        </div>
      </div>`;

    marker.bindPopup(popupHtml);
    marker.on("click", ()=>{
      renderCityDetails(p);
    });
    marker.addTo(markersLayer);
  });
}

function renderCityDetails(cityAgg){
  // table: Cliente, Quantidade, Faturamento
  const rows = cityAgg.Rows.slice();
  const byClient = groupBy(rows, r => String(r.Cliente||"").trim());
  const arr = [];
  for(const [c, rs] of byClient.entries()){
    if(!c) continue;
    arr.push({
      Cliente: c,
      Quantidade: sumField(rs,"Quantidade"),
      Faturamento: sumField(rs,"Valor")
    });
  }
  arr.sort((a,b)=> b.Faturamento - a.Faturamento);

  const wrap = document.getElementById("cityDetailsWrap");
  const id = "cityDetails";
  wrap.innerHTML = `
    <div class="sectionHeader" style="margin: 6px 0 8px 0;">
      <h3 class="sectionTitle" style="font-size:16px;">Clientes em ${cityAgg.Cidade} - ${cityAgg.UF}</h3>
      <p class="sectionNote">Lista completa</p>
    </div>
    <table class="noWrap">
      <thead>
        <tr>
          <th>Cliente</th>
          <th style="text-align:center;">Quantidade</th>
          <th style="text-align:center;">Faturamento</th>
        </tr>
      </thead>
      <tbody>
        ${arr.map(r=>`
          <tr>
            <td class="colWrap" style="white-space:normal;">${escapeHtml(r.Cliente)}</td>
            <td class="tdNum" style="text-align:left;">${formatVolume(r.Quantidade)}</td>
            <td class="tdNum" style="text-align:left;">${formatBRL(r.Faturamento)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

/* =======================
   PLOTLY THEMING
======================= */
function plotlyLayoutBase(title){
  return {
    title: { text: title||"", font:{color:"rgba(255,255,255,0.86)", size:14}, x:0.02 },
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)",
    font: { color: "rgba(255,255,255,0.86)", family: "Inter, sans-serif" },
    margin: { l: 56, r: 56, t: 44, b: 40 },
    legend: { orientation: "h", y: -0.18, x: 0, font:{size:11} },
    xaxis: { gridcolor: "rgba(255,255,255,0.08)", zerolinecolor:"rgba(255,255,255,0.12)" },
    yaxis: { gridcolor: "rgba(255,255,255,0.08)", zerolinecolor:"rgba(255,255,255,0.12)" },
  };
}

/* =======================
   RENDERING
======================= */
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function buildKpis(repName, cur, prevInfo, conc, health){
  const total = sumField(cur, "Valor");
  const vol = sumField(cur, "Quantidade");
  const months = aggMonthly(cur).length || 1;
  const avg = total / months;

  const clients = uniqueSorted(cur.map(r=>String(r.Cliente||"").trim()).filter(Boolean)).length;

  // Distribuição label
  const distLabel = conc.concLabel;

  const healthChipClass = (health.label==="Saudável") ? "chip" :
                          (health.label==="Neutra") ? "chip neutral" :
                          (health.label==="Atenção") ? "chip warn" : "chip danger";

  const kpis = [
    { label:"Total período", value: formatBRL(total), sub: `<span class="metaLine">${formatVolume(vol)}</span>` },
    { label:"Média mensal", value: formatBRL(avg), sub: `<span class="metaLine">${months} meses com venda</span>` },
    { label:"Distribuição por clientes", value: distLabel, sub: `<span class="chip">N80: ${conc.n80} clientes</span>` },
    { label:"Saúde da carteira", value: `${health.score} / 100`, sub: `<span class="${healthChipClass}">↑ ${health.label}</span>` },
    { label:"Clientes atendidos", value: formatInt(clients), sub: `<span class="metaLine">únicos no período</span>` },
  ];

  const grid = document.getElementById("kpiGrid");
  grid.innerHTML = kpis.map(k=>`
    <div class="kpiCard">
      <div class="kpiLabel">${k.label}</div>
      <div class="kpiValue">${k.value}</div>
      <div class="kpiSub">${k.sub||""}</div>
    </div>
  `).join("");
}

function renderHighlights(monthly){
  if(!monthly.length){
    document.getElementById("hiFat").textContent = "—";
    document.getElementById("hiVol").textContent = "—";
    return;
  }
  // best/worst by Valor and Quantidade
  const bestFat = monthly.reduce((a,b)=> (b.Valor>a.Valor?b:a), monthly[0]);
  const worstFat = monthly.reduce((a,b)=> (b.Valor<a.Valor?b:a), monthly[0]);
  const bestVol = monthly.reduce((a,b)=> (b.Quantidade>a.Quantidade?b:a), monthly[0]);
  const worstVol = monthly.reduce((a,b)=> (b.Quantidade<a.Quantidade?b:a), monthly[0]);

  const bfLbl = `${monthLabel(bestFat.Mes)} ${String(bestFat.Ano).slice(-2)}`;
  const wfLbl = `${monthLabel(worstFat.Mes)} ${String(worstFat.Ano).slice(-2)}`;
  const bvLbl = `${monthLabel(bestVol.Mes)} ${String(bestVol.Ano).slice(-2)}`;
  const wvLbl = `${monthLabel(worstVol.Mes)} ${String(worstVol.Ano).slice(-2)}`;

  document.getElementById("hiFat").textContent = `Melhor: ${bfLbl}`;
  document.getElementById("hiFatSub").innerHTML = `
    <span class="chip">↑ ${formatBRL(bestFat.Valor)}</span>
    <span class="chip danger">↓ ${wfLbl}: ${formatBRL(worstFat.Valor)}</span>
  `;

  document.getElementById("hiVol").textContent = `Melhor: ${bvLbl}`;
  document.getElementById("hiVolSub").innerHTML = `
    <span class="chip">↑ ${formatVolume(bestVol.Quantidade)}</span>
    <span class="chip danger">↓ ${wvLbl}: ${formatVolume(worstVol.Quantidade)}</span>
  `;
}

function renderCoverage(cur){
  const cities = uniqueSorted(cur.map(r=>String(r.Cidade||"").trim()).filter(Boolean)).length;
  const states = uniqueSorted(cur.map(r=>String(r.Estado||"").trim()).filter(Boolean)).length;
  const clients = uniqueSorted(cur.map(r=>String(r.Cliente||"").trim()).filter(Boolean)).length;

  document.getElementById("covCities").textContent = formatInt(cities);
  document.getElementById("covStates").textContent = formatInt(states);
  document.getElementById("covClients").textContent = formatInt(clients);
}

function renderTopClients(cur){
  const byClient = concentrationMetricsByClient(cur).arr.slice(0,15);
  const html = `
    <table class="noWrap allowWrap">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Cidade</th>
          <th>Estado</th>
          <th>Faturamento</th>
        </tr>
      </thead>
      <tbody>
        ${byClient.map(r=>`
          <tr>
            <td class="colWrap" style="white-space:normal;">${escapeHtml(r.Cliente)}</td>
            <td class="colWrap" style="white-space:normal;">${escapeHtml(r.Cidade||"")}</td>
            <td class="tdNum">${escapeHtml(r.Estado||"")}</td>
            <td class="tdNum">${formatBRL(r.Valor)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  document.getElementById("topClientsTable").innerHTML = html;
}

function renderStatesPieAndTables(cur){
  // top 10 states by faturamento
  const byUF = groupBy(cur, r=>String(r.Estado||"").trim().toUpperCase());
  const arr = [];
  for(const [uf, rows] of byUF.entries()){
    if(!uf) continue;
    arr.push({
      Estado: uf,
      Valor: sumField(rows,"Valor"),
      Volume: sumField(rows,"Quantidade"),
      Rows: rows
    });
  }
  arr.sort((a,b)=> b.Valor-a.Valor);
  const total = arr.reduce((a,x)=>a+x.Valor,0) || 1;
  const totalVol = arr.reduce((a,x)=>a+x.Volume,0) || 1;

  const top10 = arr.slice(0,10);
  const rest = arr.slice(10);
  const restVal = rest.reduce((a,x)=>a+x.Valor,0);
  const restVol = rest.reduce((a,x)=>a+x.Volume,0);

  const labels = top10.map(x=>x.Estado).concat(restVal>0?["Outros"]:[]);
  const values = top10.map(x=>x.Valor).concat(restVal>0?[restVal]:[]);
  const perc = top10.map(x=>x.Valor/total).concat(restVal>0?[restVal/total]:[]);

  // show inside labels only if slice >= 6%
  const text = labels.map((lab,i)=>{
    const p = perc[i] || 0;
    if(p >= 0.06) return `${lab}<br>${formatPct(p)}`;
    return "";
  });

  const data = [{
    type:"pie",
    labels,
    values,
    text,
    textinfo:"text",
    textposition:"inside",
    insidetextorientation:"radial",
    hovertemplate:"%{label}<br>%{value:,.0f} (R$)<br>%{percent}<extra></extra>",
    sort:false,
    direction:"clockwise",
    marker:{ line:{color:"rgba(0,0,0,0.15)", width:1} },
    showlegend:false
  }];

  const layout = plotlyLayoutBase("");
  layout.margin = { l: 12, r: 12, t: 12, b: 12 };

  Plotly.newPlot("statesPie", data, layout, {displayModeBar:false, responsive:true});

  // Table: Resumo – Top 10 estados
  const statesTableHtml = `
    <table class="noWrap">
      <thead>
        <tr>
          <th>Estado</th>
          <th>Faturamento</th>
          <th>% Faturamento</th>
          <th>Volume</th>
          <th>% Volume</th>
        </tr>
      </thead>
      <tbody>
        ${top10.map(x=>`
          <tr>
            <td class="tdNum">${escapeHtml(x.Estado)}</td>
            <td class="tdNum">${formatBRL(x.Valor)}</td>
            <td class="tdNum">${formatPct(x.Valor/total)}</td>
            <td class="tdNum">${formatVolume(x.Volume)}</td>
            <td class="tdNum">${formatPct(x.Volume/totalVol)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  document.getElementById("statesTable").innerHTML = statesTableHtml;

  // Top cities by faturamento + top 3 clients (separate columns)
  const byCity = new Map(); // key UF||Cidade
  for(const r of cur){
    const uf = String(r.Estado||"").trim().toUpperCase();
    const city = String(r.Cidade||"").trim().toUpperCase();
    if(!uf || !city) continue;
    const key = uf+"||"+city;
    if(!byCity.has(key)) byCity.set(key, { Estado:uf, Cidade:city, Valor:0, Volume:0, Rows:[] });
    const o = byCity.get(key);
    o.Valor += (Number(r.Valor)||0);
    o.Volume += (Number(r.Quantidade)||0);
    o.Rows.push(r);
  }
  const cityArr = Array.from(byCity.values()).sort((a,b)=> b.Valor - a.Valor).slice(0,20);

  // build top 3 clients columns
  const rowsHtml = cityArr.map(city=>{
    const byC = groupBy(city.Rows, r=>String(r.Cliente||"").trim());
    const carr = [];
    for(const [c, rs] of byC.entries()){
      if(!c) continue;
      carr.push({ Cliente:c, Valor: sumField(rs,"Valor") });
    }
    carr.sort((a,b)=> b.Valor - a.Valor);
    const t1 = carr[0] ? `${carr[0].Cliente} (${formatBRL(carr[0].Valor)})` : "";
    const t2 = carr[1] ? `${carr[1].Cliente} (${formatBRL(carr[1].Valor)})` : "";
    const t3 = carr[2] ? `${carr[2].Cliente} (${formatBRL(carr[2].Valor)})` : "";

    return `
      <tr>
        <td class="colWrap" style="white-space:normal;">${escapeHtml(city.Cidade)}</td>
        <td class="tdNum">${escapeHtml(city.Estado)}</td>
        <td class="tdNum">${formatBRL(city.Valor)}</td>
        <td class="tdNum">${formatVolume(city.Volume)}</td>
        <td class="tdNum">${formatPct(city.Volume/totalVol)}</td>
        <td class="colWrap" style="white-space:normal;">${escapeHtml(t1)}</td>
        <td class="colWrap" style="white-space:normal;">${escapeHtml(t2)}</td>
        <td class="colWrap" style="white-space:normal;">${escapeHtml(t3)}</td>
      </tr>
    `;
  }).join("");

  const topCitiesHtml = `
    <table class="allowWrap">
      <thead>
        <tr>
          <th>Cidade</th>
          <th>Estado</th>
          <th>Faturamento</th>
          <th>Volume</th>
          <th>% Volume</th>
          <th>Top 1 cliente (R$)</th>
          <th>Top 2 cliente (R$)</th>
          <th>Top 3 cliente (R$)</th>
        </tr>
      </thead>
      <tbody>
        ${rowsHtml}
      </tbody>
    </table>
  `;
  document.getElementById("topCitiesTable").innerHTML = topCitiesHtml;
}

function renderEvolution(curMonthly, prevMonthly, curLabel, prevLabel, curTotalsText, prevTotalsText){
  document.getElementById("curPeriodHdr").childNodes[0].textContent = `Período atual: ${curLabel} `;
  document.getElementById("prevPeriodHdr").childNodes[0].textContent = `Período anterior: ${prevLabel} `;

  document.getElementById("curTotals").textContent = curTotalsText;
  document.getElementById("prevTotals").textContent = prevTotalsText;

  function makeEvoChart(divId, monthly){
    const x = monthly.map(r => monthLabel(r.Mes));
    const fatur = monthly.map(r => r.Valor);
    const vol = monthly.map(r => r.Quantidade);

    const bars = {
      type: "bar",
      x,
      y: fatur,
      name: "Faturamento",
      marker: { color: "rgba(96,165,250,0.85)" },
      yaxis: "y1",
      hovertemplate: "%{x}<br>Faturamento: %{y:,.0f}<extra></extra>"
    };
    const line = {
      type: "scatter",
      mode: "lines+markers",
      x,
      y: vol,
      name: "Volume (un)",
      line: { color: "rgba(34,197,94,0.95)", width: 3 }, /* 2pt+ feel */
      marker: { color: "rgba(34,197,94,0.95)", size: 7 },
      yaxis: "y2",
      hovertemplate: "%{x}<br>Volume: %{y:,.0f} un<extra></extra>"
    };

    const layout = plotlyLayoutBase("");
    layout.barmode = "overlay";
    layout.yaxis = { title: "Faturamento (R$)", gridcolor: "rgba(255,255,255,0.08)" };
    layout.yaxis2 = { title: "Volume (un)", overlaying: "y", side: "right", showgrid: false };
    layout.xaxis = { title: "", tickmode: "array", tickvals: x, ticktext: x };
    layout.margin = { l: 62, r: 62, t: 18, b: 44 };
    layout.legend = { orientation:"h", y: -0.25, x: 0 };

    Plotly.newPlot(divId, [bars, line], layout, {displayModeBar:false, responsive:true});
  }

  makeEvoChart("evoCurrent", curMonthly);
  makeEvoChart("evoPrev", prevMonthly);
}

function renderCategory(cur, prev){
  const byCatCur = groupBy(cur, r=>String(r.Categoria||"").trim());
  const byCatPrev = groupBy(prev, r=>String(r.Categoria||"").trim());

  const arr = [];
  for(const [cat, rows] of byCatCur.entries()){
    if(!cat) continue;
    const vCur = sumField(rows,"Valor");
    const vPrev = byCatPrev.has(cat) ? sumField(byCatPrev.get(cat),"Valor") : 0;
    arr.push({ Categoria: cat, Valor: vCur, Prev: vPrev, Variacao: vCur - vPrev });
  }
  // include cats that exist only in prev
  for(const [cat, rows] of byCatPrev.entries()){
    if(!cat) continue;
    if(arr.find(x=>x.Categoria===cat)) continue;
    const vPrev = sumField(rows,"Valor");
    arr.push({ Categoria: cat, Valor: 0, Prev: vPrev, Variacao: 0 - vPrev });
  }

  arr.sort((a,b)=> b.Valor - a.Valor);
  const total = arr.reduce((a,x)=> a+x.Valor,0) || 1;

  const top = arr.slice(0,10);
  const rest = arr.slice(10);
  const restVal = rest.reduce((a,x)=>a+x.Valor,0);

  const labels = top.map(x=>x.Categoria).concat(restVal>0?["Outros"]:[]);
  const values = top.map(x=>x.Valor).concat(restVal>0?[restVal]:[]);
  const perc = top.map(x=>x.Valor/total).concat(restVal>0?[restVal/total]:[]);

  const text = labels.map((lab,i)=>{
    const p = perc[i] || 0;
    if(p >= 0.08) return `${lab}<br>${formatPct(p)}`;
    return "";
  });

  Plotly.newPlot("catPie", [{
    type:"pie",
    labels, values,
    text,
    textinfo:"text",
    textposition:"inside",
    insidetextorientation:"radial",
    sort:false,
    showlegend:false,
    hovertemplate:"%{label}<br>%{value:,.0f} (R$)<br>%{percent}<extra></extra>"
  }], {
    ...plotlyLayoutBase(""),
    margin:{l:12,r:12,t:12,b:12}
  }, {displayModeBar:false, responsive:true});

  const tableHtml = `
    <table class="allowWrap">
      <thead>
        <tr>
          <th>Categoria</th>
          <th>Valor</th>
          <th>%</th>
          <th>Variação (R$)</th>
        </tr>
      </thead>
      <tbody>
        ${arr.map(x=>`
          <tr>
            <td class="colWrap" style="white-space:normal;">${escapeHtml(x.Categoria)}</td>
            <td class="tdNum">${formatBRL(x.Valor)}</td>
            <td class="tdNum">${formatPct((x.Valor||0)/total)}</td>
            <td class="tdNum">${formatBRL(x.Variacao)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  document.getElementById("catTable").innerHTML = tableHtml;
}

function renderClientsDistribution(cur){
  const cm = concentrationMetricsByClient(cur);
  const total = cm.total || 1;

  // Top 10 + Outros
  const top = cm.arr.slice(0,10);
  const rest = cm.arr.slice(10);
  const restVal = rest.reduce((a,x)=>a+x.Valor,0);

  const labels = top.map(x=>x.Cliente).concat(restVal>0?["Outros"]:[]);
  const values = top.map(x=>x.Valor).concat(restVal>0?[restVal]:[]);
  const perc = labels.map((_,i)=> (values[i]||0)/total);

  // inside labels only for larger slices
  const text = labels.map((lab,i)=>{
    const p = perc[i] || 0;
    if(p >= 0.10 || lab==="Outros") return `${lab}<br>${formatPct(p)}`;
    return "";
  });

  Plotly.newPlot("clientsPie", [{
    type:"pie",
    labels,
    values,
    text,
    textinfo:"text",
    textposition:"inside",
    insidetextorientation:"radial",
    sort:false,
    showlegend:false,
    hovertemplate:"%{label}<br>%{value:,.0f} (R$)<br>%{percent}<extra></extra>"
  }], {
    ...plotlyLayoutBase(""),
    margin:{l:12,r:12,t:12,b:12}
  }, {displayModeBar:false, responsive:true});

  // Summary table (no scroll)
  const totalVol = cm.arr.reduce((a,x)=> a + (x.Quantidade||0), 0) || 1;
  let cum = 0;

  const tableRows = cm.arr.slice(0,25).map((x, idx)=>{
    const share = x.Valor/total;
    cum += share;
    return {
      Cliente: x.Cliente,
      Faturamento: x.Valor,
      PFat: share,
      Volume: x.Quantidade||0,
      PVol: (x.Quantidade||0)/totalVol,
      Acum: cum
    };
  });

  const html = `
    <table class="allowWrap">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Faturamento</th>
          <th>% Fat.</th>
          <th>Volume</th>
          <th>% Vol.</th>
          <th>Acum. %</th>
        </tr>
      </thead>
      <tbody>
        ${tableRows.map(r=>`
          <tr>
            <td class="colWrap" style="white-space:normal;">${escapeHtml(r.Cliente)}</td>
            <td class="tdNum">${formatBRL(r.Faturamento)}</td>
            <td class="tdNum">${formatPct(r.PFat)}</td>
            <td class="tdNum">${formatVolume(r.Volume)}</td>
            <td class="tdNum">${formatPct(r.PVol)}</td>
            <td class="tdNum">${formatPct(r.Acum)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  document.getElementById("clientsSummaryTable").innerHTML = html;
}

function renderHealth(statusRows, health){
  document.getElementById("healthScore").textContent = `${health.score} / 100`;

  const chipClass = (health.label==="Saudável") ? "chip" :
                    (health.label==="Neutra") ? "chip neutral" :
                    (health.label==="Atenção") ? "chip warn" : "chip danger";
  document.getElementById("healthChip").innerHTML = `<span class="${chipClass}">↑ ${health.label}</span>`;

  // counts line
  const counts = { "Novos":0, "Crescendo":0, "Estáveis":0, "Caindo":0, "Perdidos":0 };
  statusRows.forEach(r=> { if(counts[r.Status]!==undefined) counts[r.Status]++; });

  const totalClients = statusRows.length;

  document.getElementById("statusCountsLine").innerHTML =
    `<span class="statusTag sNovos">Novos ${counts["Novos"]}</span>
     <span class="statusTag sCresc">Crescendo ${counts["Crescendo"]}</span>
     <span class="statusTag sEstab">Estáveis ${counts["Estáveis"]}</span>
     <span class="statusTag sCaind">Caindo ${counts["Caindo"]}</span>
     <span class="statusTag sPerd">Perdidos ${counts["Perdidos"]}</span>`;

  document.getElementById("statusCountsSub").textContent = `${formatInt(totalClients)} clientes avaliados (comparativo entre períodos)`;

  // summary table
  const order = ["Novos","Crescendo","Estáveis","Caindo","Perdidos"];
  const sumMap = new Map();
  for(const s of order) sumMap.set(s, { Status:s, Clientes:0, FatAtual:0, FatAnterior:0, Variacao:0 });

  statusRows.forEach(r=>{
    const o = sumMap.get(r.Status) || null;
    if(!o) return;
    o.Clientes += 1;
    o.FatAtual += (r.FaturamentoAtual||0);
    o.FatAnterior += (r.FaturamentoAnterior||0);
    o.Variacao += (r.Variacao||0);
  });

  const rows = order.map(s=> sumMap.get(s));
  const html = `
    <table class="noWrap">
      <thead>
        <tr>
          <th>Status</th>
          <th>Clientes</th>
          <th>Faturamento atual</th>
          <th>Faturamento anterior</th>
          <th>Variação (R$)</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>{
          const cls = (r.Status==="Novos")?"sNovos":
                      (r.Status==="Crescendo")?"sCresc":
                      (r.Status==="Estáveis")?"sEstab":
                      (r.Status==="Caindo")?"sCaind":"sPerd";
          return `
            <tr>
              <td><span class="statusTag ${cls}">${r.Status}</span></td>
              <td class="tdNum">${formatInt(r.Clientes)}</td>
              <td class="tdNum">${formatBRL(r.FatAtual)}</td>
              <td class="tdNum">${formatBRL(r.FatAnterior)}</td>
              <td class="tdNum">${formatBRL(r.Variacao)}</td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
  document.getElementById("statusSummaryTable").innerHTML = html;
}

function renderStatusTables(statusRows, curLabel, prevLabel, searchTerm){
  const wrap = document.getElementById("statusTablesWrap");
  const term = String(searchTerm||"").trim().toLowerCase();

  const order = ["Novos","Crescendo","Estáveis","Caindo","Perdidos"];
  const groups = new Map(order.map(s=>[s,[]]));

  statusRows.forEach(r=>{
    if(term && !String(r.Cliente||"").toLowerCase().includes(term)) return;
    if(!groups.has(r.Status)) groups.set(r.Status, []);
    groups.get(r.Status).push(r);
  });

  const statusToClass = (s)=>(
    s==="Novos"?"sNovos":
    s==="Crescendo"?"sCresc":
    s==="Estáveis"?"sEstab":
    s==="Caindo"?"sCaind":"sPerd"
  );

  // full list (no scroll). keep columns aligned by fixed colgroup.
  const colgroup = `
    <colgroup>
      <col style="width: 28%;">
      <col style="width: 10%;">
      <col style="width: 10%;">
      <col style="width: 17%;">
      <col style="width: 17%;">
      <col style="width: 18%;">
    </colgroup>
  `;

  const tables = order.map(status=>{
    const rows = groups.get(status) || [];
    // sort by current faturamento
    rows.sort((a,b)=> (b.FaturamentoAtual - a.FaturamentoAtual));

    const rowsHtml = rows.map(r=>`
      <tr>
        <td class="colWrap" style="white-space:normal;">${escapeHtml(r.Cliente)}</td>
        <td class="colWrap" style="white-space:normal;">${escapeHtml(r.Cidade||"")}</td>
        <td class="tdNum">${escapeHtml(r.Estado||"")}</td>
        <td class="tdNum">${formatVolume(r.VolumeAtual)}</td>
        <td class="tdNum">${formatBRL(r.FaturamentoAtual)}</td>
        <td class="tdNum">${formatBRL(r.Variacao)}</td>
      </tr>
    `).join("");

    return `
      <div style="margin-bottom: 14px;">
        <div class="sectionHeader" style="margin-bottom: 8px;">
          <h3 class="sectionTitle" style="font-size:16px;">
            <span class="statusTag ${statusToClass(status)}">${status}</span>
            <span style="color: rgba(255,255,255,0.72); font-size:12px; font-weight:650; margin-left:10px;">
              (${formatInt(rows.length)} clientes)
            </span>
          </h3>
          <p class="sectionNote" style="margin:0;">Faturamento ${curLabel} vs ${prevLabel} (Variação R$)</p>
        </div>

        <table class="allowWrap">
          ${colgroup}
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Cidade</th>
              <th>Estado</th>
              <th>Volume</th>
              <th>Faturamento</th>
              <th>Variação (R$)</th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml || `<tr><td colspan="6" style="color: rgba(255,255,255,0.6);">Sem clientes neste status.</td></tr>`}
          </tbody>
        </table>
      </div>
    `;
  }).join("");

  wrap.innerHTML = tables;
}

/* =======================
   MAIN PIPELINE
======================= */
async function loadAll(){
  const txt = await fetchCSV(URL_FATURAMENTO);
  const parsed = await parseCSV(txt);

  const data = parsed.data;
  const headers = parsed.meta.fields || Object.keys(data[0]||{});
  const mapH = buildHeaderMap(headers);

  // Map expected names (your CSV headers are in Portuguese already, but keep robust)
  const colAno = pickCol(mapH, ["Ano"]);
  const colMes = pickCol(mapH, ["Mes","Mês"]);
  const colValor = pickCol(mapH, ["Valor"]);
  const colQtd = pickCol(mapH, ["Quantidade"]);
  const colCliente = pickCol(mapH, ["Cliente"]);
  const colEstado = pickCol(mapH, ["Estado","UF"]);
  const colCidade = pickCol(mapH, ["Cidade"]);
  const colRep = pickCol(mapH, ["Representante"]);
  const colCat = pickCol(mapH, ["Categoria"]);

  if(!colAno || !colMes || !colValor || !colQtd || !colCliente || !colEstado || !colCidade || !colRep){
    throw new Error("CSV inválido: colunas obrigatórias não encontradas (Ano, Mes, Valor, Quantidade, Cliente, Estado, Cidade, Representante).");
  }

  RAW = data.map(r => ({
    Ano: Number(r[colAno]),
    Mes: Number(r[colMes]),
    Valor: Number(String(r[colValor]||"0").replace(",", ".")) || 0,
    Quantidade: Number(String(r[colQtd]||"0").replace(",", ".")) || 0,
    Cliente: String(r[colCliente]||"").trim(),
    Estado: String(r[colEstado]||"").trim(),
    Cidade: String(r[colCidade]||"").trim(),
    Representante: String(r[colRep]||"").trim(),
    Categoria: colCat ? String(r[colCat]||"").trim() : ""
  })).filter(r => Number.isFinite(r.Ano) && Number.isFinite(r.Mes));

  // Load geo
  try{
    const txtGeo = await fetchCSV(URL_CIDADES_GEO);
    const parsedGeo = await parseCSV(txtGeo);
    const geoNorm = normalizeGeoRows(parsedGeo.data);
    GEO = geoNorm;
  }catch(e){
    // keep GEO empty; map will show no markers
    GEO = [];
    console.warn("Geo load failed:", e);
  }

  document.getElementById("dataFreshness").textContent = `Última atualização: ${new Date().toLocaleString("pt-BR")}`;

  populateFilters();
  applyFilters(true);
}

function populateFilters(){
  const years = getAvailableYears(RAW);
  const lastYear = years[years.length-1] || new Date().getFullYear();

  // choose default: last year and its min/max months
  const monthsLastYear = getAvailableMonthsForYear(RAW, lastYear);
  const defSM = monthsLastYear[0] || 1;
  const defEM = monthsLastYear[monthsLastYear.length-1] || 12;

  // rep
  const reps = repList(RAW).map(r=>({value:r, label:(r==="Todos"?"Todos":""+r)}));
  setOptions(document.getElementById("repSelect"), reps, "Todos");

  // year selects
  const yearOpts = years.map(y=>({value:y, label:String(y)}));
  setOptions(document.getElementById("startYear"), yearOpts, lastYear);
  setOptions(document.getElementById("endYear"), yearOpts, lastYear);

  // months selects based on selected years
  const smOpts = getAvailableMonthsForYear(RAW, lastYear).map(m=>({value:m, label:monthLabel(m)}));
  setOptions(document.getElementById("startMonth"), smOpts, defSM);

  const emOpts = getAvailableMonthsForYear(RAW, lastYear).map(m=>({value:m, label:monthLabel(m)}));
  setOptions(document.getElementById("endMonth"), emOpts, defEM);

  // dynamic month options when year changes
  document.getElementById("startYear").addEventListener("change", ()=>{
    const y = Number(document.getElementById("startYear").value);
    const ms = getAvailableMonthsForYear(RAW, y);
    setOptions(document.getElementById("startMonth"), ms.map(m=>({value:m,label:monthLabel(m)})), ms[0]||1);
  });
  document.getElementById("endYear").addEventListener("change", ()=>{
    const y = Number(document.getElementById("endYear").value);
    const ms = getAvailableMonthsForYear(RAW, y);
    setOptions(document.getElementById("endMonth"), ms.map(m=>({value:m,label:monthLabel(m)})), ms[ms.length-1]||12);
  });
}

function labelPeriod(sAno,sMes,eAno,eMes){
  return `${monthLabel(sMes)} ${String(sAno).slice(-2)} - ${monthLabel(eMes)} ${String(eAno).slice(-2)}`;
}

function applyFilters(initial=false){
  const rep = document.getElementById("repSelect").value;
  const sAno = Number(document.getElementById("startYear").value);
  const sMes = Number(document.getElementById("startMonth").value);
  const eAno = Number(document.getElementById("endYear").value);
  const eMes = Number(document.getElementById("endMonth").value);

  currentFiltered = filterByPeriod(RAW, rep, sAno,sMes,eAno,eMes);

  const prev = computePrevPeriod(sAno,sMes,eAno,eMes);
  prevFiltered = filterByPeriod(RAW, rep, prev.sAno,prev.sMes,prev.eAno,prev.eMes);

  const repTitle = (rep==="Todos") ? "Representante: Todos" : `Representante: ${rep}`;
  document.getElementById("titleSub").textContent = repTitle;

  const curLabel = labelPeriod(sAno,sMes,eAno,eMes);
  const prevLabel = labelPeriod(prev.sAno,prev.sMes,prev.eAno,prev.eMes);

  document.getElementById("periodLine").textContent = `Período selecionado: ${curLabel}`;

  // Monthly aggregations
  const curMonthly = aggMonthly(currentFiltered);
  const prevMonthly = aggMonthly(prevFiltered);

  // Concentration + status + health
  const conc = concentrationMetricsByClient(currentFiltered);

  currentStatus = statusByClient(currentFiltered, prevFiltered);
  const health = computeCarteiraScore(currentStatus);

  // KPIs
  buildKpis(rep, currentFiltered, prev, conc, health);

  // Highlights
  renderHighlights(curMonthly);

  // Coverage + map + clients
  renderCoverage(currentFiltered);
  renderTopClients(currentFiltered);
  renderMap(currentFiltered);

  // States distribution
  renderStatesPieAndTables(currentFiltered);

  // Evolution charts totals
  const curTotVal = sumField(currentFiltered,"Valor");
  const curTotVol = sumField(currentFiltered,"Quantidade");
  const prevTotVal = sumField(prevFiltered,"Valor");
  const prevTotVol = sumField(prevFiltered,"Quantidade");

  renderEvolution(
    curMonthly, prevMonthly,
    curLabel, prevLabel,
    `${formatBRL(curTotVal)} • ${formatVolume(curTotVol)}`,
    `${formatBRL(prevTotVal)} • ${formatVolume(prevTotVol)}`
  );

  // Categories
  renderCategory(currentFiltered, prevFiltered);

  // Client distribution
  renderClientsDistribution(currentFiltered);

  // Health section
  renderHealth(currentStatus, health);

  // Status tables full list
  const searchTerm = document.getElementById("clientSearch").value;
  renderStatusTables(currentStatus, curLabel, prevLabel, searchTerm);
}

/* =======================
   EVENTS
======================= */
document.getElementById("applyBtn").addEventListener("click", ()=> applyFilters(false));
document.getElementById("clientSearch").addEventListener("input", ()=> {
  const rep = document.getElementById("repSelect").value;
  const sAno = Number(document.getElementById("startYear").value);
  const sMes = Number(document.getElementById("startMonth").value);
  const eAno = Number(document.getElementById("endYear").value);
  const eMes = Number(document.getElementById("endMonth").value);

  const curLabel = labelPeriod(sAno,sMes,eAno,eMes);
  const prev = computePrevPeriod(sAno,sMes,eAno,eMes);
  const prevLabel = labelPeriod(prev.sAno,prev.sMes,prev.eAno,prev.eMes);

  renderStatusTables(currentStatus, curLabel, prevLabel, document.getElementById("clientSearch").value);
});

// collapsible sidebar
document.getElementById("collapseBtn").addEventListener("click", ()=>{
  document.getElementById("sidebar").classList.toggle("collapsed");
});

// init
loadAll().catch(err=>{
  console.error(err);
  alert("Erro ao carregar dados: " + err.message);
});
</script>
</body>
</html>
