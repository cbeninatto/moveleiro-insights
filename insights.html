<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insights de Vendas</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet 1.9.4 (REQUIRED) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Plotly -->
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/plotly.min.js"></script>

  <style>
    :root{
      --bg: #0b0f14;
      --panel: rgba(255,255,255,0.04);
      --panel2: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);

      --blue: #38bdf8;
      --green: #22c55e;
      --yellow: #eab308;
      --orange: #f97316;
      --red: #ef4444;
      --indigo: #3b82f6;

      --shadow: 0 10px 40px rgba(0,0,0,0.40);
      --r: 18px;

      --sidebarW: 320px;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(56,189,248,0.14), transparent 60%),
                  radial-gradient(900px 500px at 80% 0%, rgba(34,197,94,0.10), transparent 65%),
                  var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* ====== LAYOUT (sidebar collapsible) ====== */
    .app{
      display:grid;
      grid-template-columns: var(--sidebarW) minmax(0,1fr);
      min-height:100vh;
      transition: grid-template-columns .22s ease;
    }
    .app.sidebar-collapsed{
      grid-template-columns: 0px minmax(0,1fr);
    }
    .sidebar{
      border-right: 1px solid var(--stroke);
      background: rgba(0,0,0,0.22);
      backdrop-filter: blur(10px);
      padding: 18px 16px;
      overflow:hidden;
    }
    .app.sidebar-collapsed .sidebar{
      padding:0;
      border-right:none;
    }
    .main{
      padding: 22px 22px 64px 22px;
      min-width:0;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .topbar .left{
      display:flex; align-items:center; gap:12px;
    }
    .btn{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      font-weight:600;
      font-size: 13px;
      line-height:1;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,0.08); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(56,189,248,0.16), rgba(56,189,248,0.08));
      border-color: rgba(56,189,248,0.28);
    }

    /* Headings */
    h1{ margin: 10px 0 6px 0; font-size: 34px; letter-spacing: -0.02em; }
    h2{ margin: 18px 0 10px 0; font-size: 20px; }
    .subhead{
      font-size: 15px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .caption{
      font-size: 13px;
      color: var(--muted2);
      margin-top: 6px;
    }
    .divider{ height:1px; background: var(--stroke); margin: 14px 0; }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px 14px;
    }
    .card.tight{ padding: 12px 12px; }

    /* KPI row */
    .kpis{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 12px;
    }
    .kpi .label{
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 8px;
    }
    .kpi .value{
      font-size: 30px;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .kpi .delta{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted2);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      border-radius: 999px;
      padding: 6px 10px;
      font-weight:600;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(34,197,94,0.14);
      color: rgba(190,255,220,0.95);
      white-space:nowrap;
    }
    .pill.neutral{ background: rgba(34,197,94,0.12); }
    .pill.alert{ background: rgba(234,179,8,0.14); color: rgba(255,245,190,0.95); }
    .pill.critical{ background: rgba(239,68,68,0.14); color: rgba(255,205,205,0.95); }

    /* Two-column sections */
    .two{
      display:grid;
      grid-template-columns: minmax(0,0.78fr) minmax(0,1.22fr);
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .kpis{ grid-template-columns: 1fr 1fr; }
      .two{ grid-template-columns: 1fr; }
    }

    /* Map */
    #map{
      height: 820px; /* same intention as your app (tall) */
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    .map-controls{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .radio{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      color: var(--muted);
      font-size: 13px;
    }
    .radio label{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      user-select:none;
      font-weight:600;
      color: var(--text);
    }
    .radio input{ accent-color: var(--blue); }
    .legend{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .legend-row{
      display:flex; align-items:center; gap:8px;
      margin-top: 6px;
    }
    .swatch{
      width: 12px; height: 12px; border-radius: 3px;
      border: 1px solid rgba(255,255,255,0.18);
    }

    /* Tables (no scroll, no wrap) */
    table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    th,td{
      border-bottom: 1px solid var(--stroke);
      padding: 8px 10px;
      font-size: 12.8px;
      text-align:left;
      vertical-align: top;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th{
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .01em;
    }
    .table-note{ margin-top: 8px; color: var(--muted2); font-size: 12px; }

    /* Principais clientes table: allow more room for faturamento */
    .tbl-clients col:nth-child(1){ width: 44%; }
    .tbl-clients col:nth-child(2){ width: 22%; }
    .tbl-clients col:nth-child(3){ width: 14%; }
    .tbl-clients col:nth-child(4){ width: 20%; }

    /* City list table (click city) */
    .tbl-city col:nth-child(1){ width: 54%; }
    .tbl-city col:nth-child(2){ width: 23%; }
    .tbl-city col:nth-child(3){ width: 23%; }
    .tbl-city th:nth-child(2), .tbl-city th:nth-child(3){ text-align:center; }
    .tbl-city td{ text-align:left; }

    /* Estados table */
    .tbl-estados col:nth-child(1){ width: 26%; }
    .tbl-estados col:nth-child(2){ width: 22%; }
    .tbl-estados col:nth-child(3){ width: 14%; }
    .tbl-estados col:nth-child(4){ width: 22%; }
    .tbl-estados col:nth-child(5){ width: 16%; }

    /* Cidades table full width + top clients columns */
    .tbl-cidades col:nth-child(1){ width: 16%; }
    .tbl-cidades col:nth-child(2){ width: 10%; }
    .tbl-cidades col:nth-child(3){ width: 14%; }
    .tbl-cidades col:nth-child(4){ width: 10%; }
    .tbl-cidades col:nth-child(5){ width: 12%; }
    .tbl-cidades col:nth-child(6){ width: 10%; }
    .tbl-cidades col:nth-child(7){ width: 9.3%; }
    .tbl-cidades col:nth-child(8){ width: 9.3%; }
    .tbl-cidades col:nth-child(9){ width: 9.1%; }
    .cell-small{ white-space: normal; line-height: 1.1; }
    .cell-small .v{ opacity:.88; font-weight:600; }

    /* Distribuição por clientes table */
    .tbl-clientes-resumo col:nth-child(1){ width: 36%; }
    .tbl-clientes-resumo col:nth-child(2){ width: 16%; }
    .tbl-clientes-resumo col:nth-child(3){ width: 12%; }
    .tbl-clientes-resumo col:nth-child(4){ width: 14%; }
    .tbl-clientes-resumo col:nth-child(5){ width: 12%; }
    .tbl-clientes-resumo col:nth-child(6){ width: 10%; }

    /* Status tables: fixed col widths across all */
    .status-wrap h3{
      font-size: 15px;
      margin: 12px 0 6px 0;
      color: var(--text);
    }
    .tbl-status col:nth-child(1){ width: 32%; }
    .tbl-status col:nth-child(2){ width: 10%; }
    .tbl-status col:nth-child(3){ width: 14%; }
    .tbl-status col:nth-child(4){ width: 10%; }
    .tbl-status col:nth-child(5){ width: 17%; }
    .tbl-status col:nth-child(6){ width: 17%; }

    /* Inline info row (evolução labels) */
    .inline-info{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin: 6px 0 10px 0;
      color: var(--muted);
      font-size: 13px;
    }
    .inline-info b{ color: var(--text); }

    /* Sidebar controls */
    .sb-title{
      font-size: 14px;
      font-weight:800;
      letter-spacing: .01em;
      margin: 2px 0 12px 0;
      color: var(--text);
    }
    .sb-section{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--stroke);
    }
    .field{
      margin-top: 10px;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight:700;
    }
    select,input[type="text"]{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      outline:none;
      font-weight:600;
    }

    /* Plotly container cards */
    .plot-card{ padding: 10px 10px; }

    /* Print (A4) */
    @page { size: A4 portrait; margin: 1.2cm; }
    @media print{
      body{ background: #0b0f14 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .sidebar, .topbar, .map-controls, .field, .btn, .no-print { display:none !important; }
      .app{ grid-template-columns: 0px 1fr !important; }
      .card{ box-shadow:none !important; }
      .page-break{ break-before: page; page-break-before: always; }
    }
  </style>
</head>
<body>
  <div class="app sidebar-collapsed" id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sb-title">Filtros – Insights de Vendas</div>

      <div class="sb-section">
        <div class="field">
          <label>Período inicial</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <select id="startMonth"></select>
            <select id="startYear"></select>
          </div>
        </div>

        <div class="field">
          <label>Período final</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <select id="endMonth"></select>
            <select id="endYear"></select>
          </div>
        </div>
      </div>

      <div class="sb-section">
        <div class="field">
          <label>Representante</label>
          <select id="repSelect"></select>
        </div>
      </div>

      <div class="sb-section no-print">
        <button class="btn primary" id="applyBtn" style="width:100%;">Aplicar filtros</button>
        <div class="caption" id="dataStatus" style="margin-top:10px;"></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar no-print">
        <div class="left">
          <button class="btn" id="toggleSidebar">☰ Filtros</button>
          <button class="btn primary" id="printBtn">Exportar PDF</button>
        </div>
        <div class="caption" id="lastUpdated"></div>
      </div>

      <h1>Insights de Vendas</h1>
      <div class="subhead" id="repHeader">Representante: <b>—</b></div>
      <div class="caption" id="periodHeader">Período selecionado: —</div>

      <div class="divider"></div>

      <!-- TOP KPIs -->
      <div class="kpis" id="kpis"></div>

      <div class="divider"></div>

      <!-- DESTAQUES -->
      <h2>Destaques do período</h2>
      <div class="card" id="destaques"></div>

      <div class="divider"></div>

      <!-- MAPA -->
      <h2>Mapa de Clientes</h2>
      <div class="two">
        <div>
          <div class="map-controls no-print">
            <div class="radio" id="mapMetricRadio">
              <label><input type="radio" name="mapMetric" value="Valor" checked> Faturamento</label>
              <label><input type="radio" name="mapMetric" value="Quantidade"> Volume</label>
            </div>
          </div>
          <div id="map"></div>
          <div class="legend" id="mapLegend"></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
            <div style="font-weight:800;">Cobertura</div>
            <div class="caption no-print" id="mapMetricLabel"></div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px;">
            <div class="card tight">
              <div class="caption">Cidades atendidas</div>
              <div style="font-size:26px;font-weight:800;" id="covCities">0</div>
            </div>
            <div class="card tight">
              <div class="caption">Estados atendidos</div>
              <div style="font-size:26px;font-weight:800;" id="covStates">0</div>
            </div>
            <div class="card tight">
              <div class="caption">Clientes atendidos</div>
              <div style="font-size:26px;font-weight:800;" id="covClients">0</div>
            </div>
          </div>

          <div style="margin-top:12px;font-weight:800;">Principais clientes</div>
          <div style="margin-top:8px;">
            <table>
              <colgroup class="tbl-clients">
                <col><col><col><col>
              </colgroup>
              <thead>
                <tr><th>Cliente</th><th>Cidade</th><th>Estado</th><th>Faturamento</th></tr>
              </thead>
              <tbody id="topClientsBody"></tbody>
            </table>
          </div>

          <div id="cityExpandWrap" style="margin-top:14px;display:none;">
            <div style="font-weight:800;" id="cityExpandTitle">Clientes na cidade</div>
            <div class="caption" style="margin:6px 0 8px 0;">Clique em outra cidade no mapa para atualizar.</div>
            <table>
              <colgroup class="tbl-city">
                <col><col><col>
              </colgroup>
              <thead>
                <tr><th>Cliente</th><th>Quantidade</th><th>Faturamento</th></tr>
              </thead>
              <tbody id="cityClientsBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- DISTRIBUIÇÃO POR ESTADOS -->
      <h2>Distribuição por estados</h2>
      <div class="two">
        <div class="card plot-card">
          <div class="caption">Top 10 estados por faturamento – % do faturamento total</div>
          <div id="statesPie" style="height:580px;"></div>
        </div>
        <div class="card">
          <div style="font-weight:800;">Resumo – Top 10 estados</div>
          <div style="margin-top:8px;">
            <table>
              <colgroup class="tbl-estados">
                <col><col><col><col><col>
              </colgroup>
              <thead>
                <tr><th>Estado</th><th>Faturamento</th><th>% Faturamento</th><th>Volume</th><th>% Volume</th></tr>
              </thead>
              <tbody id="statesTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;" class="card">
        <div style="font-weight:800;">Principais cidades por faturamento</div>
        <div class="caption" style="margin-top:6px;">Inclui Top 1/2/3 clientes por cidade (nome abreviado + valor). Passe o mouse para ver o nome completo.</div>
        <div style="margin-top:10px;">
          <table>
            <colgroup class="tbl-cidades">
              <col><col><col><col><col><col><col><col><col>
            </colgroup>
            <thead>
              <tr>
                <th>Cidade</th><th>Estado</th><th>Faturamento</th><th>% Fat.</th>
                <th>Volume</th><th>% Vol.</th>
                <th>Top 1 cliente</th><th>Top 2 cliente</th><th>Top 3 cliente</th>
              </tr>
            </thead>
            <tbody id="citiesTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Page break after Distribuição por estados (Page 1 end) -->
      <div class="page-break"></div>

      <!-- EVOLUÇÃO -->
      <h2>Evolução – Faturamento x Volume</h2>

      <div class="card plot-card">
        <div class="inline-info" id="evoCurrentInfo"></div>
        <div id="evoCurrent" style="height:340px;"></div>
      </div>

      <div style="height:10px;"></div>

      <div class="card plot-card">
        <div class="inline-info" id="evoPrevInfo"></div>
        <div id="evoPrev" style="height:340px;"></div>
      </div>

      <div class="divider"></div>

      <!-- CATEGORIAS -->
      <h2>Categorias vendidas</h2>
      <div class="two">
        <div class="card plot-card">
          <div class="caption">Participação por categoria</div>
          <div id="catPie" style="height:580px;"></div>
        </div>
        <div class="card">
          <div class="caption">Resumo – Categorias (com crescimento vs. período anterior)</div>
          <div style="margin-top:10px;">
            <table>
              <colgroup>
                <col style="width:34%">
                <col style="width:18%">
                <col style="width:12%">
                <col style="width:18%">
                <col style="width:18%">
              </colgroup>
              <thead>
                <tr><th>Categoria</th><th>Valor</th><th>%</th><th>Variação (R$)</th><th>Crescimento vs anterior</th></tr>
              </thead>
              <tbody id="catTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- DISTRIBUIÇÃO POR CLIENTES -->
      <h2>Distribuição por clientes</h2>
      <div class="kpis" id="distKpis"></div>

      <div style="height:10px;"></div>

      <div class="two">
        <div class="card plot-card">
          <div class="caption">Participação dos clientes (Top 10 destacados)</div>
          <div id="clientsPie" style="height:580px;"></div>
        </div>
        <div class="card">
          <div class="caption">Resumo – clientes (mais detalhado)</div>
          <div style="margin-top:10px;">
            <table>
              <colgroup class="tbl-clientes-resumo">
                <col><col><col><col><col><col>
              </colgroup>
              <thead>
                <tr><th>Cliente</th><th>Cidade</th><th>Estado</th><th>Faturamento</th><th>% Faturamento</th><th>Volume</th></tr>
              </thead>
              <tbody id="clientsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- SAÚDE DA CARTEIRA -->
      <h2>Saúde da carteira – Detalhes</h2>
      <div class="two">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
            <div>
              <div class="caption">Pontuação – Saúde da carteira</div>
              <div style="font-size:34px;font-weight:900;letter-spacing:-0.02em;" id="carteiraScore">—</div>
              <div class="caption" id="carteiraLabel">—</div>
            </div>
            <div class="caption" style="max-width:520px;">
              A pontuação reflete a distribuição de receita entre os status (Novos/Crescendo/Estáveis/Caindo/Perdidos)
              no comparativo entre período atual e anterior.
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="caption">Distribuição de clientes por status</div>
            <div id="statusPie" style="height:340px;"></div>
          </div>
        </div>

        <div class="card">
          <div class="caption">Resumo por status</div>
          <div style="margin-top:10px;">
            <table>
              <colgroup>
                <col style="width:24%">
                <col style="width:18%">
                <col style="width:18%">
                <col style="width:40%">
              </colgroup>
              <thead>
                <tr><th>Status</th><th>Clientes</th><th>% Clientes</th><th>Faturamento</th></tr>
              </thead>
              <tbody id="statusResumoBody"></tbody>
            </table>
            <div class="table-note" id="statusObs"></div>
          </div>
        </div>
      </div>

      <!-- Page break after Saúde da carteira (Page 2 end) -->
      <div class="page-break"></div>

      <!-- STATUS DOS CLIENTES -->
      <h2>Status dos clientes</h2>
      <div class="card">
        <div class="field no-print" style="max-width:520px;">
          <label>Buscar cliente</label>
          <input id="searchCliente" type="text" placeholder="Digite parte do nome do cliente" />
        </div>

        <div class="status-wrap" id="statusTables"></div>
      </div>
    </main>
  </div>

  <script>
    // ==========================
    // CONFIG (GitHub raw)
    // ==========================
    const GITHUB_CSV_URL = "https://raw.githubusercontent.com/cbeninatto/performance-moveleiro-v2/main/data/relatorio_faturamento.csv";
    const CITY_GEO_CSV_URL = "https://raw.githubusercontent.com/cbeninatto/performance-moveleiro-v2/main/data/cidades_br_geo.csv";

    // Map requirements
    const OSM_TILE_URL = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
    const OSM_ATTR = "© OpenStreetMap contributors";

    const MONTH_MAP_NUM_TO_NAME = {
      1:"JAN",2:"FEV",3:"MAR",4:"ABR",5:"MAI",6:"JUN",7:"JUL",8:"AGO",9:"SET",10:"OUT",11:"NOV",12:"DEZ"
    };
    const MONTH_NAMES = Object.values(MONTH_MAP_NUM_TO_NAME);
    const MONTH_MAP_NAME_TO_NUM = Object.fromEntries(Object.entries(MONTH_MAP_NUM_TO_NAME).map(([k,v])=>[v,parseInt(k,10)]));

    const STATUS_COL = "StatusCarteira";
    const STATUS_ORDER = ["Novos","Crescendo","Estáveis","Caindo","Perdidos"];
    const STATUS_WEIGHTS = {
      "Novos": 1, "Novo": 1,
      "Crescendo": 2, "CRESCENDO": 2,
      "Estáveis": 1, "Estável": 1, "ESTAVEIS": 1, "ESTÁVEIS": 1,
      "Caindo": -1, "CAINDO": -1,
      "Perdidos": -2, "Perdido": -2, "PERDIDOS": -2
    };

    // Green=high -> Red=low
    const MAP_BIN_COLORS = ["#22c55e","#eab308","#f97316","#ef4444"];

    // ==========================
    // UI refs
    // ==========================
    const appEl = document.getElementById("app");
    const toggleSidebarBtn = document.getElementById("toggleSidebar");
    const printBtn = document.getElementById("printBtn");

    const startMonthEl = document.getElementById("startMonth");
    const startYearEl = document.getElementById("startYear");
    const endMonthEl = document.getElementById("endMonth");
    const endYearEl = document.getElementById("endYear");
    const repSelectEl = document.getElementById("repSelect");
    const applyBtn = document.getElementById("applyBtn");
    const dataStatusEl = document.getElementById("dataStatus");
    const lastUpdatedEl = document.getElementById("lastUpdated");

    const repHeaderEl = document.getElementById("repHeader");
    const periodHeaderEl = document.getElementById("periodHeader");
    const kpisEl = document.getElementById("kpis");
    const destaquesEl = document.getElementById("destaques");

    const covCitiesEl = document.getElementById("covCities");
    const covStatesEl = document.getElementById("covStates");
    const covClientsEl = document.getElementById("covClients");
    const topClientsBodyEl = document.getElementById("topClientsBody");
    const cityExpandWrapEl = document.getElementById("cityExpandWrap");
    const cityExpandTitleEl = document.getElementById("cityExpandTitle");
    const cityClientsBodyEl = document.getElementById("cityClientsBody");

    const mapLegendEl = document.getElementById("mapLegend");
    const mapMetricLabelEl = document.getElementById("mapMetricLabel");

    const statesTableBodyEl = document.getElementById("statesTableBody");
    const citiesTableBodyEl = document.getElementById("citiesTableBody");

    const evoCurrentInfoEl = document.getElementById("evoCurrentInfo");
    const evoPrevInfoEl = document.getElementById("evoPrevInfo");

    const catTableBodyEl = document.getElementById("catTableBody");

    const distKpisEl = document.getElementById("distKpis");
    const clientsTableBodyEl = document.getElementById("clientsTableBody");

    const carteiraScoreEl = document.getElementById("carteiraScore");
    const carteiraLabelEl = document.getElementById("carteiraLabel");
    const statusResumoBodyEl = document.getElementById("statusResumoBody");
    const statusObsEl = document.getElementById("statusObs");

    const searchClienteEl = document.getElementById("searchCliente");
    const statusTablesEl = document.getElementById("statusTables");

    // ==========================
    // STATE
    // ==========================
    let RAW = [];            // raw faturamento rows
    let GEO = [];            // geo rows normalized: {key, Estado, Cidade, lat, lon}
    let map = null;
    let mapLayerGroup = null;
    let selectedCityKey = null;

    // ==========================
    // Helpers (format)
    // ==========================
    function formatBRL(v){
      const n = Number(v||0);
      return "R$ " + n.toFixed(2).replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".");
    }
    function formatBRLCompact(v){
      const n = Number(v||0);
      const a = Math.abs(n);
      if (a >= 1e9) return "R$ " + (n/1e9).toFixed(1).replace(".",",") + " bi";
      if (a >= 1e6) return "R$ " + (n/1e6).toFixed(1).replace(".",",") + " mi";
      if (a >= 1e3) return "R$ " + (n/1e3).toFixed(1).replace(".",",") + " mil";
      return formatBRL(n);
    }
    function formatBRLSigned(v){
      const n = Number(v||0);
      if (n < 0) return "-" + formatBRL(Math.abs(n));
      return formatBRL(n);
    }
    function formatUN(v){
      const n = Math.round(Number(v||0));
      return String(n).replace(/\B(?=(\d{3})+(?!\d))/g,".") + " un";
    }
    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function shorten(s, maxLen=28){
      const t = String(s ?? "").trim();
      if (t.length <= maxLen) return t;
      return t.slice(0, maxLen-1) + "…";
    }

    // ==========================
    // Date helpers
    // ==========================
    function compDate(year, monthNum){
      // monthNum 1-12
      return new Date(Date.UTC(year, monthNum-1, 1));
    }
    function addMonths(d, months){
      const dt = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1));
      dt.setUTCMonth(dt.getUTCMonth() + months);
      return dt;
    }
    function monthsSpanInclusive(start, end){
      return (end.getUTCFullYear()-start.getUTCFullYear())*12 + (end.getUTCMonth()-start.getUTCMonth()) + 1;
    }
    function periodLabel(start, end){
      const fmt = (d) => `${MONTH_MAP_NUM_TO_NAME[d.getUTCMonth()+1]} ${String(d.getUTCFullYear()).slice(2)}`;
      if (start.getUTCFullYear()===end.getUTCFullYear() && start.getUTCMonth()===end.getUTCMonth()) return fmt(start);
      return `${fmt(start)} - ${fmt(end)}`;
    }

    // ==========================
    // CSV load
    // ==========================
    async function fetchText(url){
      // cache-buster so updates reflect immediately
      const cb = Date.now();
      const sep = url.includes("?") ? "&" : "?";
      const u = url + sep + "cb=" + cb;
      const res = await fetch(u, { cache:"no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} – ${res.statusText}`);
      return await res.text();
    }

    function parseCSV(text){
      return new Promise((resolve, reject)=>{
        Papa.parse(text, {
          header:true,
          skipEmptyLines:true,
          complete: (r)=> resolve(r.data),
          error: (e)=> reject(e)
        });
      });
    }

    function normalizeCol(s){
      return String(s||"")
        .trim()
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g,"")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,"");
    }

    function pickCol(cols, candidates){
      const normMap = new Map(cols.map(c=>[normalizeCol(c), c]));
      for (const cand of candidates){
        if (normMap.has(cand)) return normMap.get(cand);
      }
      // fallback contains
      for (const [nk, orig] of normMap.entries()){
        for (const cand of candidates){
          if (nk.includes(cand)) return orig;
        }
      }
      return null;
    }

    async function loadAllData(){
      dataStatusEl.textContent = "Carregando dados do GitHub…";
      const t0 = performance.now();

      const [fatText, geoText] = await Promise.all([fetchText(GITHUB_CSV_URL), fetchText(CITY_GEO_CSV_URL)]);
      const [fatRows, geoRows] = await Promise.all([parseCSV(fatText), parseCSV(geoText)]);

      // Validate expected faturamento columns
      const expected = ["Codigo","Descricao","Quantidade","Valor","Mes","Ano","ClienteCodigo","Cliente","Estado","Cidade","RepresentanteCodigo","Representante","Categoria","SourcePDF"];
      const cols = fatRows.length ? Object.keys(fatRows[0]) : [];
      const missing = expected.filter(c => !cols.includes(c));
      if (missing.length) throw new Error("CSV do GitHub não tem as colunas esperadas: " + missing.join(", "));

      // Normalize faturamento types + Competencia
      RAW = fatRows.map(r=>{
        const Ano = Number(r.Ano);
        const MesNum = Number(r.Mes);
        const Valor = Number(r.Valor || 0);
        const Quantidade = Number(r.Quantidade || 0);
        const Competencia = compDate(Ano, MesNum);
        return { ...r, Ano, MesNum, Valor, Quantidade, Competencia };
      }).filter(r=>Number.isFinite(r.Ano) && Number.isFinite(r.MesNum) && r.Competencia instanceof Date);

      // Normalize GEO columns robustly
      const geoCols = geoRows.length ? Object.keys(geoRows[0]) : [];
      const estadoCol = pickCol(geoCols, ["estado","uf","siglauf","ufsigla","unidadefederativa","estadouf","ufestado","coduf"]);
      const cidadeCol = pickCol(geoCols, ["cidade","municipio","nomemunicipio","nmmunicipio","nomecidade","cidadenome","municipionome"]);
      const latCol = pickCol(geoCols, ["lat","latitude","y","coordy","coordenaday"]);
      const lonCol = pickCol(geoCols, ["lon","lng","long","longitude","x","coordx","coordenadax"]);

      const missGeo = [];
      if (!estadoCol) missGeo.push("Estado/UF");
      if (!cidadeCol) missGeo.push("Cidade/Municipio");
      if (!latCol) missGeo.push("lat");
      if (!lonCol) missGeo.push("lon");
      if (missGeo.length){
        throw new Error(
          `cidades_br_geo.csv está com colunas diferentes das esperadas. Faltando: ${missGeo.join(", ")}. ` +
          `Colunas encontradas: ${geoCols.join(", ")}`
        );
      }

      GEO = geoRows.map(r=>{
        const Estado = String(r[estadoCol] ?? "").trim().toUpperCase();
        const Cidade = String(r[cidadeCol] ?? "").trim().toUpperCase();
        const lat = Number(String(r[latCol] ?? "").replace(",", "."));
        const lon = Number(String(r[lonCol] ?? "").replace(",", "."));
        const key = `${Estado}|${Cidade}`;
        if (!Estado || !Cidade) return null;
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
        return { key, Estado, Cidade, lat, lon };
      }).filter(Boolean);

      const t1 = performance.now();
      lastUpdatedEl.textContent = `Dados carregados • ${RAW.length.toLocaleString("pt-BR")} linhas • ${(t1-t0).toFixed(0)}ms`;
      dataStatusEl.textContent = "Pronto.";
    }

    // ==========================
    // Aggregation helpers
    // ==========================
    function groupBy(arr, keyFn){
      const m = new Map();
      for (const x of arr){
        const k = keyFn(x);
        if (!m.has(k)) m.set(k, []);
        m.get(k).push(x);
      }
      return m;
    }

    function sum(arr, fn){
      let s=0;
      for (const x of arr) s += Number(fn(x)||0);
      return s;
    }

    function uniqueCount(arr, fn){
      const s = new Set();
      for (const x of arr) s.add(fn(x));
      return s.size;
    }

    function sortDesc(arr, fn){
      return [...arr].sort((a,b)=> (fn(b)||0) - (fn(a)||0));
    }

    function buildDynamicBins(values, isValor){
      const cleaned = values.map(v=>Number(v)).filter(v=>Number.isFinite(v) && v>=0).sort((a,b)=>a-b);
      const fmt = (v)=>{
        if (isValor) return "R$ " + String(Math.round(v)).replace(/\B(?=(\d{3})+(?!\d))/g,".");
        return String(Math.round(v)).replace(/\B(?=(\d{3})+(?!\d))/g,".") + " un";
      };

      if (!cleaned.length){
        return isValor ? [
          {min:1_000_000,color:MAP_BIN_COLORS[0],label:"R$ 1.000.000+"},
          {min:500_000,color:MAP_BIN_COLORS[1],label:"R$ 500.000 - 999.999"},
          {min:250_000,color:MAP_BIN_COLORS[2],label:"R$ 250.000 - 499.999"},
          {min:0,color:MAP_BIN_COLORS[3],label:"R$ 0 - 249.999"},
        ] : [
          {min:10_000,color:MAP_BIN_COLORS[0],label:"10.000 un+"},
          {min:5_000,color:MAP_BIN_COLORS[1],label:"5.000 - 9.999 un"},
          {min:2_500,color:MAP_BIN_COLORS[2],label:"2.500 - 4.999 un"},
          {min:0,color:MAP_BIN_COLORS[3],label:"0 - 2.499 un"},
        ];
      }

      const n = cleaned.length;
      const minVal = cleaned[0], maxVal = cleaned[n-1];
      if (minVal === maxVal){
        const label = fmt(minVal);
        return [
          {min:minVal,color:MAP_BIN_COLORS[0],label},
          {min:minVal,color:MAP_BIN_COLORS[0],label},
          {min:minVal,color:MAP_BIN_COLORS[0],label},
          {min:0,color:MAP_BIN_COLORS[0],label},
        ];
      }

      const idx = p => Math.floor(p*(n-1));
      const q1 = cleaned[idx(0.25)];
      const q2 = cleaned[idx(0.5)];
      const q3 = cleaned[idx(0.75)];
      const t0 = Math.max(0, minVal);
      const t1 = Math.max(t0, q1);
      const t2 = Math.max(t1, q2);
      const t3 = Math.max(t2, q3);

      return [
        {min:t3,color:MAP_BIN_COLORS[0],label:`${fmt(t3)}+`},
        {min:t2,color:MAP_BIN_COLORS[1],label:`${fmt(t2)} - ${fmt(t3)}`},
        {min:t1,color:MAP_BIN_COLORS[2],label:`${fmt(t1)} - ${fmt(t2)}`},
        {min:t0,color:MAP_BIN_COLORS[3],label:`${fmt(t0)} - ${fmt(t1)}`},
      ];
    }

    function binForValue(v, bins){
      const x = Number(v||0);
      for (const b of bins){
        if (x >= b.min) return b;
      }
      return bins[bins.length-1];
    }

    // ==========================
    // Carteira computation (same logic as app.py)
    // ==========================
    function buildCarteiraStatus(allRows, repSelected, startComp, endComp){
      const repRows = (repSelected==="Todos")
        ? allRows
        : allRows.filter(r => String(r.Representante||"") === repSelected);

      if (!repRows.length) return [];

      const span = monthsSpanInclusive(startComp, endComp);
      const prevEnd = addMonths(startComp, -1);
      const prevStart = addMonths(prevEnd, -(span-1));

      const curr = repRows.filter(r => r.Competencia >= startComp && r.Competencia <= endComp);
      const prev = repRows.filter(r => r.Competencia >= prevStart && r.Competencia <= prevEnd);

      const currG = groupBy(curr, r => String(r.Cliente||""));
      const prevG = groupBy(prev, r => String(r.Cliente||""));

      const clientesSet = new Set([...currG.keys(), ...prevG.keys()]);
      const out = [];

      for (const cliente of clientesSet){
        const cRows = currG.get(cliente) || [];
        const pRows = prevG.get(cliente) || [];

        const ValorAtual = sum(cRows, r=>r.Valor);
        const ValorAnterior = sum(pRows, r=>r.Valor);

        const EstadoAtual = cRows.length ? String(cRows[0].Estado||"") : "";
        const CidadeAtual = cRows.length ? String(cRows[0].Cidade||"") : "";
        const EstadoAnterior = pRows.length ? String(pRows[0].Estado||"") : "";
        const CidadeAnterior = pRows.length ? String(pRows[0].Cidade||"") : "";

        const Estado = (EstadoAtual || EstadoAnterior || "");
        const Cidade = (CidadeAtual || CidadeAnterior || "");

        if (!(ValorAtual>0 || ValorAnterior>0)) continue;

        let status = "Estáveis";
        if (ValorAtual>0 && ValorAnterior===0) status = "Novos";
        else if (ValorAtual===0 && ValorAnterior>0) status = "Perdidos";
        else if (ValorAtual>0 && ValorAnterior>0){
          const ratio = ValorAnterior!==0 ? (ValorAtual/ValorAnterior) : 0;
          if (ratio >= 1.2) status = "Crescendo";
          else if (ratio <= 0.8) status = "Caindo";
          else status = "Estáveis";
        }

        out.push({ Cliente: cliente, Estado, Cidade, ValorAtual, ValorAnterior, [STATUS_COL]: status });
      }

      return out;
    }

    function computeCarteiraScore(clientesCarteira){
      if (!clientesCarteira || !clientesCarteira.length) return {score:50, label:"Neutra"};

      const df = clientesCarteira.map(r=>{
        const va = Number(r.ValorAtual||0);
        const vp = Number(r.ValorAnterior||0);
        const PesoReceita = Math.max(va, vp, 0);
        return { ...r, va, vp, PesoReceita };
      });

      const total = df.reduce((acc,r)=>acc+r.PesoReceita, 0);
      if (total <= 0) return {score:50, label:"Neutra"};

      const byStatus = new Map();
      for (const r of df){
        const s = String(r[STATUS_COL]||"");
        byStatus.set(s, (byStatus.get(s)||0) + r.PesoReceita);
      }

      let scoreBruto = 0;
      for (const [s, receita] of byStatus.entries()){
        const w = STATUS_WEIGHTS[s] ?? 0;
        scoreBruto += w * (receita/total);
      }

      let isc = (scoreBruto + 2) / 4 * 100;
      isc = Math.max(0, Math.min(100, isc));

      // churn cap logic (same as app)
      const baseAnterior = df.filter(r=>r.vp>0);
      const baseTotal = baseAnterior.reduce((acc,r)=>acc+r.PesoReceita, 0);
      const receitaPerdida = df.filter(r=>String(r[STATUS_COL]||"").toUpperCase().includes("PERDID"))
                               .reduce((acc,r)=>acc+r.PesoReceita, 0);
      const churn = baseTotal>0 ? (receitaPerdida/baseTotal) : 0;

      if (churn > 0.20 && isc >= 70) isc = 69;

      let label = "Neutra";
      if (isc < 30) label = "Crítica";
      else if (isc < 50) label = "Alerta";
      else if (isc < 70) label = "Neutra";
      else label = "Saudável";

      return {score: isc, label};
    }

    // ==========================
    // Renderers
    // ==========================
    function renderKPIs(ctx){
      const { totalRep, mediaMensal, hhiLabelShort, n80Count, carteiraScore, carteiraLabel, clientesAtendidos } = ctx;

      kpisEl.innerHTML = "";

      const kpi = (label, value, deltaHtml="")=>{
        const d = document.createElement("div");
        d.className = "card kpi";
        d.innerHTML = `
          <div class="label">${esc(label)}</div>
          <div class="value">${esc(value)}</div>
          <div class="delta">${deltaHtml}</div>
        `;
        return d;
      };

      const pill = (text, kind="neutral")=>{
        const cls = kind==="critical" ? "pill critical" : kind==="alert" ? "pill alert" : "pill neutral";
        return `<span class="${cls}">↑ ${esc(text)}</span>`;
      };

      kpisEl.appendChild(kpi("Total período", formatBRLCompact(totalRep)));
      kpisEl.appendChild(kpi("Média mensal", formatBRLCompact(mediaMensal)));
      kpisEl.appendChild(kpi("Distribuição por clientes", hhiLabelShort, pill(`N80: ${n80Count} clientes`)));
      kpisEl.appendChild(kpi("Saúde da carteira", `${Math.round(carteiraScore)} / 100`, pill(carteiraLabel)));
      kpisEl.appendChild(kpi("Clientes atendidos", String(clientesAtendidos)));
    }

    function renderDestaques(ctx){
      const { mensal, bestFat, worstFat, bestVol, worstVol } = ctx;
      if (!mensal.length){
        destaquesEl.innerHTML = `<div class="caption">Não há vendas no período selecionado.</div>`;
        return;
      }
      destaquesEl.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <div style="font-weight:800;margin-bottom:6px;">Faturamento</div>
            <div class="caption">• Melhor mês: <b>${esc(bestFat.MesLabel)}</b> — ${esc(formatBRL(bestFat.Valor))}</div>
            <div class="caption">• Pior mês: <b>${esc(worstFat.MesLabel)}</b> — ${esc(formatBRL(worstFat.Valor))}</div>
          </div>
          <div>
            <div style="font-weight:800;margin-bottom:6px;">Volume</div>
            <div class="caption">• Melhor mês: <b>${esc(bestVol.MesLabel)}</b> — ${esc(formatUN(bestVol.Quantidade))}</div>
            <div class="caption">• Pior mês: <b>${esc(worstVol.MesLabel)}</b> — ${esc(formatUN(worstVol.Quantidade))}</div>
          </div>
        </div>
      `;
    }

    function ensureMap(){
      if (map) return;
      map = L.map("map", { zoomControl:true, preferCanvas:true });
      L.tileLayer(OSM_TILE_URL, { attribution: OSM_ATTR }).addTo(map);
      mapLayerGroup = L.layerGroup().addTo(map);
    }

    function renderMap(ctx){
      ensureMap();
      mapLayerGroup.clearLayers();
      mapLegendEl.innerHTML = "";
      selectedCityKey = null;
      cityExpandWrapEl.style.display = "none";

      const { dfMap, metricCol, metricLabel, bins } = ctx;

      mapMetricLabelEl.textContent = `Métrica do mapa: ${metricLabel}`;

      if (!dfMap.length){
        map.setView([-14.2, -51.9], 4);
        mapLegendEl.innerHTML = `<div class="caption">Não há coordenadas de cidades para exibir no mapa.</div>`;
        return;
      }

      // Fit bounds
      const latlngs = dfMap.map(r=>[r.lat, r.lon]);
      const bounds = L.latLngBounds(latlngs);
      map.fitBounds(bounds.pad(0.18));

      // Legend
      let legendHTML = `<b>Legenda – ${esc(metricLabel)}</b>`;
      for (const b of bins){
        legendHTML += `
          <div class="legend-row">
            <span class="swatch" style="background:${b.color};"></span>
            <span>${esc(b.label)}</span>
          </div>
        `;
      }
      mapLegendEl.innerHTML = legendHTML;

      for (const r of dfMap){
        const v = Number(r[metricCol]||0);
        const b = binForValue(v, bins);
        const popup = `
          <div style="font-weight:800;margin-bottom:6px;">${esc(r.Cidade)} - ${esc(r.Estado)}</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.72);">${esc(metricLabel)}: <b>${esc(metricCol==="Valor" ? formatBRL(r.Valor) : formatUN(r.Quantidade))}</b></div>
          <div style="font-size:12px;color:rgba(255,255,255,0.72);">Clientes: <b>${esc(String(r.Clientes))}</b></div>
          <div style="margin-top:8px;font-size:12px;color:rgba(56,189,248,0.95);font-weight:700;">Clique para ver lista de clientes</div>
        `;

        const marker = L.circleMarker([r.lat, r.lon], {
          radius: 6,
          color: b.color,
          fillColor: b.color,
          fillOpacity: 0.82,
          weight: 2
        }).addTo(mapLayerGroup);

        marker.bindTooltip(`${r.Cidade} - ${r.Estado}`, { direction:"top", opacity:0.9 });
        marker.bindPopup(popup, { maxWidth: 320 });

        marker.on("click", ()=>{
          selectedCityKey = r.key;
          renderCityClientsTable(r);
        });
      }
    }

    function renderCityClientsTable(cityRow){
      const { Cidade, Estado } = cityRow;
      const repRows = window.__CTX.dfRep || [];
      const rows = repRows.filter(r => String(r.Cidade||"")===Cidade && String(r.Estado||"")===Estado);

      const byCliente = groupBy(rows, r => String(r.Cliente||""));
      const agg = [];
      for (const [cliente, arr] of byCliente.entries()){
        agg.push({
          Cliente: cliente,
          Quantidade: sum(arr, x=>x.Quantidade),
          Valor: sum(arr, x=>x.Valor)
        });
      }
      agg.sort((a,b)=>b.Valor-a.Valor);

      cityExpandTitleEl.textContent = `Clientes em ${Cidade} - ${Estado}`;
      cityClientsBodyEl.innerHTML = agg.map(r=>`
        <tr>
          <td title="${esc(r.Cliente)}">${esc(shorten(r.Cliente, 46))}</td>
          <td>${esc(formatUN(r.Quantidade))}</td>
          <td>${esc(formatBRL(r.Valor))}</td>
        </tr>
      `).join("");

      cityExpandWrapEl.style.display = "block";
    }

    function plotPie(elId, labels, values, opts={}){
      const showLegend = !!opts.showLegend;
      const height = opts.height ?? 560;
      const hole = opts.hole ?? 0.35;
      const text = opts.text || null;
      const textinfo = opts.textinfo ?? "text";
      const textposition = opts.textposition ?? "inside";
      const sort = false;

      const data = [{
        type:"pie",
        labels,
        values,
        hole,
        sort,
        direction:"clockwise",
        text,
        textinfo,
        textposition,
        insidetextorientation:"radial",
        hovertemplate: "%{label}<br>%{percent}<br>%{value:,}<extra></extra>"
      }];

      const layout = {
        margin:{l:10,r:10,t:10,b:10},
        height,
        showlegend: showLegend,
        paper_bgcolor:"rgba(0,0,0,0)",
        plot_bgcolor:"rgba(0,0,0,0)",
        font:{color:"rgba(255,255,255,0.88)", family:"Inter, sans-serif"}
      };

      Plotly.newPlot(elId, data, layout, {displayModeBar:false, responsive:true});
    }

    function plotCombo(elId, xLabels, faturamento, volume){
      const data = [
        {
          type:"bar",
          x: xLabels,
          y: faturamento,
          name:"Faturamento",
          marker:{color: "rgba(56,189,248,0.75)"},
          yaxis:"y"
        },
        {
          type:"scatter",
          x: xLabels,
          y: volume,
          name:"Volume",
          mode:"lines+markers",
          line:{color:"#22c55e", width:3},
          marker:{color:"#22c55e", size:7},
          yaxis:"y2"
        }
      ];

      const layout = {
        margin:{l:50,r:50,t:10,b:40},
        paper_bgcolor:"rgba(0,0,0,0)",
        plot_bgcolor:"rgba(0,0,0,0)",
        font:{color:"rgba(255,255,255,0.88)", family:"Inter, sans-serif"},
        xaxis:{
          tickfont:{color:"rgba(255,255,255,0.70)"},
          gridcolor:"rgba(255,255,255,0.06)"
        },
        yaxis:{
          title:"Faturamento (R$)",
          tickfont:{color:"rgba(255,255,255,0.70)"},
          gridcolor:"rgba(255,255,255,0.06)"
        },
        yaxis2:{
          title:"Volume (un)",
          overlaying:"y",
          side:"right",
          tickfont:{color:"rgba(255,255,255,0.70)"},
          gridcolor:"rgba(255,255,255,0.00)"
        },
        legend:{orientation:"h", y:1.18, x:0, font:{color:"rgba(255,255,255,0.70)"}}
      };

      Plotly.newPlot(elId, data, layout, {displayModeBar:false, responsive:true});
    }

    // ==========================
    // MAIN recompute
    // ==========================
    function getFiltersFromUI(){
      const sm = MONTH_MAP_NAME_TO_NUM[startMonthEl.value];
      const em = MONTH_MAP_NAME_TO_NUM[endMonthEl.value];
      const sy = Number(startYearEl.value);
      const ey = Number(endYearEl.value);

      const startComp = compDate(sy, sm);
      const endComp = compDate(ey, em);

      const rep = repSelectEl.value || "Todos";
      return { startComp, endComp, rep };
    }

    function validatePeriod(startComp, endComp){
      return startComp <= endComp;
    }

    function rebuildRepOptionsForPeriod(dfPeriod){
      const reps = Array.from(new Set(dfPeriod.map(r=>String(r.Representante||"")).filter(Boolean))).sort();
      const options = ["Todos", ...reps];

      // preserve selection if still valid
      const prev = repSelectEl.value || "Todos";
      repSelectEl.innerHTML = options.map(o=>`<option value="${esc(o)}">${esc(o)}</option>`).join("");
      repSelectEl.value = options.includes(prev) ? prev : "Todos";
    }

    function recomputeAndRender(){
      const { startComp, endComp, rep } = getFiltersFromUI();
      if (!validatePeriod(startComp, endComp)){
        alert("Período inicial não pode ser maior que o período final.");
        return;
      }

      const span = monthsSpanInclusive(startComp, endComp);
      const prevEnd = addMonths(startComp, -1);
      const prevStart = addMonths(prevEnd, -(span-1));

      const currentLabel = periodLabel(startComp, endComp);
      const prevLabel = periodLabel(prevStart, prevEnd);

      // Filter period
      const dfPeriod = RAW.filter(r => r.Competencia >= startComp && r.Competencia <= endComp);
      if (!dfPeriod.length){
        repHeaderEl.innerHTML = `Representante: <b>${esc(rep==="Todos" ? "Todos" : rep)}</b>`;
        periodHeaderEl.textContent = `Período selecionado: ${currentLabel}`;
        kpisEl.innerHTML = `<div class="card"><div class="caption">Nenhuma venda no período selecionado.</div></div>`;
        return;
      }

      // Rep options depend on dates (your requirement)
      rebuildRepOptionsForPeriod(dfPeriod);

      const repSel = repSelectEl.value || rep;

      const dfRep = (repSel==="Todos") ? dfPeriod : dfPeriod.filter(r=>String(r.Representante||"")===repSel);
      const dfPrevPeriod = RAW.filter(r => r.Competencia >= prevStart && r.Competencia <= prevEnd);
      const dfRepPrev = (repSel==="Todos") ? dfPrevPeriod : dfPrevPeriod.filter(r=>String(r.Representante||"")===repSel);

      // Save for city click
      window.__CTX = { dfRep };

      // HEADER
      repHeaderEl.innerHTML = `Representante: <b>${esc(repSel==="Todos" ? "Todos" : repSel)}</b>`;
      periodHeaderEl.textContent = `Período selecionado: ${currentLabel}`;

      // KPIs
      const totalRep = sum(dfRep, r=>r.Valor);
      const totalVol = sum(dfRep, r=>r.Quantidade);

      // months with sale
      const byMonthKey = groupBy(dfRep, r => `${r.Ano}-${r.MesNum}`);
      let mesesComVenda = 0;
      for (const arr of byMonthKey.values()){
        if (sum(arr, x=>x.Valor) > 0) mesesComVenda += 1;
      }
      const mediaMensal = mesesComVenda>0 ? totalRep/mesesComVenda : 0;

      // clients distribution (HHI, N80 etc)
      const byClient = groupBy(dfRep, r => String(r.Cliente||""));
      const clientAgg = [];
      for (const [cliente, arr] of byClient.entries()){
        clientAgg.push({ Cliente: cliente, Valor: sum(arr, x=>x.Valor) });
      }
      clientAgg.sort((a,b)=>b.Valor-a.Valor);

      const clientesAtendidos = clientAgg.length;
      const shares = clientAgg.map(c => totalRep>0 ? c.Valor/totalRep : 0);
      let cum = 0, n80Count = 0;
      for (let i=0;i<shares.length;i++){
        cum += shares[i];
        n80Count = i+1;
        if (cum >= 0.8) break;
      }
      const hhi = shares.reduce((acc,s)=>acc+s*s, 0);
      let hhiLabelShort = "Sem dados";
      if (totalRep>0){
        if (hhi < 0.10) hhiLabelShort = "Baixa";
        else if (hhi < 0.20) hhiLabelShort = "Moderada";
        else hhiLabelShort = "Alta";
      }

      // Carteira
      const clientesCarteira = buildCarteiraStatus(RAW, repSel, startComp, endComp);
      const {score: carteiraScore, label: carteiraLabel} = computeCarteiraScore(clientesCarteira);

      renderKPIs({ totalRep, mediaMensal, hhiLabelShort, n80Count, carteiraScore, carteiraLabel, clientesAtendidos });

      // Destaques
      const mensalMap = new Map();
      for (const r of dfRep){
        const k = `${r.Ano}-${r.MesNum}`;
        if (!mensalMap.has(k)){
          mensalMap.set(k, { Ano:r.Ano, MesNum:r.MesNum, Valor:0, Quantidade:0 });
        }
        const o = mensalMap.get(k);
        o.Valor += r.Valor;
        o.Quantidade += r.Quantidade;
      }
      const mensal = Array.from(mensalMap.values())
        .map(o=>{
          const d = compDate(o.Ano, o.MesNum);
          return { ...o, Competencia:d, MesLabel:`${MONTH_MAP_NUM_TO_NAME[o.MesNum]} ${String(o.Ano).slice(2)}` };
        })
        .sort((a,b)=>a.Competencia-b.Competencia);

      const bestFat = mensal.reduce((a,b)=> b.Valor>a.Valor ? b : a, mensal[0]);
      const worstFat = mensal.reduce((a,b)=> b.Valor<a.Valor ? b : a, mensal[0]);
      const bestVol = mensal.reduce((a,b)=> b.Quantidade>a.Quantidade ? b : a, mensal[0]);
      const worstVol = mensal.reduce((a,b)=> b.Quantidade<a.Quantidade ? b : a, mensal[0]);

      renderDestaques({ mensal, bestFat, worstFat, bestVol, worstVol });

      // Coverage
      const cityPairs = new Set(dfRep.map(r=>`${String(r.Estado||"")}||${String(r.Cidade||"")}`).filter(x=>!x.startsWith("||")));
      const estados = new Set(dfRep.map(r=>String(r.Estado||"")).filter(Boolean));
      covCitiesEl.textContent = String(cityPairs.size);
      covStatesEl.textContent = String(estados.size);
      covClientsEl.textContent = String(clientesAtendidos);

      // Principais clientes (top 15, no scroll)
      const byClientLoc = groupBy(dfRep, r => `${String(r.Cliente||"")}||${String(r.Cidade||"")}||${String(r.Estado||"")}`);
      const topClients = [];
      for (const [k, arr] of byClientLoc.entries()){
        const [Cliente, Cidade, Estado] = k.split("||");
        topClients.push({ Cliente, Cidade, Estado, Valor: sum(arr, x=>x.Valor) });
      }
      topClients.sort((a,b)=>b.Valor-a.Valor);
      const top15 = topClients.slice(0,15);

      topClientsBodyEl.innerHTML = top15.map(r=>`
        <tr>
          <td title="${esc(r.Cliente)}">${esc(shorten(r.Cliente, 42))}</td>
          <td title="${esc(r.Cidade)}">${esc(shorten(r.Cidade, 24))}</td>
          <td>${esc(r.Estado)}</td>
          <td>${esc(formatBRL(r.Valor))}</td>
        </tr>
      `).join("");

      // Map prep (merge geo)
      const byCity = groupBy(dfRep, r => `${String(r.Estado||"").trim().toUpperCase()}|${String(r.Cidade||"").trim().toUpperCase()}`);
      const cityAgg = [];
      for (const [key, arr] of byCity.entries()){
        const [Estado, Cidade] = key.split("|");
        cityAgg.push({
          key, Estado, Cidade,
          Valor: sum(arr, x=>x.Valor),
          Quantidade: sum(arr, x=>x.Quantidade),
          Clientes: uniqueCount(arr, x=>String(x.Cliente||""))
        });
      }

      const geoMap = new Map(GEO.map(g=>[g.key, g]));
      const dfMap = cityAgg.map(c=>{
        const g = geoMap.get(c.key);
        if (!g) return null;
        return { ...c, lat:g.lat, lon:g.lon };
      }).filter(Boolean);

      const metricCol = document.querySelector('input[name="mapMetric"]:checked')?.value || "Valor";
      const metricLabel = (metricCol==="Valor") ? "Faturamento (R$)" : "Volume (un)";
      const bins = buildDynamicBins(dfMap.map(r=>r[metricCol]), metricCol==="Valor");

      renderMap({ dfMap, metricCol, metricLabel, bins });

      // Distribuição por estados
      const byEstado = groupBy(dfRep, r=>String(r.Estado||""));
      const estadosAgg = [];
      for (const [Estado, arr] of byEstado.entries()){
        if (!Estado) continue;
        estadosAgg.push({ Estado, Valor: sum(arr,x=>x.Valor), Quantidade: sum(arr,x=>x.Quantidade) });
      }
      estadosAgg.sort((a,b)=>b.Valor-a.Valor);
      const top10Estados = estadosAgg.slice(0,10);

      const totalValorAll = estadosAgg.reduce((acc,r)=>acc+r.Valor,0);
      const totalQtdAll = estadosAgg.reduce((acc,r)=>acc+r.Quantidade,0);

      // Pie (no legend)
      const stLabels = top10Estados.map(r=>r.Estado);
      const stValues = top10Estados.map(r=>r.Valor);
      plotPie("statesPie", stLabels, stValues, {
        showLegend:false,
        height:560,
        hole:0.35,
        text: top10Estados.map(r=>{
          const share = totalValorAll>0 ? (r.Valor/totalValorAll) : 0;
          return (share>=0.07) ? `${r.Estado}<br>${(share*100).toFixed(1)}%` : "";
        }),
        textinfo:"text"
      });

      // Table
      statesTableBodyEl.innerHTML = top10Estados.map(r=>{
        const pFat = totalValorAll>0 ? r.Valor/totalValorAll : 0;
        const pVol = totalQtdAll>0 ? r.Quantidade/totalQtdAll : 0;
        return `
          <tr>
            <td>${esc(r.Estado)}</td>
            <td>${esc(formatBRL(r.Valor))}</td>
            <td>${esc((pFat*100).toFixed(1)+"%")}</td>
            <td>${esc(formatUN(r.Quantidade))}</td>
            <td>${esc((pVol*100).toFixed(1)+"%")}</td>
          </tr>
        `;
      }).join("");

      // Principais cidades por faturamento (top 15) + top 3 clients columns
      const byCidadeEstado = groupBy(dfRep, r=>`${String(r.Cidade||"")}||${String(r.Estado||"")}`);
      const cidadesAgg = [];
      for (const [k, arr] of byCidadeEstado.entries()){
        const [Cidade, Estado] = k.split("||");
        if (!Cidade || !Estado) continue;
        cidadesAgg.push({
          Cidade, Estado,
          Valor: sum(arr,x=>x.Valor),
          Quantidade: sum(arr,x=>x.Quantidade)
        });
      }
      cidadesAgg.sort((a,b)=>b.Valor-a.Valor);
      const top15Cidades = cidadesAgg.slice(0,15);

      // top 3 clients per city
      const byCityClient = groupBy(dfRep, r=>`${String(r.Cidade||"")}||${String(r.Estado||"")}||${String(r.Cliente||"")}`);
      const cityClientAgg = [];
      for (const [k, arr] of byCityClient.entries()){
        const [Cidade, Estado, Cliente] = k.split("||");
        if (!Cidade || !Estado || !Cliente) continue;
        cityClientAgg.push({ Cidade, Estado, Cliente, Valor: sum(arr,x=>x.Valor) });
      }
      cityClientAgg.sort((a,b)=> (a.Cidade===b.Cidade ? (a.Estado===b.Estado ? b.Valor-a.Valor : a.Estado.localeCompare(b.Estado)) : a.Cidade.localeCompare(b.Cidade)));

      const topClientsByCity = new Map();
      for (const row of cityClientAgg){
        const key = `${row.Cidade}||${row.Estado}`;
        if (!topClientsByCity.has(key)) topClientsByCity.set(key, []);
        const arr = topClientsByCity.get(key);
        if (arr.length < 3) arr.push(row);
      }

      function clientCell(c){
        if (!c) return "";
        const full = c.Cliente;
        const sh = shorten(full, 26);
        return `<div class="cell-small" title="${esc(full)}">
          <div>${esc(sh)}</div>
          <div class="v">${esc(formatBRLCompact(c.Valor))}</div>
        </div>`;
      }

      citiesTableBodyEl.innerHTML = top15Cidades.map(r=>{
        const pFat = totalValorAll>0 ? r.Valor/totalValorAll : 0;
        const pVol = totalQtdAll>0 ? r.Quantidade/totalQtdAll : 0;
        const key = `${r.Cidade}||${r.Estado}`;
        const tops = topClientsByCity.get(key) || [];
        return `
          <tr>
            <td title="${esc(r.Cidade)}">${esc(shorten(r.Cidade, 18))}</td>
            <td>${esc(r.Estado)}</td>
            <td>${esc(formatBRL(r.Valor))}</td>
            <td>${esc((pFat*100).toFixed(1)+"%")}</td>
            <td>${esc(formatUN(r.Quantidade))}</td>
            <td>${esc((pVol*100).toFixed(1)+"%")}</td>
            <td>${clientCell(tops[0])}</td>
            <td>${clientCell(tops[1])}</td>
            <td>${clientCell(tops[2])}</td>
          </tr>
        `;
      }).join("");

      // Evolução charts (current + prev)
      function buildTS(rows){
        const g = groupBy(rows, r=>`${r.Ano}-${r.MesNum}`);
        const ts = [];
        for (const [k, arr] of g.entries()){
          const [Ano, MesNum] = k.split("-").map(Number);
          const d = compDate(Ano, MesNum);
          ts.push({
            Competencia:d,
            MesLabel:`${MONTH_MAP_NUM_TO_NAME[MesNum]} ${String(Ano).slice(2)}`,
            Valor: sum(arr,x=>x.Valor),
            Quantidade: sum(arr,x=>x.Quantidade)
          });
        }
        ts.sort((a,b)=>a.Competencia-b.Competencia);
        return ts;
      }

      const tsCurr = buildTS(dfRep);
      const tsPrev = buildTS(dfRepPrev);

      evoCurrentInfoEl.innerHTML = `<b>Período atual:</b> ${esc(currentLabel)} &nbsp;•&nbsp; <b>Faturamento:</b> ${esc(formatBRLCompact(sum(dfRep,x=>x.Valor)))} &nbsp;•&nbsp; <b>Volume:</b> ${esc(formatUN(sum(dfRep,x=>x.Quantidade)))}`;
      plotCombo("evoCurrent", tsCurr.map(r=>r.MesLabel), tsCurr.map(r=>r.Valor), tsCurr.map(r=>r.Quantidade));

      evoPrevInfoEl.innerHTML = `<b>Período anterior:</b> ${esc(prevLabel)} &nbsp;•&nbsp; <b>Faturamento:</b> ${esc(formatBRLCompact(sum(dfRepPrev,x=>x.Valor)))} &nbsp;•&nbsp; <b>Volume:</b> ${esc(formatUN(sum(dfRepPrev,x=>x.Quantidade)))}`;
      plotCombo("evoPrev", tsPrev.map(r=>r.MesLabel), tsPrev.map(r=>r.Valor), tsPrev.map(r=>r.Quantidade));

      // Categorias
      const currCatG = groupBy(dfRep, r=>String(r.Categoria||""));
      const prevCatG = groupBy(dfRepPrev, r=>String(r.Categoria||""));
      const catSet = new Set([...currCatG.keys(), ...prevCatG.keys()]);
      const catRows = [];
      for (const cat of catSet){
        if (!cat) continue;
        const cur = currCatG.get(cat) || [];
        const prv = prevCatG.get(cat) || [];
        const ValorAtual = sum(cur,x=>x.Valor);
        const ValorAnterior = sum(prv,x=>x.Valor);
        catRows.push({ Categoria:cat, ValorAtual, ValorAnterior });
      }
      catRows.sort((a,b)=>b.ValorAtual-a.ValorAtual);

      const totalCat = catRows.reduce((acc,r)=>acc+r.ValorAtual,0);
      // Pie data: top10 + Outras
      let pieCat = catRows.map(r=>({name:r.Categoria, value:r.ValorAtual})).filter(r=>r.value>0);
      pieCat.sort((a,b)=>b.value-a.value);
      if (pieCat.length > 10){
        const top10 = pieCat.slice(0,10);
        const others = pieCat.slice(10).reduce((acc,r)=>acc+r.value,0);
        top10.push({name:"Outras", value:others});
        pieCat = top10;
      }
      const pieCatTotal = pieCat.reduce((acc,r)=>acc+r.value,0);
      const catText = pieCat.map(r=>{
        const share = pieCatTotal>0 ? r.value/pieCatTotal : 0;
        return (share>=0.07) ? `${r.name}<br>${(share*100).toFixed(1)}%` : "";
      });
      plotPie("catPie", pieCat.map(r=>r.name), pieCat.map(r=>r.value), {
        showLegend:false, height:560, hole:0.35, text:catText, textinfo:"text"
      });

      // Cat table
      catTableBodyEl.innerHTML = catRows.filter(r=>r.ValorAtual>0 || r.ValorAnterior>0).map(r=>{
        const pct = totalCat>0 ? r.ValorAtual/totalCat : 0;
        const variacao = r.ValorAtual - r.ValorAnterior;

        let growth = "0.0%";
        if (r.ValorAnterior>0) growth = ((r.ValorAtual-r.ValorAnterior)/r.ValorAnterior*100).toFixed(1) + "%";
        else if (r.ValorAtual>0 && r.ValorAnterior===0) growth = "Novo";

        const growthFmt = (growth==="Novo") ? "Novo" : ( (r.ValorAnterior>0) ? ( (r.ValorAtual-r.ValorAnterior)>=0 ? "+"+growth : growth ) : growth );

        return `
          <tr>
            <td title="${esc(r.Categoria)}">${esc(shorten(r.Categoria, 30))}</td>
            <td>${esc(formatBRL(r.ValorAtual))}</td>
            <td>${esc((pct*100).toFixed(1)+"%")}</td>
            <td>${esc(formatBRLSigned(variacao))}</td>
            <td>${esc(growthFmt)}</td>
          </tr>
        `;
      }).join("");

      // Distribuição por clientes section
      const top1Share = shares.slice(0,1).reduce((a,b)=>a+b,0);
      const top3Share = shares.slice(0,3).reduce((a,b)=>a+b,0);
      const top10Share = shares.slice(0,10).reduce((a,b)=>a+b,0);
      const n80Ratio = clientesAtendidos>0 ? (n80Count/clientesAtendidos) : 0;

      distKpisEl.innerHTML = [
        {label:"N80", value:String(n80Count), delta:`${Math.round(n80Ratio*100)}% da carteira`},
        {label:"Índice de concentração", value:hhiLabelShort, delta:`HHI ${hhi.toFixed(3)}`},
        {label:"Top 1 cliente", value:(top1Share*100).toFixed(1)+"%"},
        {label:"Top 3 clientes", value:(top3Share*100).toFixed(1)+"%"},
        {label:"Top 10 clientes", value:(top10Share*100).toFixed(1)+"%"},
      ].map(o=>`
        <div class="card kpi">
          <div class="label">${esc(o.label)}</div>
          <div class="value">${esc(o.value)}</div>
          <div class="delta">${o.delta ? `<span class="pill neutral">↑ ${esc(o.delta)}</span>` : ""}</div>
        </div>
      `).join("");

      // Clients pie: top10 + Outros (no legend)
      const clientVals = clientAgg.map(r=>({name:r.Cliente, value:r.Valor})).filter(r=>r.value>0);
      clientVals.sort((a,b)=>b.value-a.value);
      let pieClients = clientVals;
      if (pieClients.length > 10){
        const top10 = pieClients.slice(0,10);
        const others = pieClients.slice(10).reduce((acc,r)=>acc+r.value,0);
        top10.push({name:"Outros", value:others});
        pieClients = top10;
      }
      const pieClientsTotal = pieClients.reduce((acc,r)=>acc+r.value,0);

      // Order by value desc already; build inside text only for big slices
      const pieClientLabels = pieClients.map(r=> shorten(r.name, 22));
      const pieClientValues = pieClients.map(r=> r.value);
      const pieClientText = pieClients.map(r=>{
        const share = pieClientsTotal>0 ? r.value/pieClientsTotal : 0;
        if (share >= 0.07){
          return `${shorten(r.name, 18)}<br>${(share*100).toFixed(1)}%`;
        }
        return "";
      });

      plotPie("clientsPie", pieClientLabels.map((lbl,i)=>`${lbl} ${(pieClientsTotal>0?(pieClientValues[i]/pieClientsTotal*100):0).toFixed(1)}%`), pieClientValues, {
        showLegend:false,
        height:560,
        hole:0.0,
        text: pieClientText,
        textinfo:"text"
      });

      // Clients table (top 15 detailed)
      // Build full detailed list: Cliente, Cidade, Estado, Faturamento, % Fat, Volume
      const dfClientFull = [];
      for (const [k, arr] of byClientLoc.entries()){
        const [Cliente, Cidade, Estado] = k.split("||");
        dfClientFull.push({
          Cliente, Cidade, Estado,
          Valor: sum(arr,x=>x.Valor),
          Quantidade: sum(arr,x=>x.Quantidade)
        });
      }
      dfClientFull.sort((a,b)=>b.Valor-a.Valor);

      clientsTableBodyEl.innerHTML = dfClientFull.slice(0,15).map(r=>{
        const share = totalRep>0 ? r.Valor/totalRep : 0;
        return `
          <tr>
            <td title="${esc(r.Cliente)}">${esc(shorten(r.Cliente, 40))}</td>
            <td title="${esc(r.Cidade)}">${esc(shorten(r.Cidade, 20))}</td>
            <td>${esc(r.Estado)}</td>
            <td>${esc(formatBRL(r.Valor))}</td>
            <td>${esc((share*100).toFixed(1)+"%")}</td>
            <td>${esc(formatUN(r.Quantidade))}</td>
          </tr>
        `;
      }).join("");

      // Saúde da carteira – detalhes
      carteiraScoreEl.textContent = `${Math.round(carteiraScore)} / 100`;
      carteiraLabelEl.textContent = carteiraLabel;

      // status distribution + resumo
      const statusG = groupBy(clientesCarteira, r=>String(r[STATUS_COL]||""));
      const statusCounts = [];
      let totalClientesStatus = 0;
      for (const s of STATUS_ORDER){
        const arr = statusG.get(s) || [];
        const qtd = arr.length;
        totalClientesStatus += qtd;
        const fatDelta = arr.reduce((acc,r)=>acc + (Number(r.ValorAtual||0) - Number(r.ValorAnterior||0)), 0);
        statusCounts.push({ Status:s, QtdClientes:qtd, FatDelta:fatDelta });
      }

      // Pie
      const pieStatusLabels = statusCounts.map(r=>r.Status);
      const pieStatusValues = statusCounts.map(r=>r.QtdClientes);
      const pieStatusTotal = pieStatusValues.reduce((a,b)=>a+b,0);
      const pieStatusText = statusCounts.map(r=>{
        const share = pieStatusTotal>0 ? r.QtdClientes/pieStatusTotal : 0;
        return (share>=0.10) ? `${r.Status}<br>${(share*100).toFixed(0)}%` : "";
      });

      // custom colors order: Perdidos red, Caindo orange, Estáveis yellow, Crescendo green, Novos blue
      const statusColorMap = { "Perdidos":"#ef4444", "Caindo":"#f97316", "Estáveis":"#eab308", "Crescendo":"#22c55e", "Novos":"#3b82f6" };
      Plotly.newPlot("statusPie", [{
        type:"pie",
        labels: pieStatusLabels,
        values: pieStatusValues,
        hole: 0.35,
        sort:false,
        text: pieStatusText,
        textinfo:"text",
        textposition:"inside",
        marker:{ colors: pieStatusLabels.map(l=>statusColorMap[l] || "#999") },
        hovertemplate: "%{label}<br>%{percent}<br>%{value}<extra></extra>"
      }], {
        margin:{l:10,r:10,t:10,b:10},
        height:320,
        showlegend:true,
        paper_bgcolor:"rgba(0,0,0,0)",
        plot_bgcolor:"rgba(0,0,0,0)",
        font:{color:"rgba(255,255,255,0.88)", family:"Inter, sans-serif"},
        legend:{font:{color:"rgba(255,255,255,0.75)"}, orientation:"h", y:-0.05}
      }, {displayModeBar:false, responsive:true});

      // Resumo table (ordered)
      statusResumoBodyEl.innerHTML = statusCounts.map(r=>{
        const pct = totalClientesStatus>0 ? r.QtdClientes/totalClientesStatus : 0;
        return `
          <tr>
            <td>${esc(r.Status)}</td>
            <td>${esc(String(r.QtdClientes))}</td>
            <td>${esc((pct*100).toFixed(1)+"%")}</td>
            <td>${esc(formatBRLSigned(r.FatDelta))}</td>
          </tr>
        `;
      }).join("");

      statusObsEl.innerHTML =
        `<b>Obs.:</b> A coluna <b>Faturamento</b> mostra a diferença de faturamento entre o período atual (<b>${esc(currentLabel)}</b>) `+
        `e o período anterior (<b>${esc(prevLabel)}</b>). Valores positivos indicam crescimento; valores negativos indicam queda.`;

      // Status dos clientes (full list, search)
      const search = (searchClienteEl.value || "").trim().toLowerCase();
      const statusBuckets = new Map(STATUS_ORDER.map(s=>[s, []]));
      for (const r of clientesCarteira){
        const s = String(r[STATUS_COL]||"");
        if (!statusBuckets.has(s)) continue;
        if (search && !String(r.Cliente||"").toLowerCase().includes(search)) continue;
        statusBuckets.get(s).push(r);
      }
      // sort each status by ValorAtual desc
      for (const s of STATUS_ORDER){
        statusBuckets.get(s).sort((a,b)=>(Number(b.ValorAtual||0)-Number(a.ValorAtual||0)));
      }

      statusTablesEl.innerHTML = "";
      for (const s of STATUS_ORDER){
        const rows = statusBuckets.get(s);
        if (!rows.length) continue;

        const title = document.createElement("h3");
        title.textContent = s;
        statusTablesEl.appendChild(title);

        const tbl = document.createElement("table");
        tbl.innerHTML = `
          <colgroup class="tbl-status"><col><col><col><col><col><col></colgroup>
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Estado</th>
              <th>Cidade</th>
              <th>Status</th>
              <th>Faturamento ${esc(currentLabel)}</th>
              <th>Faturamento ${esc(prevLabel)}</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td title="${esc(r.Cliente)}">${esc(shorten(r.Cliente, 56))}</td>
                <td>${esc(r.Estado||"")}</td>
                <td title="${esc(r.Cidade||"")}">${esc(shorten(r.Cidade||"", 26))}</td>
                <td>${esc(s)}</td>
                <td>${esc(formatBRL(Number(r.ValorAtual||0)))}</td>
                <td>${esc(formatBRL(Number(r.ValorAnterior||0)))}</td>
              </tr>
            `).join("")}
          </tbody>
        `;
        statusTablesEl.appendChild(tbl);
        const spacer = document.createElement("div");
        spacer.style.height = "10px";
        statusTablesEl.appendChild(spacer);
      }

      // Re-render map if metric changed via radio without hitting Apply
      // (handled by radio change listener too)
    }

    // ==========================
    // INIT UI (month/year options)
    // ==========================
    function initSelectors(){
      startMonthEl.innerHTML = MONTH_NAMES.map(m=>`<option value="${m}">${m}</option>`).join("");
      endMonthEl.innerHTML = MONTH_NAMES.map(m=>`<option value="${m}">${m}</option>`).join("");

      const years = Array.from(new Set(RAW.map(r=>r.Ano))).sort((a,b)=>a-b);
      if (!years.length) throw new Error("Não foi possível identificar anos na base de dados.");

      const lastYear = years[years.length-1];

      startYearEl.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");
      endYearEl.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");

      // default months based on last year available months
      const monthsLastYear = RAW.filter(r=>r.Ano===lastYear).map(r=>r.MesNum);
      const minM = Math.min(...monthsLastYear);
      const maxM = Math.max(...monthsLastYear);

      startMonthEl.value = MONTH_MAP_NUM_TO_NAME[minM] || "JAN";
      endMonthEl.value = MONTH_MAP_NUM_TO_NAME[maxM] || "DEZ";
      startYearEl.value = String(lastYear);
      endYearEl.value = String(lastYear);

      // initial rep options based on default period
      const startComp = compDate(lastYear, minM);
      const endComp = compDate(lastYear, maxM);
      const dfPeriod = RAW.filter(r => r.Competencia >= startComp && r.Competencia <= endComp);
      const reps = Array.from(new Set(dfPeriod.map(r=>String(r.Representante||"")).filter(Boolean))).sort();
      repSelectEl.innerHTML = ["Todos", ...reps].map(r=>`<option value="${esc(r)}">${esc(r)}</option>`).join("");
      repSelectEl.value = "Todos";
    }

    // ==========================
    // Events
    // ==========================
    toggleSidebarBtn.addEventListener("click", ()=>{
      appEl.classList.toggle("sidebar-collapsed");
      // ensure plotly resizes
      setTimeout(()=>{ Plotly.Plots.resize("statesPie"); Plotly.Plots.resize("evoCurrent"); Plotly.Plots.resize("evoPrev"); Plotly.Plots.resize("catPie"); Plotly.Plots.resize("clientsPie"); Plotly.Plots.resize("statusPie"); }, 200);
      setTimeout(()=>{ if (map) map.invalidateSize(); }, 220);
    });

    printBtn.addEventListener("click", ()=> window.print());

    applyBtn.addEventListener("click", ()=>{
      recomputeAndRender();
      // close sidebar after applying (optional)
      appEl.classList.add("sidebar-collapsed");
      setTimeout(()=>{ if (map) map.invalidateSize(); }, 220);
    });

    document.getElementById("mapMetricRadio").addEventListener("change", ()=>{
      // immediate map update without full recompute
      recomputeAndRender();
      setTimeout(()=>{ if (map) map.invalidateSize(); }, 120);
    });

    searchClienteEl.addEventListener("input", ()=>{
      // only re-render status tables quickly (simplest: recompute entire view)
      recomputeAndRender();
    });

    // ==========================
    // BOOT
    // ==========================
    (async function boot(){
      try{
        await loadAllData();
        initSelectors();
        recomputeAndRender();
      }catch(e){
        console.error(e);
        alert(String(e.message || e));
      }
    })();
  </script>
</body>
</html>
